{"version":3,"sources":["../src/server.ts"],"sourcesContent":["import { getContext } from './middleware/context.js';\n\nexport * as unstable_builderConstants from './lib/builder/constants.js';\nexport { emitPlatformData as unstable_emitPlatformData } from './lib/builder/platform-data.js';\n\n// The use of `globalThis` in this file is more or less a hack.\n// It should be revisited with a better solution.\n\n/**\n * This is an internal function and not for public use.\n */\nexport function INTERNAL_setAllEnv(newEnv: Readonly<Record<string, string>>) {\n  (globalThis as any).__WAKU_SERVER_ENV__ = newEnv;\n}\n\nexport function getEnv(key: string): string | undefined {\n  return (globalThis as any).__WAKU_SERVER_ENV__?.[key];\n}\n\n/**\n * This is an internal function and not for public use.\n */\nexport function INTERNAL_iterateSerializablePlatformData(): Iterable<\n  [string, unknown]\n> {\n  const platformData: Record<string, [unknown, boolean]> = ((\n    globalThis as any\n  ).__WAKU_SERVER_PLATFORM_DATA__ ||= {});\n  return Object.entries(platformData).flatMap(([key, [data, serializable]]) =>\n    serializable ? [[key, data]] : [],\n  );\n}\n\n/**\n * This is an internal function and not for public use.\n */\nexport function INTERNAL_setPlatformDataLoader(\n  loader: (key: string) => Promise<unknown>,\n): void {\n  (globalThis as any).__WAKU_SERVER_PLATFORM_DATA_LOADER__ = loader;\n}\n\nexport async function unstable_setPlatformData<T>(\n  key: string,\n  data: T,\n  serializable: boolean,\n): Promise<void> {\n  const platformData: Record<string, [unknown, boolean]> = ((\n    globalThis as any\n  ).__WAKU_SERVER_PLATFORM_DATA__ ||= {});\n  platformData[key] = [data, serializable];\n}\n\nexport async function unstable_getPlatformData<T>(\n  key: string,\n): Promise<T | undefined> {\n  const platformData: Record<string, [unknown, boolean]> = ((\n    globalThis as any\n  ).__WAKU_SERVER_PLATFORM_DATA__ ||= {});\n  const item = platformData[key];\n  if (item) {\n    return item[0] as T;\n  }\n  const loader: ((key: string) => Promise<unknown>) | undefined = (\n    globalThis as any\n  ).__WAKU_SERVER_PLATFORM_DATA_LOADER__;\n  if (loader) {\n    return loader(key) as T;\n  }\n}\n\nexport function unstable_getHeaders(): Readonly<Record<string, string>> {\n  return getContext().req.headers;\n}\n\ntype BuildOptions = {\n  deploy?:\n    | 'vercel-static'\n    | 'vercel-serverless'\n    | 'netlify-static'\n    | 'netlify-functions'\n    | 'cloudflare'\n    | 'partykit'\n    | 'deno'\n    | 'aws-lambda'\n    | 'txiki'\n    | undefined;\n  unstable_phase?:\n    | 'analyzeEntries'\n    | 'buildServerBundle'\n    | 'buildSsrBundle'\n    | 'buildClientBundle'\n    | 'buildDeploy'\n    | 'emitStaticFiles';\n};\n\n// TODO tentative name\nexport function unstable_getBuildOptions(): BuildOptions {\n  return ((globalThis as any).__WAKU_BUILD_OPTIONS__ ||= {});\n}\n\nexport function unstable_createAsyncIterable<T extends () => unknown>(\n  create: () => Promise<Iterable<T>>,\n): AsyncIterable<Awaited<ReturnType<T>>>;\n\nexport function unstable_createAsyncIterable<T extends () => unknown>(\n  create: () => Promise<Iterable<T>>,\n) {\n  return {\n    [Symbol.asyncIterator]: () => {\n      let tasks: T[] | undefined;\n      return {\n        next: async () => {\n          if (!tasks) {\n            tasks = Array.from(await create());\n          }\n          const task = tasks.shift();\n          if (task) {\n            return { value: await task() };\n          }\n          return { done: true, value: undefined };\n        },\n      };\n    },\n  };\n}\n"],"names":["getContext","unstable_builderConstants","emitPlatformData","unstable_emitPlatformData","INTERNAL_setAllEnv","newEnv","globalThis","__WAKU_SERVER_ENV__","getEnv","key","INTERNAL_iterateSerializablePlatformData","platformData","__WAKU_SERVER_PLATFORM_DATA__","Object","entries","flatMap","data","serializable","INTERNAL_setPlatformDataLoader","loader","__WAKU_SERVER_PLATFORM_DATA_LOADER__","unstable_setPlatformData","unstable_getPlatformData","item","unstable_getHeaders","req","headers","unstable_getBuildOptions","__WAKU_BUILD_OPTIONS__","unstable_createAsyncIterable","create","Symbol","asyncIterator","tasks","next","Array","from","task","shift","value","done","undefined"],"mappings":"AAAA,SAASA,UAAU,QAAQ,0BAA0B;AAErD,OAAO,KAAKC,yBAAyB,MAAM,6BAA6B;AACxE,SAASC,oBAAoBC,yBAAyB,QAAQ,iCAAiC;AAE/F,+DAA+D;AAC/D,iDAAiD;AAEjD;;CAEC,GACD,OAAO,SAASC,mBAAmBC,MAAwC;IACxEC,WAAmBC,mBAAmB,GAAGF;AAC5C;AAEA,OAAO,SAASG,OAAOC,GAAW;IAChC,OAAO,AAACH,WAAmBC,mBAAmB,EAAE,CAACE,IAAI;AACvD;AAEA;;CAEC,GACD,OAAO,SAASC;IAGd,MAAMC,eAAoD,AACxDL,WACAM,6BAA6B,KAAK,CAAC;IACrC,OAAOC,OAAOC,OAAO,CAACH,cAAcI,OAAO,CAAC,CAAC,CAACN,KAAK,CAACO,MAAMC,aAAa,CAAC,GACtEA,eAAe;YAAC;gBAACR;gBAAKO;aAAK;SAAC,GAAG,EAAE;AAErC;AAEA;;CAEC,GACD,OAAO,SAASE,+BACdC,MAAyC;IAExCb,WAAmBc,oCAAoC,GAAGD;AAC7D;AAEA,OAAO,eAAeE,yBACpBZ,GAAW,EACXO,IAAO,EACPC,YAAqB;IAErB,MAAMN,eAAoD,AACxDL,WACAM,6BAA6B,KAAK,CAAC;IACrCD,YAAY,CAACF,IAAI,GAAG;QAACO;QAAMC;KAAa;AAC1C;AAEA,OAAO,eAAeK,yBACpBb,GAAW;IAEX,MAAME,eAAoD,AACxDL,WACAM,6BAA6B,KAAK,CAAC;IACrC,MAAMW,OAAOZ,YAAY,CAACF,IAAI;IAC9B,IAAIc,MAAM;QACR,OAAOA,IAAI,CAAC,EAAE;IAChB;IACA,MAAMJ,SAA0D,AAC9Db,WACAc,oCAAoC;IACtC,IAAID,QAAQ;QACV,OAAOA,OAAOV;IAChB;AACF;AAEA,OAAO,SAASe;IACd,OAAOxB,aAAayB,GAAG,CAACC,OAAO;AACjC;AAuBA,sBAAsB;AACtB,OAAO,SAASC;IACd,OAAQ,AAACrB,WAAmBsB,sBAAsB,KAAK,CAAC;AAC1D;AAMA,OAAO,SAASC,6BACdC,MAAkC;IAElC,OAAO;QACL,CAACC,OAAOC,aAAa,CAAC,EAAE;YACtB,IAAIC;YACJ,OAAO;gBACLC,MAAM;oBACJ,IAAI,CAACD,OAAO;wBACVA,QAAQE,MAAMC,IAAI,CAAC,MAAMN;oBAC3B;oBACA,MAAMO,OAAOJ,MAAMK,KAAK;oBACxB,IAAID,MAAM;wBACR,OAAO;4BAAEE,OAAO,MAAMF;wBAAO;oBAC/B;oBACA,OAAO;wBAAEG,MAAM;wBAAMD,OAAOE;oBAAU;gBACxC;YACF;QACF;IACF;AACF"}