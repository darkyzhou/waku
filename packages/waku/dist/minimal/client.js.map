{"version":3,"sources":["../../src/minimal/client.ts"],"sourcesContent":["/// <reference types=\"react/canary\" />\n'use client';\n\nimport {\n  createContext,\n  createElement,\n  memo,\n  use,\n  useCallback,\n  useEffect,\n  useState,\n  Component,\n} from 'react';\nimport type { ReactNode } from 'react';\nimport RSDWClient from 'react-server-dom-webpack/client';\n\nimport { createCustomError } from '../lib/utils/custom-errors.js';\nimport { encodeRscPath, encodeFuncId } from '../lib/renderers/utils.js';\n\nconst { createFromFetch, encodeReply } = RSDWClient;\n\ndeclare global {\n  interface ImportMeta {\n    readonly env: Record<string, string>;\n  }\n}\n\nconst DEFAULT_HTML_HEAD = [\n  createElement('meta', { charSet: 'utf-8' }),\n  createElement('meta', {\n    name: 'viewport',\n    content: 'width=device-width, initial-scale=1',\n  }),\n  createElement('meta', { name: 'generator', content: 'Waku' }),\n];\n\nconst BASE_RSC_PATH = `${import.meta.env?.WAKU_CONFIG_BASE_PATH}${\n  import.meta.env?.WAKU_CONFIG_RSC_BASE\n}/`;\n\nconst checkStatus = async (\n  responsePromise: Promise<Response>,\n): Promise<Response> => {\n  const response = await responsePromise;\n  if (!response.ok) {\n    const location = response.headers.get('location');\n    const err = createCustomError(\n      (await response.text()) || response.statusText,\n      {\n        status: response.status,\n        ...(location && { location }),\n      },\n    );\n    throw err;\n  }\n  return response;\n};\n\ntype Elements = Record<string, unknown>;\n\n// HACK I'm not super happy with this hack\nconst erroredElementsPromiseMap = new WeakMap<\n  Promise<Elements>,\n  Promise<Elements>\n>();\n\nconst getCached = <T>(c: () => T, m: WeakMap<object, T>, k: object): T =>\n  (m.has(k) ? m : m.set(k, c())).get(k) as T;\nconst cache1 = new WeakMap();\nconst mergeElementsPromise = (\n  a: Promise<Elements>,\n  b: Promise<Elements>,\n): Promise<Elements> => {\n  const getResult = () => {\n    const p = Promise.all([erroredElementsPromiseMap.get(a) || a, b])\n      .then(([a, b]) => {\n        const nextElements = { ...a, ...b };\n        delete nextElements._value;\n        return nextElements;\n      })\n      .catch((err) => {\n        erroredElementsPromiseMap.set(p, a);\n        throw err;\n      });\n    return p;\n  };\n  const cache2 = getCached(() => new WeakMap(), cache1, a);\n  return getCached(getResult, cache2, b);\n};\n\ntype SetElements = (\n  updater: (prev: Promise<Elements>) => Promise<Elements>,\n) => void;\ntype EnhanceFetch = (fetchFn: typeof fetch) => typeof fetch;\ntype EnhanceCreateData = (\n  createData: (responsePromise: Promise<Response>) => Promise<Elements>,\n) => (responsePromise: Promise<Response>) => Promise<Elements>;\n\nconst ENTRY = 'e';\nconst SET_ELEMENTS = 's';\nconst ENHANCE_FETCH = 'f';\nconst ENHANCE_CREATE_DATA = 'd';\n\ntype FetchCache = {\n  [ENTRY]?: [\n    rscPath: string,\n    rscParams: unknown,\n    elementsPromise: Promise<Elements>,\n  ];\n  [SET_ELEMENTS]?: SetElements;\n  [ENHANCE_FETCH]?: EnhanceFetch | undefined;\n  [ENHANCE_CREATE_DATA]?: EnhanceCreateData | undefined;\n};\n\nconst defaultFetchCache: FetchCache = {};\n\n/**\n * callServer callback\n * This is not a public API.\n */\nexport const unstable_callServerRsc = async (\n  funcId: string,\n  args: unknown[],\n  fetchCache = defaultFetchCache,\n) => {\n  const enhanceFetch = fetchCache[ENHANCE_FETCH] || ((f) => f);\n  const enhanceCreateData = fetchCache[ENHANCE_CREATE_DATA] || ((d) => d);\n  const createData = (responsePromise: Promise<Response>) =>\n    createFromFetch<Elements>(checkStatus(responsePromise), {\n      callServer: (funcId: string, args: unknown[]) =>\n        unstable_callServerRsc(funcId, args, fetchCache),\n    });\n  const url = BASE_RSC_PATH + encodeRscPath(encodeFuncId(funcId));\n  const responsePromise =\n    args.length === 1 && args[0] instanceof URLSearchParams\n      ? enhanceFetch(fetch)(url + '?' + args[0])\n      : encodeReply(args).then((body) =>\n          enhanceFetch(fetch)(url, { method: 'POST', body }),\n        );\n  const data = enhanceCreateData(createData)(responsePromise);\n  const value = (await data)._value;\n  // FIXME this causes rerenders even if data is empty\n  fetchCache[SET_ELEMENTS]?.((prev) => mergeElementsPromise(prev, data));\n  return value;\n};\n\nconst prefetchedParams = new WeakMap<Promise<unknown>, unknown>();\n\nconst fetchRscInternal = (\n  url: string,\n  rscParams: unknown,\n  fetchCache: FetchCache,\n) => {\n  const enhanceFetch = fetchCache[ENHANCE_FETCH] || ((f) => f);\n  return rscParams === undefined\n    ? enhanceFetch(fetch)(url)\n    : rscParams instanceof URLSearchParams\n      ? enhanceFetch(fetch)(url + '?' + rscParams)\n      : encodeReply(rscParams).then((body) =>\n          enhanceFetch(fetch)(url, { method: 'POST', body }),\n        );\n};\n\nexport const fetchRsc = (\n  rscPath: string,\n  rscParams?: unknown,\n  fetchCache = defaultFetchCache,\n): Promise<Elements> => {\n  const entry = fetchCache[ENTRY];\n  if (entry && entry[0] === rscPath && entry[1] === rscParams) {\n    return entry[2];\n  }\n  const enhanceCreateData = fetchCache[ENHANCE_CREATE_DATA] || ((d) => d);\n  const createData = (responsePromise: Promise<Response>) =>\n    createFromFetch<Elements>(checkStatus(responsePromise), {\n      callServer: (funcId: string, args: unknown[]) =>\n        unstable_callServerRsc(funcId, args, fetchCache),\n    });\n  const prefetched = ((globalThis as any).__WAKU_PREFETCHED__ ||= {});\n  const url = BASE_RSC_PATH + encodeRscPath(rscPath);\n  const hasValidPrefetchedResponse =\n    !!prefetched[url] &&\n    // HACK .has() is for the initial hydration\n    // It's limited and may result in a wrong result. FIXME\n    (!prefetchedParams.has(prefetched[url]) ||\n      prefetchedParams.get(prefetched[url]) === rscParams);\n  const responsePromise = hasValidPrefetchedResponse\n    ? prefetched[url]\n    : fetchRscInternal(url, rscParams, fetchCache);\n  delete prefetched[url];\n  const data = enhanceCreateData(createData)(responsePromise);\n  fetchCache[ENTRY] = [rscPath, rscParams, data];\n  return data;\n};\n\nexport const prefetchRsc = (\n  rscPath: string,\n  rscParams?: unknown,\n  fetchCache = defaultFetchCache,\n): void => {\n  const prefetched = ((globalThis as any).__WAKU_PREFETCHED__ ||= {});\n  const url = BASE_RSC_PATH + encodeRscPath(rscPath);\n  if (!(url in prefetched)) {\n    prefetched[url] = fetchRscInternal(url, rscParams, fetchCache);\n    prefetchedParams.set(prefetched[url], rscParams);\n  }\n};\n\nconst RefetchContext = createContext<\n  (rscPath: string, rscParams?: unknown) => void\n>(() => {\n  throw new Error('Missing Root component');\n});\nconst ElementsContext = createContext<Promise<Elements> | null>(null);\n\nexport const Root = ({\n  initialRscPath,\n  initialRscParams,\n  fetchCache = defaultFetchCache,\n  unstable_enhanceFetch,\n  unstable_enhanceCreateData,\n  children,\n}: {\n  initialRscPath?: string;\n  initialRscParams?: unknown;\n  fetchCache?: FetchCache;\n  unstable_enhanceFetch?: EnhanceFetch;\n  unstable_enhanceCreateData?: EnhanceCreateData;\n  children: ReactNode;\n}) => {\n  fetchCache[ENHANCE_FETCH] = unstable_enhanceFetch;\n  fetchCache[ENHANCE_CREATE_DATA] = unstable_enhanceCreateData;\n  const [elements, setElements] = useState(() =>\n    fetchRsc(initialRscPath || '', initialRscParams, fetchCache),\n  );\n  useEffect(() => {\n    fetchCache[SET_ELEMENTS] = setElements;\n  }, [fetchCache]);\n  const refetch = useCallback(\n    (rscPath: string, rscParams?: unknown) => {\n      // clear cache entry before fetching\n      delete fetchCache[ENTRY];\n      const data = fetchRsc(rscPath, rscParams, fetchCache);\n      setElements((prev) => mergeElementsPromise(prev, data));\n    },\n    [fetchCache],\n  );\n  return createElement(\n    RefetchContext.Provider,\n    { value: refetch },\n    createElement(\n      ElementsContext.Provider,\n      { value: elements },\n      ...DEFAULT_HTML_HEAD,\n      children,\n    ),\n  );\n};\n\nexport const useRefetch = () => use(RefetchContext);\n\nconst ChildrenContext = createContext<ReactNode>(undefined);\nconst ChildrenContextProvider = memo(ChildrenContext.Provider);\nconst ErrorContext = createContext<\n  [error: unknown, reset: () => void] | undefined\n>(undefined);\nconst ErrorContextProvider = memo(ErrorContext.Provider);\n\nexport const Children = () => use(ChildrenContext);\n\nexport const ThrowError_UNSTABLE = () => {\n  const errAndReset = use(ErrorContext);\n  if (errAndReset) {\n    throw errAndReset[0];\n  }\n  return null;\n};\n\nexport const useResetError_UNSTABLE = () => {\n  const errAndReset = use(ErrorContext);\n  if (errAndReset) {\n    return errAndReset[1];\n  }\n};\n\nexport const useElement = (id: string) => {\n  const elementsPromise = use(ElementsContext);\n  if (!elementsPromise) {\n    throw new Error('Missing Root component');\n  }\n  const elements = use(elementsPromise);\n  if (id in elements && elements[id] == undefined) {\n    throw new Error('Element cannot be undefined, use null instead: ' + id);\n  }\n  return elements[id];\n};\n\nconst InnerSlot = ({\n  id,\n  children,\n  setValidElement,\n  unstable_fallback,\n}: {\n  id: string;\n  children?: ReactNode;\n  setValidElement?: (element: ReactNode) => void;\n  unstable_fallback?: ReactNode;\n}) => {\n  const element = useElement(id);\n  const isValidElement = element !== undefined;\n  useEffect(() => {\n    if (isValidElement && setValidElement) {\n      // FIXME is there `isReactNode` type checker?\n      setValidElement(element as ReactNode);\n    }\n  }, [isValidElement, element, setValidElement]);\n  if (!isValidElement) {\n    if (unstable_fallback) {\n      return unstable_fallback;\n    }\n    throw new Error('Invalid element: ' + id);\n  }\n  return createElement(\n    ChildrenContextProvider,\n    { value: children },\n    // FIXME is there `isReactNode` type checker?\n    element as ReactNode,\n  );\n};\n\nclass GeneralErrorHandler extends Component<\n  { children?: ReactNode; errorHandler: ReactNode },\n  { error: unknown | null }\n> {\n  constructor(props: { children?: ReactNode; errorHandler: ReactNode }) {\n    super(props);\n    this.state = { error: null };\n    this.reset = this.reset.bind(this);\n  }\n  static getDerivedStateFromError(error: unknown) {\n    return { error };\n  }\n  reset() {\n    this.setState({ error: null });\n  }\n  render() {\n    const { error } = this.state;\n    if (error !== null) {\n      if (this.props.errorHandler) {\n        return createElement(\n          ErrorContextProvider,\n          { value: [error, this.reset] },\n          this.props.errorHandler,\n        );\n      }\n      throw error;\n    }\n    return this.props.children;\n  }\n}\n\n/**\n * Slot component\n * This is used under the Root component.\n * Slot id is the key of elements returned by the server.\n *\n * If the server returns this\n * ```\n *   { 'foo': <div>foo</div>, 'bar': <div>bar</div> }\n * ```\n * then you can use this component like this\n * ```\n *   <Root><Slot id=\"foo\" /><Slot id=\"bar\" /></Root>\n * ```\n */\nexport const Slot = ({\n  id,\n  children,\n  unstable_handleError,\n  unstable_fallback,\n}: {\n  id: string;\n  children?: ReactNode;\n  unstable_handleError?: ReactNode;\n  unstable_fallback?: ReactNode;\n}) => {\n  const [errorHandler, setErrorHandler] = useState<ReactNode>();\n  const setValidElement = useCallback(\n    (element: ReactNode) =>\n      setErrorHandler(\n        createElement(\n          ChildrenContextProvider,\n          { value: unstable_handleError },\n          element,\n        ),\n      ),\n    [unstable_handleError],\n  );\n  if (unstable_handleError !== undefined) {\n    return createElement(\n      GeneralErrorHandler,\n      { errorHandler },\n      createElement(InnerSlot, { id, setValidElement }, children),\n    );\n  }\n  return createElement(InnerSlot, { id, unstable_fallback }, children);\n};\n\n/**\n * ServerRoot for SSR\n * This is not a public API.\n */\nexport const INTERNAL_ServerRoot = ({\n  elementsPromise,\n  children,\n}: {\n  elementsPromise: Promise<Elements>;\n  children: ReactNode;\n}) =>\n  createElement(\n    ElementsContext.Provider,\n    { value: elementsPromise },\n    ...DEFAULT_HTML_HEAD,\n    children,\n  );\n"],"names":["createContext","createElement","memo","use","useCallback","useEffect","useState","Component","RSDWClient","createCustomError","encodeRscPath","encodeFuncId","createFromFetch","encodeReply","DEFAULT_HTML_HEAD","charSet","name","content","BASE_RSC_PATH","env","WAKU_CONFIG_BASE_PATH","WAKU_CONFIG_RSC_BASE","checkStatus","responsePromise","response","ok","location","headers","get","err","text","statusText","status","erroredElementsPromiseMap","WeakMap","getCached","c","m","k","has","set","cache1","mergeElementsPromise","a","b","getResult","p","Promise","all","then","nextElements","_value","catch","cache2","ENTRY","SET_ELEMENTS","ENHANCE_FETCH","ENHANCE_CREATE_DATA","defaultFetchCache","unstable_callServerRsc","funcId","args","fetchCache","enhanceFetch","f","enhanceCreateData","d","createData","callServer","url","length","URLSearchParams","fetch","body","method","data","value","prev","prefetchedParams","fetchRscInternal","rscParams","undefined","fetchRsc","rscPath","entry","prefetched","globalThis","__WAKU_PREFETCHED__","hasValidPrefetchedResponse","prefetchRsc","RefetchContext","Error","ElementsContext","Root","initialRscPath","initialRscParams","unstable_enhanceFetch","unstable_enhanceCreateData","children","elements","setElements","refetch","Provider","useRefetch","ChildrenContext","ChildrenContextProvider","ErrorContext","ErrorContextProvider","Children","ThrowError_UNSTABLE","errAndReset","useResetError_UNSTABLE","useElement","id","elementsPromise","InnerSlot","setValidElement","unstable_fallback","element","isValidElement","GeneralErrorHandler","constructor","props","state","error","reset","bind","getDerivedStateFromError","setState","render","errorHandler","Slot","unstable_handleError","setErrorHandler","INTERNAL_ServerRoot"],"mappings":"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"}