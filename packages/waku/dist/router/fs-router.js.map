{"version":3,"sources":["../../src/router/fs-router.ts"],"sourcesContent":["import {\n  unstable_getPlatformData,\n  unstable_setPlatformData,\n  unstable_getBuildOptions,\n} from '../server.js';\nimport { createPages, METHODS } from './create-pages.js';\nimport type { Method } from './create-pages.js';\n\nimport { EXTENSIONS } from '../lib/builder/constants.js';\nimport { isIgnoredPath } from '../lib/utils/fs-router.js';\n\nconst DO_NOT_BUNDLE = '';\n\nexport function unstable_fsRouter(\n  importMetaUrl: string,\n  loadPage: (file: string) => Promise<any> | undefined,\n  options: {\n    /** e.g. `\"pages\"` will detect pages in `src/pages`. */\n    pagesDir: string;\n    /**\n     * e.g. `\"api\"` will detect pages in `src/pages/api`. Or, if `options.pagesDir`\n     * is `\"foo\"`, then it will detect pages in `src/foo/api`.\n     */\n    apiDir: string;\n  },\n) {\n  const buildOptions = unstable_getBuildOptions();\n  return createPages(\n    async ({\n      createPage,\n      createLayout,\n      createRoot,\n      createApi,\n      createPagePart,\n    }) => {\n      let files = await unstable_getPlatformData<string[]>('fsRouterFiles');\n      if (!files) {\n        // dev and build only\n        if (\n          import.meta.env &&\n          import.meta.env.MODE === 'production' &&\n          !buildOptions.unstable_phase\n        ) {\n          throw new Error('files must be set in production.');\n        }\n        const [\n          { readdir },\n          { join, dirname, extname, sep },\n          { fileURLToPath },\n        ] = await Promise.all([\n          import(/* @vite-ignore */ DO_NOT_BUNDLE + 'node:fs/promises'),\n          import(/* @vite-ignore */ DO_NOT_BUNDLE + 'node:path'),\n          import(/* @vite-ignore */ DO_NOT_BUNDLE + 'node:url'),\n        ]);\n        const pagesDir = join(\n          dirname(fileURLToPath(importMetaUrl)),\n          options.pagesDir,\n        );\n        files = await readdir(pagesDir, {\n          encoding: 'utf8',\n          recursive: true,\n        });\n        files = files!.flatMap((file) => {\n          const myExt = extname(file);\n          const myExtIndex = EXTENSIONS.indexOf(myExt);\n          if (myExtIndex === -1) {\n            return [];\n          }\n          // HACK: replace \"_slug_\" to \"[slug]\" for build\n          file = file.replace(/(?<=^|\\/|\\\\)_([^/]+)_(?=\\/|\\\\|\\.)/g, '[$1]');\n          // For Windows\n          file = sep === '/' ? file : file.replace(/\\\\/g, '/');\n          // HACK: resolve different extensions for build\n          const exts = [myExt, ...EXTENSIONS];\n          exts.splice(myExtIndex + 1, 1); // remove the second myExt\n          for (const ext of exts) {\n            const f = file.slice(0, -myExt.length) + ext;\n            if (loadPage(f)) {\n              return [f];\n            }\n          }\n          throw new Error('Failed to resolve ' + file);\n        });\n      }\n      // build only - skip in dev\n      if (buildOptions.unstable_phase) {\n        await unstable_setPlatformData('fsRouterFiles', files, true);\n      }\n      for (const file of files) {\n        const mod = await loadPage(file);\n        const config = await mod.getConfig?.();\n        const pathItems = file\n          .replace(/\\.\\w+$/, '')\n          .split('/')\n          .filter(Boolean);\n        if (isIgnoredPath(pathItems)) {\n          continue;\n        }\n        const path =\n          '/' +\n          (['_layout', 'index', '_root'].includes(pathItems.at(-1)!) ||\n          pathItems.at(-1)?.startsWith('_part')\n            ? pathItems.slice(0, -1)\n            : pathItems\n          ).join('/');\n        if (pathItems.at(-1) === '[path]') {\n          throw new Error(\n            'Page file cannot be named [path]. This will conflict with the path prop of the page component.',\n          );\n        } else if (pathItems.at(0) === options.apiDir) {\n          if (config?.render === 'static') {\n            if (Object.keys(mod).length !== 2 || !mod.GET) {\n              console.warn(\n                `API ${path} is invalid. For static API routes, only a single GET handler is supported.`,\n              );\n            }\n            createApi({\n              path: pathItems.join('/'),\n              render: 'static',\n              method: 'GET',\n              handler: mod.GET,\n            });\n          } else {\n            const validMethods = new Set(METHODS);\n            const handlers = Object.fromEntries(\n              Object.entries(mod).flatMap(([exportName, handler]) => {\n                const isValidExport =\n                  exportName === 'getConfig' ||\n                  exportName === 'default' ||\n                  validMethods.has(exportName as Method);\n                if (!isValidExport) {\n                  console.warn(\n                    `API ${path} has an invalid export: ${exportName}. Valid exports are: ${METHODS.join(\n                      ', ',\n                    )}`,\n                  );\n                }\n                return isValidExport && exportName !== 'getConfig'\n                  ? exportName === 'default'\n                    ? [['all', handler]]\n                    : [[exportName, handler]]\n                  : [];\n              }),\n            );\n            createApi({\n              path: pathItems.join('/'),\n              render: 'dynamic',\n              handlers,\n            });\n          }\n        } else if (pathItems.at(-1) === '_layout') {\n          createLayout({\n            path,\n            component: mod.default,\n            render: 'static',\n            ...config,\n          });\n        } else if (pathItems.at(-1) === '_root') {\n          createRoot({\n            component: mod.default,\n            render: 'static',\n            ...config,\n          });\n        } else if (pathItems.at(-1)?.startsWith('_part')) {\n          const order = parseInt(\n            pathItems.at(-1)!.split('-')[0]!.slice('_part'.length),\n          );\n          if (Number.isNaN(order)) {\n            throw new Error(\n              'Invalid page part order: ' +\n                pathItems.at(-1)! +\n                '. Please use the following convention: _part[order]-component.tsx',\n            );\n          }\n          createPagePart({\n            path,\n            component: mod.default,\n            render: 'dynamic',\n            order,\n            ...config,\n          });\n        } else {\n          createPage({\n            path,\n            component: mod.default,\n            render: 'dynamic',\n            ...config,\n          });\n        }\n      }\n      // HACK: to satisfy the return type, unused at runtime\n      return null as never;\n    },\n  );\n}\n"],"names":["unstable_getPlatformData","unstable_setPlatformData","unstable_getBuildOptions","createPages","METHODS","EXTENSIONS","isIgnoredPath","DO_NOT_BUNDLE","unstable_fsRouter","importMetaUrl","loadPage","options","buildOptions","createPage","createLayout","createRoot","createApi","createPagePart","files","env","MODE","unstable_phase","Error","readdir","join","dirname","extname","sep","fileURLToPath","Promise","all","pagesDir","encoding","recursive","flatMap","file","myExt","myExtIndex","indexOf","replace","exts","splice","ext","f","slice","length","mod","config","getConfig","pathItems","split","filter","Boolean","path","includes","at","startsWith","apiDir","render","Object","keys","GET","console","warn","method","handler","validMethods","Set","handlers","fromEntries","entries","exportName","isValidExport","has","component","default","order","parseInt","Number","isNaN"],"mappings":"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"}