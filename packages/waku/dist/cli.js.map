{"version":3,"sources":["../src/cli.ts"],"sourcesContent":["import path from 'node:path';\nimport { existsSync, readFileSync } from 'node:fs';\nimport { pathToFileURL } from 'node:url';\nimport { parseArgs } from 'node:util';\nimport { createRequire } from 'node:module';\nimport { Hono } from 'hono';\nimport { compress } from 'hono/compress';\nimport { serve } from '@hono/node-server';\nimport { serveStatic } from '@hono/node-server/serve-static';\nimport * as dotenv from 'dotenv';\n\nimport type { Config } from './config.js';\nimport { serverEngine } from './lib/hono/engine.js';\nimport { build } from './lib/builder/build.js';\nimport { DIST_ENTRIES_JS, DIST_PUBLIC } from './lib/builder/constants.js';\n\nconst require = createRequire(new URL('.', import.meta.url));\n\ndotenv.config({ path: ['.env.local', '.env'] });\n\nconst CONFIG_FILE = 'waku.config.ts'; // XXX only ts extension\n\nconst { values, positionals } = parseArgs({\n  args: process.argv.slice(2),\n  allowPositionals: true,\n  options: {\n    'with-vercel': {\n      type: 'boolean',\n    },\n    'with-vercel-static': {\n      type: 'boolean',\n    },\n    'with-netlify': {\n      type: 'boolean',\n    },\n    'with-netlify-static': {\n      type: 'boolean',\n    },\n    'with-cloudflare': {\n      type: 'boolean',\n    },\n    'with-partykit': {\n      type: 'boolean',\n    },\n    'with-deno': {\n      type: 'boolean',\n    },\n    'with-aws-lambda': {\n      type: 'boolean',\n    },\n    'with-txiki': {\n      type: 'boolean',\n    },\n    'experimental-partial': {\n      type: 'boolean',\n    },\n    'experimental-compress': {\n      type: 'boolean',\n    },\n    port: {\n      type: 'string',\n      short: 'p',\n    },\n    version: {\n      type: 'boolean',\n      short: 'v',\n    },\n    help: {\n      type: 'boolean',\n      short: 'h',\n    },\n  },\n});\n\nconst cmd = positionals[0];\n\nif (values.version) {\n  const { version } = require('../package.json');\n  console.log(version);\n} else if (values.help) {\n  displayUsage();\n} else {\n  switch (cmd) {\n    case 'dev':\n      await runDev();\n      break;\n    case 'build':\n      await runBuild();\n      break;\n    case 'start':\n      await runStart();\n      break;\n    default:\n      if (cmd) {\n        console.error('Unknown command:', cmd);\n      }\n      displayUsage();\n      break;\n  }\n}\n\nasync function runDev() {\n  const config = await loadConfig();\n  const honoEnhancer =\n    config.unstable_honoEnhancer || ((createApp) => createApp);\n  const createApp = (app: Hono) => {\n    if (values['experimental-compress']) {\n      app.use(compress());\n    }\n    app.use(\n      serverEngine({\n        cmd: 'dev',\n        config,\n        env: process.env as any,\n        unstable_onError: new Set(),\n      }),\n    );\n    app.notFound((c) => {\n      // FIXME can we avoid hardcoding the public path?\n      const file = path.join('public', '404.html');\n      if (existsSync(file)) {\n        return c.html(readFileSync(file, 'utf8'), 404);\n      }\n      return c.text('404 Not Found', 404);\n    });\n    return app;\n  };\n  const port = parseInt(values.port || '3000', 10);\n  await startServer(honoEnhancer(createApp)(new Hono()), port);\n}\n\nasync function runBuild() {\n  const config = await loadConfig();\n  process.env.NODE_ENV = 'production';\n  await build({\n    config,\n    env: process.env as any,\n    partial: !!values['experimental-partial'],\n    deploy:\n      ((values['with-vercel'] ?? !!process.env.VERCEL)\n        ? values['with-vercel-static']\n          ? 'vercel-static'\n          : 'vercel-serverless'\n        : undefined) ||\n      ((values['with-netlify'] ?? !!process.env.NETLIFY)\n        ? values['with-netlify-static']\n          ? 'netlify-static'\n          : 'netlify-functions'\n        : undefined) ||\n      (values['with-cloudflare'] ? 'cloudflare' : undefined) ||\n      (values['with-partykit'] ? 'partykit' : undefined) ||\n      (values['with-deno'] ? 'deno' : undefined) ||\n      (values['with-aws-lambda'] ? 'aws-lambda' : undefined) ||\n      (values['with-txiki'] ? 'txiki' : undefined),\n  });\n}\n\nasync function runStart() {\n  const config = await loadConfig();\n  const { distDir = 'dist' } = config;\n  const honoEnhancer =\n    config.unstable_honoEnhancer || ((createApp) => createApp);\n  const loadEntries = () =>\n    import(pathToFileURL(path.resolve(distDir, DIST_ENTRIES_JS)).toString());\n  const createApp = (app: Hono) => {\n    if (values['experimental-compress']) {\n      app.use(compress());\n    }\n    app.use(serveStatic({ root: path.join(distDir, DIST_PUBLIC) }));\n    app.use(\n      serverEngine({\n        cmd: 'start',\n        loadEntries,\n        env: process.env as any,\n        unstable_onError: new Set(),\n      }),\n    );\n    app.notFound((c) => {\n      // FIXME better implementation using node stream?\n      const file = path.join(distDir, DIST_PUBLIC, '404.html');\n      if (existsSync(file)) {\n        return c.html(readFileSync(file, 'utf8'), 404);\n      }\n      return c.text('404 Not Found', 404);\n    });\n    return app;\n  };\n  const port = parseInt(values.port || '8080', 10);\n  await startServer(honoEnhancer(createApp)(new Hono()), port);\n}\n\nfunction startServer(app: Hono, port: number) {\n  return new Promise<void>((resolve, reject) => {\n    const server = serve({ ...app, port }, () => {\n      console.log(`ready: Listening on http://localhost:${port}/`);\n      resolve();\n    });\n    server.on('error', (err: NodeJS.ErrnoException) => {\n      if (err.code === 'EADDRINUSE') {\n        console.log(\n          `warn: Port ${port} is in use, trying ${port + 1} instead.`,\n        );\n        startServer(app, port + 1)\n          .then(resolve)\n          .catch(reject);\n      } else {\n        console.error(`Failed to start server: ${err.message}`);\n      }\n    });\n  });\n}\n\nfunction displayUsage() {\n  console.log(`\nUsage: waku [options] <command>\n\nCommands:\n  dev         Start the development server\n  build       Build the application for production\n  start       Start the production server\n\nOptions:\n  --with-vercel         Output for Vercel on build\n  --with-netlify        Output for Netlify on build\n  --with-cloudflare     Output for Cloudflare on build\n  --with-partykit       Output for PartyKit on build\n  --with-deno           Output for Deno on build\n  --with-aws-lambda     Output for AWS Lambda on build\n  --with-txiki          Output for Txiki.js on build\n  -p, --port            Port number for the server\n  -v, --version         Display the version number\n  -h, --help            Display this help message\n`);\n}\n\nasync function loadConfig(): Promise<Config> {\n  if (!existsSync(CONFIG_FILE)) {\n    return {};\n  }\n  const { loadServerModule } = await import('./lib/utils/vite-loader.js');\n  const file = pathToFileURL(path.resolve(CONFIG_FILE)).toString();\n  return (await loadServerModule<{ default: Config }>(file)).default;\n}\n"],"names":["path","existsSync","readFileSync","pathToFileURL","parseArgs","createRequire","Hono","compress","serve","serveStatic","dotenv","serverEngine","build","DIST_ENTRIES_JS","DIST_PUBLIC","require","URL","url","config","CONFIG_FILE","values","positionals","args","process","argv","slice","allowPositionals","options","type","port","short","version","help","cmd","console","log","displayUsage","runDev","runBuild","runStart","error","loadConfig","honoEnhancer","unstable_honoEnhancer","createApp","app","use","env","unstable_onError","Set","notFound","c","file","join","html","text","parseInt","startServer","NODE_ENV","partial","deploy","VERCEL","undefined","NETLIFY","distDir","loadEntries","resolve","toString","root","Promise","reject","server","on","err","code","then","catch","message","loadServerModule","default"],"mappings":"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"}