{"version":3,"sources":["../../../src/lib/hono/engine.ts"],"sourcesContent":["import type { MiddlewareHandler } from 'hono';\n\nimport type { ConfigDev } from '../config.js';\nimport { resolveConfigDev } from '../config.js';\nimport type {\n  HandlerContext,\n  Middleware,\n  MiddlewareOptions,\n} from '../middleware/types.js';\n\n// Internal context key\nconst HONO_CONTEXT = '__hono_context';\n\n// serverEngine returns hono middleware that runs Waku middleware.\nexport const serverEngine = (options: MiddlewareOptions): MiddlewareHandler => {\n  const middlewarePromise: Promise<{ default: Middleware }[]> =\n    options.cmd === 'start'\n      ? options.loadEntries().then((entries) => entries.loadMiddleware())\n      : resolveConfigDev(options.config).then((config) =>\n          loadMiddlewareDev(config),\n        );\n  const handlersPromise = middlewarePromise.then((middlewareList) =>\n    middlewareList.map((middleware) => middleware.default(options)),\n  );\n  return async (c, next) => {\n    const ctx: HandlerContext = {\n      req: {\n        body: c.req.raw.body,\n        url: new URL(c.req.url),\n        method: c.req.method,\n        headers: c.req.header(),\n      },\n      res: {},\n      data: {\n        [HONO_CONTEXT]: c,\n      },\n    };\n    const handlers = await handlersPromise;\n    const run = async (index: number) => {\n      if (index >= handlers.length) {\n        return;\n      }\n      let alreadyCalled = false;\n      await handlers[index]!(ctx, async () => {\n        if (!alreadyCalled) {\n          alreadyCalled = true;\n          await run(index + 1);\n        }\n      });\n    };\n    await run(0);\n    if (ctx.res.body || ctx.res.status) {\n      const status = ctx.res.status || 200;\n      const headers = ctx.res.headers || {};\n      if (ctx.res.body) {\n        return c.body(ctx.res.body, status as never, headers);\n      }\n      return c.body(null, status as never, headers);\n    }\n    await next();\n  };\n};\n\nconst DO_NOT_BUNDLE = '';\n\nasync function loadMiddlewareDev(\n  configDev: ConfigDev,\n): Promise<{ default: Middleware }[]> {\n  const [{ resolve }, { pathToFileURL }, { loadServerModule }] =\n    await Promise.all([\n      import(/* @vite-ignore */ DO_NOT_BUNDLE + 'node:path'),\n      import(/* @vite-ignore */ DO_NOT_BUNDLE + 'node:url'),\n      import(/* @vite-ignore */ DO_NOT_BUNDLE + '../utils/vite-loader.js'),\n    ]);\n  return Promise.all(\n    configDev.middleware.map(async (file) => {\n      const idOrFileURL = file.startsWith('./')\n        ? pathToFileURL(resolve(file)).toString()\n        : file;\n      return loadServerModule(idOrFileURL);\n    }),\n  );\n}\n"],"names":["resolveConfigDev","HONO_CONTEXT","serverEngine","options","middlewarePromise","cmd","loadEntries","then","entries","loadMiddleware","config","loadMiddlewareDev","handlersPromise","middlewareList","map","middleware","default","c","next","ctx","req","body","raw","url","URL","method","headers","header","res","data","handlers","run","index","length","alreadyCalled","status","DO_NOT_BUNDLE","configDev","resolve","pathToFileURL","loadServerModule","Promise","all","file","idOrFileURL","startsWith","toString"],"mappings":"AAGA,SAASA,gBAAgB,QAAQ,eAAe;AAOhD,uBAAuB;AACvB,MAAMC,eAAe;AAErB,kEAAkE;AAClE,OAAO,MAAMC,eAAe,CAACC;IAC3B,MAAMC,oBACJD,QAAQE,GAAG,KAAK,UACZF,QAAQG,WAAW,GAAGC,IAAI,CAAC,CAACC,UAAYA,QAAQC,cAAc,MAC9DT,iBAAiBG,QAAQO,MAAM,EAAEH,IAAI,CAAC,CAACG,SACrCC,kBAAkBD;IAE1B,MAAME,kBAAkBR,kBAAkBG,IAAI,CAAC,CAACM,iBAC9CA,eAAeC,GAAG,CAAC,CAACC,aAAeA,WAAWC,OAAO,CAACb;IAExD,OAAO,OAAOc,GAAGC;QACf,MAAMC,MAAsB;YAC1BC,KAAK;gBACHC,MAAMJ,EAAEG,GAAG,CAACE,GAAG,CAACD,IAAI;gBACpBE,KAAK,IAAIC,IAAIP,EAAEG,GAAG,CAACG,GAAG;gBACtBE,QAAQR,EAAEG,GAAG,CAACK,MAAM;gBACpBC,SAAST,EAAEG,GAAG,CAACO,MAAM;YACvB;YACAC,KAAK,CAAC;YACNC,MAAM;gBACJ,CAAC5B,aAAa,EAAEgB;YAClB;QACF;QACA,MAAMa,WAAW,MAAMlB;QACvB,MAAMmB,MAAM,OAAOC;YACjB,IAAIA,SAASF,SAASG,MAAM,EAAE;gBAC5B;YACF;YACA,IAAIC,gBAAgB;YACpB,MAAMJ,QAAQ,CAACE,MAAM,CAAEb,KAAK;gBAC1B,IAAI,CAACe,eAAe;oBAClBA,gBAAgB;oBAChB,MAAMH,IAAIC,QAAQ;gBACpB;YACF;QACF;QACA,MAAMD,IAAI;QACV,IAAIZ,IAAIS,GAAG,CAACP,IAAI,IAAIF,IAAIS,GAAG,CAACO,MAAM,EAAE;YAClC,MAAMA,SAAShB,IAAIS,GAAG,CAACO,MAAM,IAAI;YACjC,MAAMT,UAAUP,IAAIS,GAAG,CAACF,OAAO,IAAI,CAAC;YACpC,IAAIP,IAAIS,GAAG,CAACP,IAAI,EAAE;gBAChB,OAAOJ,EAAEI,IAAI,CAACF,IAAIS,GAAG,CAACP,IAAI,EAAEc,QAAiBT;YAC/C;YACA,OAAOT,EAAEI,IAAI,CAAC,MAAMc,QAAiBT;QACvC;QACA,MAAMR;IACR;AACF,EAAE;AAEF,MAAMkB,gBAAgB;AAEtB,eAAezB,kBACb0B,SAAoB;IAEpB,MAAM,CAAC,EAAEC,OAAO,EAAE,EAAE,EAAEC,aAAa,EAAE,EAAE,EAAEC,gBAAgB,EAAE,CAAC,GAC1D,MAAMC,QAAQC,GAAG,CAAC;QAChB,MAAM,CAAC,gBAAgB,GAAGN,gBAAgB;QAC1C,MAAM,CAAC,gBAAgB,GAAGA,gBAAgB;QAC1C,MAAM,CAAC,gBAAgB,GAAGA,gBAAgB;KAC3C;IACH,OAAOK,QAAQC,GAAG,CAChBL,UAAUtB,UAAU,CAACD,GAAG,CAAC,OAAO6B;QAC9B,MAAMC,cAAcD,KAAKE,UAAU,CAAC,QAChCN,cAAcD,QAAQK,OAAOG,QAAQ,KACrCH;QACJ,OAAOH,iBAAiBI;IAC1B;AAEJ"}