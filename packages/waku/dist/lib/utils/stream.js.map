{"version":3,"sources":["../../../src/lib/utils/stream.ts"],"sourcesContent":["// Utility functions for web streams (not Node.js streams)\n\nexport const concatUint8Arrays = (arrs: Uint8Array[]): Uint8Array => {\n  const len = arrs.reduce((acc, arr) => acc + arr.length, 0);\n  const array = new Uint8Array(len);\n  let offset = 0;\n  for (const arr of arrs) {\n    array.set(arr, offset);\n    offset += arr.length;\n  }\n  return array;\n};\n\n// FIXME remove the two loops if possible, if it is more efficient\nexport const streamToArrayBuffer = async (stream: ReadableStream) => {\n  const reader = stream.getReader();\n  const chunks = [];\n  let totalSize = 0;\n  let done = false;\n  let value: Uint8Array | undefined;\n\n  do {\n    ({ done, value } = await reader.read());\n    if (!done && value) {\n      chunks.push(value);\n      totalSize += value.length;\n    }\n  } while (!done);\n\n  const result = new Uint8Array(totalSize);\n  let offset = 0;\n  for (const chunk of chunks) {\n    result.set(chunk, offset);\n    offset += chunk.length;\n  }\n\n  return result.buffer;\n};\n\nexport const streamToString = async (\n  stream: ReadableStream,\n): Promise<string> => {\n  const decoder = new TextDecoder();\n  const reader = stream.getReader();\n  const outs: string[] = [];\n  let result: ReadableStreamReadResult<unknown>;\n  do {\n    result = await reader.read();\n    if (result.value) {\n      if (!(result.value instanceof Uint8Array)) {\n        throw new Error('Unexepected buffer type');\n      }\n      outs.push(decoder.decode(result.value, { stream: true }));\n    }\n  } while (!result.done);\n  outs.push(decoder.decode());\n  return outs.join('');\n};\n\nexport const stringToStream = (str: string): ReadableStream => {\n  const encoder = new TextEncoder();\n  return new ReadableStream({\n    start(controller) {\n      controller.enqueue(encoder.encode(str));\n      controller.close();\n    },\n  });\n};\n"],"names":["concatUint8Arrays","arrs","len","reduce","acc","arr","length","array","Uint8Array","offset","set","streamToArrayBuffer","stream","reader","getReader","chunks","totalSize","done","value","read","push","result","chunk","buffer","streamToString","decoder","TextDecoder","outs","Error","decode","join","stringToStream","str","encoder","TextEncoder","ReadableStream","start","controller","enqueue","encode","close"],"mappings":"AAAA,0DAA0D;AAE1D,OAAO,MAAMA,oBAAoB,CAACC;IAChC,MAAMC,MAAMD,KAAKE,MAAM,CAAC,CAACC,KAAKC,MAAQD,MAAMC,IAAIC,MAAM,EAAE;IACxD,MAAMC,QAAQ,IAAIC,WAAWN;IAC7B,IAAIO,SAAS;IACb,KAAK,MAAMJ,OAAOJ,KAAM;QACtBM,MAAMG,GAAG,CAACL,KAAKI;QACfA,UAAUJ,IAAIC,MAAM;IACtB;IACA,OAAOC;AACT,EAAE;AAEF,kEAAkE;AAClE,OAAO,MAAMI,sBAAsB,OAAOC;IACxC,MAAMC,SAASD,OAAOE,SAAS;IAC/B,MAAMC,SAAS,EAAE;IACjB,IAAIC,YAAY;IAChB,IAAIC,OAAO;IACX,IAAIC;IAEJ,GAAG;QACA,CAAA,EAAED,IAAI,EAAEC,KAAK,EAAE,GAAG,MAAML,OAAOM,IAAI,EAAC;QACrC,IAAI,CAACF,QAAQC,OAAO;YAClBH,OAAOK,IAAI,CAACF;YACZF,aAAaE,MAAMZ,MAAM;QAC3B;IACF,QAAS,CAACW,KAAM;IAEhB,MAAMI,SAAS,IAAIb,WAAWQ;IAC9B,IAAIP,SAAS;IACb,KAAK,MAAMa,SAASP,OAAQ;QAC1BM,OAAOX,GAAG,CAACY,OAAOb;QAClBA,UAAUa,MAAMhB,MAAM;IACxB;IAEA,OAAOe,OAAOE,MAAM;AACtB,EAAE;AAEF,OAAO,MAAMC,iBAAiB,OAC5BZ;IAEA,MAAMa,UAAU,IAAIC;IACpB,MAAMb,SAASD,OAAOE,SAAS;IAC/B,MAAMa,OAAiB,EAAE;IACzB,IAAIN;IACJ,GAAG;QACDA,SAAS,MAAMR,OAAOM,IAAI;QAC1B,IAAIE,OAAOH,KAAK,EAAE;YAChB,IAAI,CAAEG,CAAAA,OAAOH,KAAK,YAAYV,UAAS,GAAI;gBACzC,MAAM,IAAIoB,MAAM;YAClB;YACAD,KAAKP,IAAI,CAACK,QAAQI,MAAM,CAACR,OAAOH,KAAK,EAAE;gBAAEN,QAAQ;YAAK;QACxD;IACF,QAAS,CAACS,OAAOJ,IAAI,CAAE;IACvBU,KAAKP,IAAI,CAACK,QAAQI,MAAM;IACxB,OAAOF,KAAKG,IAAI,CAAC;AACnB,EAAE;AAEF,OAAO,MAAMC,iBAAiB,CAACC;IAC7B,MAAMC,UAAU,IAAIC;IACpB,OAAO,IAAIC,eAAe;QACxBC,OAAMC,UAAU;YACdA,WAAWC,OAAO,CAACL,QAAQM,MAAM,CAACP;YAClCK,WAAWG,KAAK;QAClB;IACF;AACF,EAAE"}