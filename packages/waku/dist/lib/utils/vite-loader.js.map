{"version":3,"sources":["../../../src/lib/utils/vite-loader.ts"],"sourcesContent":["import { createServer as createViteServer } from 'vite';\nimport type { RunnableDevEnvironment } from 'vite';\n\nimport { fileURLToFilePath } from '../utils/path.js';\n\nexport const loadServerModule = async <T>(idOrFileURL: string): Promise<T> => {\n  if (idOrFileURL === 'waku' || idOrFileURL.startsWith('waku/')) {\n    // HACK `external: ['waku']` doesn't do the same\n    return import(idOrFileURL) as T;\n  }\n  const vite = await createViteServer({\n    server: { middlewareMode: true, watch: null },\n    appType: 'custom',\n    environments: {\n      config: {\n        resolve: { external: ['waku'] },\n      },\n    },\n  });\n  await vite.ws.close();\n  await Promise.all(\n    Object.values(vite.environments).map(\n      (env) => env.name === 'config' || env.close(),\n    ),\n  );\n  const mod = await (\n    vite.environments.config as RunnableDevEnvironment\n  ).runner.import(\n    idOrFileURL.startsWith('file://')\n      ? fileURLToFilePath(idOrFileURL)\n      : idOrFileURL,\n  );\n  return mod as T;\n};\n"],"names":["createServer","createViteServer","fileURLToFilePath","loadServerModule","idOrFileURL","startsWith","vite","server","middlewareMode","watch","appType","environments","config","resolve","external","ws","close","Promise","all","Object","values","map","env","name","mod","runner","import"],"mappings":"AAAA,SAASA,gBAAgBC,gBAAgB,QAAQ,OAAO;AAGxD,SAASC,iBAAiB,QAAQ,mBAAmB;AAErD,OAAO,MAAMC,mBAAmB,OAAUC;IACxC,IAAIA,gBAAgB,UAAUA,YAAYC,UAAU,CAAC,UAAU;QAC7D,gDAAgD;QAChD,OAAO,MAAM,CAACD;IAChB;IACA,MAAME,OAAO,MAAML,iBAAiB;QAClCM,QAAQ;YAAEC,gBAAgB;YAAMC,OAAO;QAAK;QAC5CC,SAAS;QACTC,cAAc;YACZC,QAAQ;gBACNC,SAAS;oBAAEC,UAAU;wBAAC;qBAAO;gBAAC;YAChC;QACF;IACF;IACA,MAAMR,KAAKS,EAAE,CAACC,KAAK;IACnB,MAAMC,QAAQC,GAAG,CACfC,OAAOC,MAAM,CAACd,KAAKK,YAAY,EAAEU,GAAG,CAClC,CAACC,MAAQA,IAAIC,IAAI,KAAK,YAAYD,IAAIN,KAAK;IAG/C,MAAMQ,MAAM,MAAM,AAChBlB,KAAKK,YAAY,CAACC,MAAM,CACxBa,MAAM,CAACC,MAAM,CACbtB,YAAYC,UAAU,CAAC,aACnBH,kBAAkBE,eAClBA;IAEN,OAAOoB;AACT,EAAE"}