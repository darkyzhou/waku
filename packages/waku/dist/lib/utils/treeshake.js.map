{"version":3,"sources":["../../../src/lib/utils/treeshake.ts"],"sourcesContent":["import { rollup } from 'rollup';\nimport * as swc from '@swc/core';\n\nexport const treeshake = async (\n  code: string,\n  modifyModule?: (mod: swc.Module) => void,\n  tsx = false,\n): Promise<string> => {\n  const mod = swc.parseSync(code, { syntax: 'typescript', tsx });\n  modifyModule?.(mod);\n  const jsCode = swc.transformSync(mod, {\n    jsc: {\n      target: 'esnext',\n      parser: { syntax: 'typescript', tsx },\n    },\n  }).code;\n  const bundle = await rollup({\n    input: '\\0code',\n    external: () => true,\n    onwarn: (warning, defaultHandler) => {\n      if (warning.code === 'UNUSED_EXTERNAL_IMPORT') {\n        return;\n      }\n      defaultHandler(warning);\n    },\n    output: {\n      generatedCode: 'es2015',\n    },\n    treeshake: {\n      moduleSideEffects: 'no-external',\n      propertyReadSideEffects: false,\n    },\n    plugins: [\n      {\n        name: 'treeshake',\n        resolveId(id) {\n          if (id === '\\0code') {\n            return id;\n          }\n        },\n        load(id) {\n          if (id === '\\0code') {\n            return jsCode;\n          }\n        },\n        resolveDynamicImport(id) {\n          if (typeof id === 'string') {\n            return { id, external: true };\n          }\n        },\n      },\n    ],\n  });\n  const { output } = await bundle.generate({});\n  await bundle.close();\n  return output[0].code;\n};\n\nexport const removeObjectProperty = (name: string) => {\n  const walk = (node: swc.Node) => {\n    if (node.type === 'ObjectExpression') {\n      const n = node as swc.ObjectExpression;\n      const index = n.properties.findIndex(\n        (p) =>\n          p.type === 'KeyValueProperty' &&\n          p.key.type === 'Identifier' &&\n          p.key.value === name,\n      );\n      if (index >= 0) {\n        n.properties.splice(index, 1);\n        return;\n      }\n    }\n    Object.values(node).forEach((value) => {\n      (Array.isArray(value) ? value : [value]).forEach((v) => {\n        if (typeof v?.type === 'string') {\n          walk(v);\n        } else if (typeof v?.expression?.type === 'string') {\n          walk(v.expression);\n        }\n      });\n    });\n  };\n  return walk;\n};\n"],"names":["rollup","swc","treeshake","code","modifyModule","tsx","mod","parseSync","syntax","jsCode","transformSync","jsc","target","parser","bundle","input","external","onwarn","warning","defaultHandler","output","generatedCode","moduleSideEffects","propertyReadSideEffects","plugins","name","resolveId","id","load","resolveDynamicImport","generate","close","removeObjectProperty","walk","node","type","n","index","properties","findIndex","p","key","value","splice","Object","values","forEach","Array","isArray","v","expression"],"mappings":"AAAA,SAASA,MAAM,QAAQ,SAAS;AAChC,YAAYC,SAAS,YAAY;AAEjC,OAAO,MAAMC,YAAY,OACvBC,MACAC,cACAC,MAAM,KAAK;IAEX,MAAMC,MAAML,IAAIM,SAAS,CAACJ,MAAM;QAAEK,QAAQ;QAAcH;IAAI;IAC5DD,eAAeE;IACf,MAAMG,SAASR,IAAIS,aAAa,CAACJ,KAAK;QACpCK,KAAK;YACHC,QAAQ;YACRC,QAAQ;gBAAEL,QAAQ;gBAAcH;YAAI;QACtC;IACF,GAAGF,IAAI;IACP,MAAMW,SAAS,MAAMd,OAAO;QAC1Be,OAAO;QACPC,UAAU,IAAM;QAChBC,QAAQ,CAACC,SAASC;YAChB,IAAID,QAAQf,IAAI,KAAK,0BAA0B;gBAC7C;YACF;YACAgB,eAAeD;QACjB;QACAE,QAAQ;YACNC,eAAe;QACjB;QACAnB,WAAW;YACToB,mBAAmB;YACnBC,yBAAyB;QAC3B;QACAC,SAAS;YACP;gBACEC,MAAM;gBACNC,WAAUC,EAAE;oBACV,IAAIA,OAAO,UAAU;wBACnB,OAAOA;oBACT;gBACF;gBACAC,MAAKD,EAAE;oBACL,IAAIA,OAAO,UAAU;wBACnB,OAAOlB;oBACT;gBACF;gBACAoB,sBAAqBF,EAAE;oBACrB,IAAI,OAAOA,OAAO,UAAU;wBAC1B,OAAO;4BAAEA;4BAAIX,UAAU;wBAAK;oBAC9B;gBACF;YACF;SACD;IACH;IACA,MAAM,EAAEI,MAAM,EAAE,GAAG,MAAMN,OAAOgB,QAAQ,CAAC,CAAC;IAC1C,MAAMhB,OAAOiB,KAAK;IAClB,OAAOX,MAAM,CAAC,EAAE,CAACjB,IAAI;AACvB,EAAE;AAEF,OAAO,MAAM6B,uBAAuB,CAACP;IACnC,MAAMQ,OAAO,CAACC;QACZ,IAAIA,KAAKC,IAAI,KAAK,oBAAoB;YACpC,MAAMC,IAAIF;YACV,MAAMG,QAAQD,EAAEE,UAAU,CAACC,SAAS,CAClC,CAACC,IACCA,EAAEL,IAAI,KAAK,sBACXK,EAAEC,GAAG,CAACN,IAAI,KAAK,gBACfK,EAAEC,GAAG,CAACC,KAAK,KAAKjB;YAEpB,IAAIY,SAAS,GAAG;gBACdD,EAAEE,UAAU,CAACK,MAAM,CAACN,OAAO;gBAC3B;YACF;QACF;QACAO,OAAOC,MAAM,CAACX,MAAMY,OAAO,CAAC,CAACJ;YAC1BK,CAAAA,MAAMC,OAAO,CAACN,SAASA,QAAQ;gBAACA;aAAM,AAAD,EAAGI,OAAO,CAAC,CAACG;gBAChD,IAAI,OAAOA,GAAGd,SAAS,UAAU;oBAC/BF,KAAKgB;gBACP,OAAO,IAAI,OAAOA,GAAGC,YAAYf,SAAS,UAAU;oBAClDF,KAAKgB,EAAEC,UAAU;gBACnB;YACF;QACF;IACF;IACA,OAAOjB;AACT,EAAE"}