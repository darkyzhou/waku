{"version":3,"sources":["../../../src/lib/middleware/handler.ts"],"sourcesContent":["import type { ReactNode } from 'react';\n\nimport { resolveConfigDev } from '../config.js';\nimport type { ConfigPrd } from '../config.js';\nimport {\n  INTERNAL_setAllEnv,\n  INTERNAL_setPlatformDataLoader,\n} from '../../server.js';\nimport type { HandleRequest, HandlerRes } from '../types.js';\nimport type { Middleware, HandlerContext } from './types.js';\nimport { renderRsc, decodeBody, decodePostAction } from '../renderers/rsc.js';\nimport { renderHtml } from '../renderers/html.js';\nimport { decodeRscPath, decodeFuncId } from '../renderers/utils.js';\nimport { filePathToFileURL, getPathMapping } from '../utils/path.js';\nimport { getErrorInfo } from '../utils/custom-errors.js';\nimport { stringToStream } from '../utils/stream.js';\n\nexport const SERVER_MODULE_MAP = {\n  'rsdw-server': 'react-server-dom-webpack/server.edge',\n} as const;\nexport const CLIENT_MODULE_MAP = {\n  'rd-server': 'react-dom/server.edge',\n  'rsdw-client': 'react-server-dom-webpack/client.edge',\n  'waku-minimal-client': 'waku/minimal/client',\n} as const;\nexport const CLIENT_PREFIX = 'client/';\n\nconst getInput = async (\n  config: ConfigPrd,\n  ctx: HandlerContext,\n  loadServerModule: (fileId: string) => Promise<unknown>,\n): Promise<Parameters<HandleRequest>[0] | null> => {\n  if (!ctx.req.url.pathname.startsWith(config.basePath)) {\n    return null;\n  }\n  const basePrefix = config.basePath + config.rscBase + '/';\n  if (ctx.req.url.pathname.startsWith(basePrefix)) {\n    const rscPath = decodeRscPath(\n      decodeURI(ctx.req.url.pathname.slice(basePrefix.length)),\n    );\n    const decodedBody = await decodeBody(ctx);\n    const funcId = decodeFuncId(rscPath);\n    if (funcId) {\n      const args = Array.isArray(decodedBody)\n        ? decodedBody\n        : decodedBody instanceof URLSearchParams\n          ? [decodedBody]\n          : [];\n      const [fileId, name] = funcId.split('#') as [string, string];\n      const mod: any = await loadServerModule(fileId);\n      return { type: 'function', fn: mod[name], args, req: ctx.req };\n    }\n    return { type: 'component', rscPath, rscParams: decodedBody, req: ctx.req };\n  }\n  if (ctx.req.method === 'POST') {\n    const postAction = await decodePostAction(ctx);\n    if (postAction) {\n      return {\n        type: 'action',\n        fn: postAction,\n        pathname: '/' + ctx.req.url.pathname.slice(config.basePath.length),\n        req: ctx.req,\n      };\n    }\n  }\n  return {\n    type: 'custom',\n    pathname: '/' + ctx.req.url.pathname.slice(config.basePath.length),\n    req: ctx.req,\n  };\n};\n\nexport const handler: Middleware = (options) => {\n  const env = options.env;\n  INTERNAL_setAllEnv(env);\n  const entriesPrdPromise =\n    options.cmd === 'start' ? options.loadEntries() : null;\n  entriesPrdPromise\n    ?.then((entries) => {\n      if (entries.loadPlatformData) {\n        INTERNAL_setPlatformDataLoader(entries.loadPlatformData);\n      }\n    })\n    .catch(() => {});\n  const configDevPromise =\n    options.cmd === 'dev' ? resolveConfigDev(options.config) : null;\n\n  return async (ctx, next) => {\n    const { unstable_devServer: devServer } = ctx;\n    const entriesPrd = await entriesPrdPromise!;\n    const config = devServer ? await configDevPromise! : entriesPrd.configPrd;\n    const entries = devServer\n      ? await devServer.loadEntriesDev(await configDevPromise!)\n      : entriesPrd;\n    const rsdwServer = devServer\n      ? await devServer.loadServerModuleRsc(SERVER_MODULE_MAP['rsdw-server'])\n      : await entriesPrd.loadModule('rsdw-server');\n    const rdServer = devServer\n      ? await devServer.loadServerModuleMain(CLIENT_MODULE_MAP['rd-server'])\n      : await entriesPrd.loadModule(CLIENT_PREFIX + 'rd-server');\n    const rsdwClient = devServer\n      ? await devServer.loadServerModuleMain(CLIENT_MODULE_MAP['rsdw-client'])\n      : await entriesPrd.loadModule(CLIENT_PREFIX + 'rsdw-client');\n    const wakuMinimalClient = devServer\n      ? await devServer.loadServerModuleMain(\n          CLIENT_MODULE_MAP['waku-minimal-client'],\n        )\n      : await entriesPrd.loadModule(CLIENT_PREFIX + 'waku-minimal-client');\n    ctx.unstable_modules = {\n      rsdwServer,\n      rdServer,\n      rsdwClient,\n      wakuMinimalClient,\n    };\n    const loadServerModule = (fileId: string) => {\n      if (devServer) {\n        return devServer.loadServerModuleRsc(filePathToFileURL(fileId));\n      } else {\n        return entriesPrd.loadModule(fileId + '.js');\n      }\n    };\n    const htmlHead = devServer\n      ? ''\n      : entriesPrd.dynamicHtmlPaths.find(([pathSpec]) =>\n          getPathMapping(pathSpec, ctx.req.url.pathname),\n        )?.[1] || entriesPrd.defaultHtmlHead;\n    const transformIndexHtml =\n      devServer && (await devServer.transformIndexHtml(ctx.req.url.pathname));\n    const utils = {\n      renderRsc: (elements: Record<string, unknown>) =>\n        renderRsc(config, ctx, elements, options.unstable_onError),\n      renderHtml: async (\n        elements: Record<string, unknown>,\n        html: ReactNode,\n        opts: { rscPath: string; actionResult?: unknown },\n      ) => {\n        const readable = await renderHtml(\n          config,\n          ctx,\n          htmlHead,\n          elements,\n          options.unstable_onError,\n          html,\n          opts.rscPath,\n          opts.actionResult,\n        );\n        const headers = { 'content-type': 'text/html; charset=utf-8' };\n        let body = readable;\n        if (transformIndexHtml) {\n          body = readable.pipeThrough(transformIndexHtml) as never;\n          body.allReady = readable.allReady;\n        }\n        return { body, headers };\n      },\n    };\n    const input = await getInput(config, ctx, loadServerModule);\n    if (input) {\n      let res: ReadableStream | HandlerRes | null | undefined;\n      try {\n        res = await entries.default.handleRequest(input, utils);\n      } catch (e) {\n        options.unstable_onError.forEach((fn) => fn(e, ctx, 'handler'));\n        const info = getErrorInfo(e);\n        if (info?.status !== 404) {\n          ctx.res.status = info?.status || 500;\n          ctx.res.body = stringToStream(\n            (e as { message?: string } | undefined)?.message || String(e),\n          );\n          if (info?.location) {\n            (ctx.res.headers ||= {}).location = info.location;\n          }\n        }\n      }\n      if (res instanceof ReadableStream) {\n        ctx.res.body = res;\n      } else if (res) {\n        if (res.body) {\n          ctx.res.body = res.body;\n        }\n        if (res.status) {\n          ctx.res.status = res.status;\n        }\n        if (res.headers) {\n          Object.assign((ctx.res.headers ||= {}), res.headers);\n        }\n      }\n      if (ctx.res.body || ctx.res.status) {\n        return;\n      }\n    }\n\n    await next();\n  };\n};\n"],"names":["resolveConfigDev","INTERNAL_setAllEnv","INTERNAL_setPlatformDataLoader","renderRsc","decodeBody","decodePostAction","renderHtml","decodeRscPath","decodeFuncId","filePathToFileURL","getPathMapping","getErrorInfo","stringToStream","SERVER_MODULE_MAP","CLIENT_MODULE_MAP","CLIENT_PREFIX","getInput","config","ctx","loadServerModule","req","url","pathname","startsWith","basePath","basePrefix","rscBase","rscPath","decodeURI","slice","length","decodedBody","funcId","args","Array","isArray","URLSearchParams","fileId","name","split","mod","type","fn","rscParams","method","postAction","handler","options","env","entriesPrdPromise","cmd","loadEntries","then","entries","loadPlatformData","catch","configDevPromise","next","unstable_devServer","devServer","entriesPrd","configPrd","loadEntriesDev","rsdwServer","loadServerModuleRsc","loadModule","rdServer","loadServerModuleMain","rsdwClient","wakuMinimalClient","unstable_modules","htmlHead","dynamicHtmlPaths","find","pathSpec","defaultHtmlHead","transformIndexHtml","utils","elements","unstable_onError","html","opts","readable","actionResult","headers","body","pipeThrough","allReady","input","res","default","handleRequest","e","forEach","info","status","message","String","location","ReadableStream","Object","assign"],"mappings":"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"}