{"version":3,"sources":["../../../src/lib/middleware/context.ts"],"sourcesContent":["import type { AsyncLocalStorage as AsyncLocalStorageType } from 'node:async_hooks';\n\nimport type { HandlerReq } from '../types.js';\nimport type { Middleware } from './types.js';\n\ntype Context = {\n  readonly req: HandlerReq;\n  readonly data: Record<string, unknown>;\n};\n\nconst setContextStorage = (storage: AsyncLocalStorageType<Context>) => {\n  (globalThis as any).__WAKU_MIDDLEWARE_CONTEXT_STORAGE__ ||= storage;\n};\n\nconst getContextStorage = (): AsyncLocalStorageType<Context> => {\n  return (globalThis as any).__WAKU_MIDDLEWARE_CONTEXT_STORAGE__;\n};\n\ntry {\n  const { AsyncLocalStorage } = await import('node:async_hooks');\n  setContextStorage(new AsyncLocalStorage());\n} catch {\n  console.warn('AsyncLocalStorage is not available');\n}\n\nlet previousContext: Context | undefined;\nlet currentContext: Context | undefined;\n\nconst runWithContext = <T>(context: Context, fn: () => T): T => {\n  const contextStorage = getContextStorage();\n  if (contextStorage) {\n    return contextStorage.run(context, fn);\n  }\n  previousContext = currentContext;\n  currentContext = context;\n  try {\n    return fn();\n  } finally {\n    currentContext = previousContext;\n  }\n};\n\nexport const context: Middleware = () => {\n  return async (ctx, next) => {\n    const context: Context = {\n      req: ctx.req,\n      data: ctx.data,\n    };\n    return runWithContext(context, next);\n  };\n};\n\nexport function getContext() {\n  const contextStorage = getContextStorage();\n  const context = contextStorage?.getStore() ?? currentContext;\n  if (!context) {\n    throw new Error(\n      'Context is not available. Make sure to use the context middleware. For now, Context is not available during the build time.',\n    );\n  }\n  return context;\n}\n\nexport function getContextData(): Record<string, unknown> {\n  const contextStorage = getContextStorage();\n  const context = contextStorage?.getStore() ?? currentContext;\n  if (!context) {\n    return {};\n  }\n  return context.data;\n}\n"],"names":["setContextStorage","storage","globalThis","__WAKU_MIDDLEWARE_CONTEXT_STORAGE__","getContextStorage","AsyncLocalStorage","console","warn","previousContext","currentContext","runWithContext","context","fn","contextStorage","run","ctx","next","req","data","getContext","getStore","Error","getContextData"],"mappings":"AAUA,MAAMA,oBAAoB,CAACC;IACxBC,WAAmBC,mCAAmC,KAAKF;AAC9D;AAEA,MAAMG,oBAAoB;IACxB,OAAO,AAACF,WAAmBC,mCAAmC;AAChE;AAEA,IAAI;IACF,MAAM,EAAEE,iBAAiB,EAAE,GAAG,MAAM,MAAM,CAAC;IAC3CL,kBAAkB,IAAIK;AACxB,EAAE,OAAM;IACNC,QAAQC,IAAI,CAAC;AACf;AAEA,IAAIC;AACJ,IAAIC;AAEJ,MAAMC,iBAAiB,CAAIC,SAAkBC;IAC3C,MAAMC,iBAAiBT;IACvB,IAAIS,gBAAgB;QAClB,OAAOA,eAAeC,GAAG,CAACH,SAASC;IACrC;IACAJ,kBAAkBC;IAClBA,iBAAiBE;IACjB,IAAI;QACF,OAAOC;IACT,SAAU;QACRH,iBAAiBD;IACnB;AACF;AAEA,OAAO,MAAMG,UAAsB;IACjC,OAAO,OAAOI,KAAKC;QACjB,MAAML,UAAmB;YACvBM,KAAKF,IAAIE,GAAG;YACZC,MAAMH,IAAIG,IAAI;QAChB;QACA,OAAOR,eAAeC,SAASK;IACjC;AACF,EAAE;AAEF,OAAO,SAASG;IACd,MAAMN,iBAAiBT;IACvB,MAAMO,UAAUE,gBAAgBO,cAAcX;IAC9C,IAAI,CAACE,SAAS;QACZ,MAAM,IAAIU,MACR;IAEJ;IACA,OAAOV;AACT;AAEA,OAAO,SAASW;IACd,MAAMT,iBAAiBT;IACvB,MAAMO,UAAUE,gBAAgBO,cAAcX;IAC9C,IAAI,CAACE,SAAS;QACZ,OAAO,CAAC;IACV;IACA,OAAOA,QAAQO,IAAI;AACrB"}