{"version":3,"sources":["../../../src/lib/middleware/dev-server-impl.ts"],"sourcesContent":["import { Readable, Writable } from 'node:stream';\nimport { Server } from 'node:http';\nimport { AsyncLocalStorage } from 'node:async_hooks';\nimport { createServer as createViteServer } from 'vite';\nimport viteReact from '@vitejs/plugin-react';\n\nimport type { EntriesDev } from '../types.js';\nimport { resolveConfigDev } from '../config.js';\nimport { SRC_MAIN, SRC_ENTRIES } from '../builder/constants.js';\nimport {\n  decodeFilePathFromAbsolute,\n  joinPath,\n  fileURLToFilePath,\n  filePathToFileURL,\n} from '../utils/path.js';\nimport { extendViteConfig } from '../utils/vite-config.js';\nimport { patchReactRefresh } from '../plugins/patch-react-refresh.js';\nimport { nonjsResolvePlugin } from '../plugins/vite-plugin-nonjs-resolve.js';\nimport { devCommonJsPlugin } from '../plugins/vite-plugin-dev-commonjs.js';\nimport { rscRsdwPlugin } from '../plugins/vite-plugin-rsc-rsdw.js';\nimport { rscTransformPlugin } from '../plugins/vite-plugin-rsc-transform.js';\nimport { rscIndexPlugin } from '../plugins/vite-plugin-rsc-index.js';\nimport { rscHmrPlugin, hotUpdate } from '../plugins/vite-plugin-rsc-hmr.js';\nimport type { HotUpdatePayload } from '../plugins/vite-plugin-rsc-hmr.js';\nimport { rscEnvPlugin } from '../plugins/vite-plugin-rsc-env.js';\nimport { rscPrivatePlugin } from '../plugins/vite-plugin-rsc-private.js';\nimport { rscManagedPlugin } from '../plugins/vite-plugin-rsc-managed.js';\nimport { rscDelegatePlugin } from '../plugins/vite-plugin-rsc-delegate.js';\nimport type { ClonableModuleNode, Middleware } from './types.js';\nimport { fsRouterTypegenPlugin } from '../plugins/vite-plugin-fs-router-typegen.js';\nimport { hackTailwindcss4Stackblitz } from '../plugins/hack-tailwindcss4-stackblitz.js';\n\n// TODO there is huge room for refactoring in this file\n\n// For react-server-dom-webpack/server.edge\n(globalThis as any).AsyncLocalStorage = AsyncLocalStorage;\n\nconst createStreamPair = (): [Writable, Promise<ReadableStream | null>] => {\n  let controller: ReadableStreamDefaultController | undefined;\n  const readable = new ReadableStream({\n    start(c) {\n      controller = c;\n    },\n    cancel() {\n      controller = undefined;\n    },\n  });\n  let resolve: (value: ReadableStream | null) => void;\n  const promise = new Promise<ReadableStream | null>((r) => (resolve = r));\n  let hasData = false;\n  const writable = new Writable({\n    write(chunk, encoding, callback) {\n      if (encoding !== ('buffer' as any)) {\n        throw new Error('Unknown encoding');\n      }\n      if (controller) {\n        controller.enqueue(chunk);\n        if (!hasData) {\n          hasData = true;\n          resolve(readable);\n        }\n      }\n      callback();\n    },\n    final(callback) {\n      if (controller) {\n        controller.close();\n        if (!hasData) {\n          resolve(null);\n        }\n      }\n      callback();\n    },\n  });\n  return [writable, promise];\n};\n\nconst createMainViteServer = (\n  env: Record<string, string>,\n  configPromise: ReturnType<typeof resolveConfigDev>,\n  hotUpdateCallbackSet: Set<(payload: HotUpdatePayload) => void>,\n  resolvedMap: Map<string, string>,\n) => {\n  const registerHotUpdateCallback = (fn: (payload: HotUpdatePayload) => void) =>\n    hotUpdateCallbackSet.add(fn);\n\n  const vitePromise = configPromise.then(async (config) => {\n    const vite = await createViteServer(\n      extendViteConfig(\n        {\n          // Since we have multiple instances of vite, different ones might overwrite the others' cache.\n          cacheDir: 'node_modules/.vite/waku-dev-server-main',\n          base: config.basePath,\n          plugins: [\n            patchReactRefresh(viteReact()),\n            nonjsResolvePlugin(),\n            devCommonJsPlugin({\n              filter: (id) => {\n                if (\n                  id.includes('/node_modules/react-server-dom-webpack/') ||\n                  id.includes('/node_modules/react-dom/') ||\n                  id.includes('/node_modules/react/')\n                ) {\n                  return true;\n                }\n              },\n            }),\n            rscRsdwPlugin(),\n            rscEnvPlugin({ isDev: true, env, config }),\n            rscPrivatePlugin(config),\n            rscManagedPlugin(config),\n            rscIndexPlugin(config),\n            rscTransformPlugin({ isClient: true, isBuild: false }),\n            rscHmrPlugin(),\n            fsRouterTypegenPlugin(config),\n            hackTailwindcss4Stackblitz(),\n          ],\n          optimizeDeps: {\n            include: ['react-server-dom-webpack/client', 'react-dom/client'],\n            exclude: ['waku', 'rsc-html-stream/server'],\n            entries: [\n              `${config.srcDir}/${SRC_ENTRIES}.*`,\n              // HACK hard-coded \"pages\"\n              `${config.srcDir}/pages/**/*.*`,\n            ],\n          },\n          ssr: {\n            external: ['waku'],\n            optimizeDeps: {\n              include: ['react-server-dom-webpack/client.edge'],\n            },\n          },\n          appType: 'mpa',\n          server: { middlewareMode: true },\n        },\n        config,\n        'dev-main',\n      ),\n    );\n    registerHotUpdateCallback((payload) => hotUpdate(vite, payload));\n    return vite;\n  });\n\n  const wakuDist = decodeFilePathFromAbsolute(\n    joinPath(fileURLToFilePath(import.meta.url), '../../..'),\n  );\n\n  // FIXME This function feels too hacky\n  const loadServerModuleMain = async (idOrFileURL: string) => {\n    const vite = await vitePromise;\n    if (!idOrFileURL.startsWith('file://')) {\n      if (idOrFileURL === 'waku' || idOrFileURL.startsWith('waku/')) {\n        // HACK `external: ['waku']` doesn't do the same\n        return import(/* @vite-ignore */ idOrFileURL);\n      }\n      return vite.ssrLoadModule(idOrFileURL);\n    }\n    const filePath = fileURLToFilePath(idOrFileURL.split('?')[0]!);\n    const file = filePath.startsWith('/')\n      ? filePath\n      : joinPath(vite.config.root, filePath);\n    if (decodeFilePathFromAbsolute(file).startsWith(wakuDist)) {\n      // HACK `external: ['waku']` doesn't do the same\n      return import(/* @vite-ignore */ filePathToFileURL(file));\n    }\n    {\n      let id = file;\n      while (resolvedMap.has(id)) {\n        id = resolvedMap.get(id)!;\n      }\n      if (!id.startsWith('/')) {\n        return vite.ssrLoadModule(id);\n      }\n    }\n    if (file.includes('/node_modules/')) {\n      // HACK node_modules should be externalized\n      return import(/* @vite-ignore */ filePathToFileURL(file));\n    }\n    return vite.ssrLoadModule(fileURLToFilePath(idOrFileURL));\n  };\n\n  const transformIndexHtml = async (pathname: string) => {\n    const vite = await vitePromise;\n    const encoder = new TextEncoder();\n    const decoder = new TextDecoder();\n    let headSent = false;\n    return new TransformStream({\n      transform(chunk, controller) {\n        if (!(chunk instanceof Uint8Array)) {\n          throw new Error('Unknown chunk type');\n        }\n        if (!headSent) {\n          headSent = true;\n          let data = decoder.decode(chunk);\n          // FIXME without removing async, Vite will move it\n          // to the proxy cache, which breaks __WAKU_PUSH__.\n          data = data.replace(/<script type=\"module\" async>/, '<script>');\n          return new Promise<void>((resolve, reject) => {\n            vite\n              .transformIndexHtml(pathname, data)\n              .then((result) => {\n                controller.enqueue(encoder.encode(result));\n                resolve();\n              })\n              .catch(reject);\n          });\n        }\n        controller.enqueue(chunk);\n      },\n      flush() {\n        if (!headSent) {\n          throw new Error('head not yet sent');\n        }\n      },\n    });\n  };\n\n  // FIXME This function feels like a hack\n  const willBeHandled = async (pathname: string) => {\n    const vite = await vitePromise;\n    try {\n      const result = await vite.transformRequest(pathname);\n      if (result?.code === `export default \"/@fs${encodeURI(pathname)}\"`) {\n        return false;\n      }\n      return !!result;\n    } catch {\n      return false;\n    }\n  };\n\n  return {\n    vitePromise,\n    loadServerModuleMain,\n    transformIndexHtml,\n    willBeHandled,\n  };\n};\n\nconst createRscViteServer = (\n  env: Record<string, string>,\n  configPromise: ReturnType<typeof resolveConfigDev>,\n  hotUpdateCallbackSet: Set<(payload: HotUpdatePayload) => void>,\n  resolvedMap: Map<string, string>,\n) => {\n  const hotUpdateCallback = (payload: HotUpdatePayload) =>\n    hotUpdateCallbackSet.forEach((fn) => fn(payload));\n  const dummyServer = new Server(); // FIXME we hope to avoid this hack\n\n  const vitePromise = configPromise.then(async (config) => {\n    const vite = await createViteServer(\n      extendViteConfig(\n        {\n          // Since we have multiple instances of vite, different ones might overwrite the others' cache.\n          cacheDir: 'node_modules/.vite/waku-dev-server-rsc',\n          plugins: [\n            viteReact(),\n            nonjsResolvePlugin(),\n            devCommonJsPlugin({}),\n            rscRsdwPlugin(),\n            rscEnvPlugin({ isDev: true, env }),\n            rscPrivatePlugin({\n              privateDir: config.privateDir,\n              hotUpdateCallback,\n            }),\n            rscManagedPlugin(config),\n            rscTransformPlugin({\n              isClient: false,\n              isBuild: false,\n              resolvedMap,\n            }),\n            rscDelegatePlugin(hotUpdateCallback),\n            hackTailwindcss4Stackblitz(),\n          ],\n          optimizeDeps: {\n            include: ['react-server-dom-webpack/client', 'react-dom/client'],\n            exclude: ['waku'],\n            entries: [\n              `${config.srcDir}/${SRC_ENTRIES}.*`,\n              // HACK hard-coded \"pages\"\n              `${config.srcDir}/pages/**/*.*`,\n            ],\n          },\n          ssr: {\n            resolve: {\n              conditions: ['react-server'],\n              externalConditions: ['react-server'],\n            },\n            noExternal: /^(?!node:)/,\n            optimizeDeps: {\n              include: [\n                'react-server-dom-webpack/server.edge',\n                'react',\n                'react/jsx-runtime',\n                'react/jsx-dev-runtime',\n                'react-dom',\n              ],\n              exclude: ['waku'],\n            },\n          },\n          appType: 'custom',\n          server: { middlewareMode: true, hmr: { server: dummyServer } },\n        },\n        config,\n        'dev-rsc',\n      ),\n    );\n    return vite;\n  });\n\n  const loadServerModuleRsc = async (idOrFileURL: string) => {\n    const vite = await vitePromise;\n    return vite.ssrLoadModule(\n      idOrFileURL.startsWith('file://')\n        ? fileURLToFilePath(idOrFileURL)\n        : idOrFileURL,\n    );\n  };\n\n  const loadEntriesDev = async (config: { srcDir: string }) => {\n    const vite = await vitePromise;\n    const filePath = joinPath(vite.config.root, config.srcDir, SRC_ENTRIES);\n    return vite.ssrLoadModule(filePath) as Promise<EntriesDev>;\n  };\n\n  const resolveClientEntry = (\n    id: string,\n    config: { rootDir: string; basePath: string },\n    initialModules: ClonableModuleNode[],\n  ) => {\n    let file = id;\n    if (file.startsWith('/@fs/')) {\n      file = file.slice('/@fs'.length); // keep '/' at the beginning\n    }\n    for (const moduleNode of initialModules) {\n      if (moduleNode.file === file) {\n        return moduleNode.url;\n      }\n    }\n    if (file.startsWith(config.rootDir)) {\n      file = file.slice(config.rootDir.length + 1); // '+ 1' to remove '/'\n    } else if (file.startsWith('/')) {\n      file = '@fs' + file;\n    } else {\n      file = '@id/' + file;\n    }\n    return config.basePath + file;\n  };\n\n  return {\n    loadServerModuleRsc,\n    loadEntriesDev,\n    resolveClientEntry,\n  };\n};\n\nexport const devServer: Middleware = (options) => {\n  if (options.cmd !== 'dev') {\n    // pass through if not dev command\n    return (_ctx, next) => next();\n  }\n\n  const env = options.env;\n  const configPromise = resolveConfigDev(options.config);\n\n  (globalThis as any).__WAKU_SERVER_IMPORT__ = (id: string) =>\n    loadServerModuleRsc(id);\n\n  (globalThis as any).__WAKU_CLIENT_IMPORT__ = (id: string) =>\n    loadServerModuleMain(id);\n\n  const hotUpdateCallbackSet = new Set<(payload: HotUpdatePayload) => void>();\n  const resolvedMap = new Map<string, string>();\n\n  const {\n    vitePromise,\n    loadServerModuleMain,\n    transformIndexHtml,\n    willBeHandled,\n  } = createMainViteServer(\n    env,\n    configPromise,\n    hotUpdateCallbackSet,\n    resolvedMap,\n  );\n\n  const { loadServerModuleRsc, loadEntriesDev, resolveClientEntry } =\n    createRscViteServer(env, configPromise, hotUpdateCallbackSet, resolvedMap);\n\n  let initialModules: ClonableModuleNode[];\n\n  return async (ctx, next) => {\n    const [config, vite] = await Promise.all([configPromise, vitePromise]);\n\n    if (!initialModules) {\n      const processedModules = new Set<string>();\n\n      const processModule = async (modulePath: string) => {\n        if (modulePath.endsWith('.css')) {\n          // HACK not sure if this is correct\n          return;\n        }\n        if (processedModules.has(modulePath)) {\n          return;\n        }\n        processedModules.add(modulePath);\n\n        await vite.transformRequest(modulePath);\n        const resolved = await vite.pluginContainer.resolveId(modulePath);\n        if (!resolved) {\n          return;\n        }\n\n        const module = vite.moduleGraph.idToModuleMap.get(resolved.id);\n        if (!module) {\n          return;\n        }\n\n        await Promise.all(\n          Array.from(module.importedModules).map(async (importedModule) => {\n            if (importedModule.id) {\n              await processModule(importedModule.id);\n            }\n          }),\n        );\n      };\n\n      const mainJs = `${config.basePath}${config.srcDir}/${SRC_MAIN}`;\n      const entriesFile = `${vite.config.root}${config.basePath}${config.srcDir}/${SRC_ENTRIES}`;\n\n      await processModule(mainJs);\n      await processModule(entriesFile);\n\n      initialModules = Array.from(\n        vite.moduleGraph.idToModuleMap.values(),\n      ).flatMap((m) => (m.file ? [{ url: m.url, file: m.file }] : []));\n    }\n\n    ctx.unstable_devServer = {\n      rootDir: vite.config.root,\n      resolveClientEntry: (id: string) =>\n        resolveClientEntry(\n          id,\n          {\n            rootDir: vite.config.root,\n            basePath: config.basePath,\n          },\n          initialModules,\n        ),\n      loadServerModuleRsc,\n      loadEntriesDev,\n      loadServerModuleMain,\n      transformIndexHtml,\n    };\n\n    if (!(await willBeHandled(ctx.req.url.pathname))) {\n      await next();\n      if (ctx.res.body || ctx.res.status) {\n        return;\n      }\n    }\n\n    const viteUrl = ctx.req.url.toString().slice(ctx.req.url.origin.length);\n    const viteReq: any = ctx.req.body\n      ? Readable.fromWeb(ctx.req.body as never)\n      : Readable.from([]);\n    viteReq.method = ctx.req.method;\n    viteReq.url = viteUrl;\n    viteReq.headers = ctx.req.headers;\n    const [writable, readablePromise] = createStreamPair();\n    const viteRes: any = writable;\n    Object.defineProperty(viteRes, 'statusCode', {\n      set(code) {\n        ctx.res.status = code;\n      },\n    });\n    const headers = new Map<string, string>();\n    viteRes.setHeader = (name: string, value: string) => {\n      headers.set(name, value);\n      ctx.res.headers = {\n        ...ctx.res.headers,\n        [name]: String(value),\n      };\n    };\n    viteRes.getHeader = (name: string) => headers.get(name);\n    viteRes.writeHead = (code: number, headers?: Record<string, string>) => {\n      ctx.res.status = code;\n      for (const [name, value] of Object.entries(headers || {})) {\n        viteRes.setHeader(name, value);\n      }\n    };\n    vite.middlewares(viteReq, viteRes);\n    const body = await readablePromise;\n    if (body) {\n      ctx.res.body = body;\n    } else if (ctx.res.status === 404) {\n      delete ctx.res.status;\n    }\n  };\n};\n"],"names":["Readable","Writable","Server","AsyncLocalStorage","createServer","createViteServer","viteReact","resolveConfigDev","SRC_MAIN","SRC_ENTRIES","decodeFilePathFromAbsolute","joinPath","fileURLToFilePath","filePathToFileURL","extendViteConfig","patchReactRefresh","nonjsResolvePlugin","devCommonJsPlugin","rscRsdwPlugin","rscTransformPlugin","rscIndexPlugin","rscHmrPlugin","hotUpdate","rscEnvPlugin","rscPrivatePlugin","rscManagedPlugin","rscDelegatePlugin","fsRouterTypegenPlugin","hackTailwindcss4Stackblitz","globalThis","createStreamPair","controller","readable","ReadableStream","start","c","cancel","undefined","resolve","promise","Promise","r","hasData","writable","write","chunk","encoding","callback","Error","enqueue","final","close","createMainViteServer","env","configPromise","hotUpdateCallbackSet","resolvedMap","registerHotUpdateCallback","fn","add","vitePromise","then","config","vite","cacheDir","base","basePath","plugins","filter","id","includes","isDev","isClient","isBuild","optimizeDeps","include","exclude","entries","srcDir","ssr","external","appType","server","middlewareMode","payload","wakuDist","url","loadServerModuleMain","idOrFileURL","startsWith","ssrLoadModule","filePath","split","file","root","has","get","transformIndexHtml","pathname","encoder","TextEncoder","decoder","TextDecoder","headSent","TransformStream","transform","Uint8Array","data","decode","replace","reject","result","encode","catch","flush","willBeHandled","transformRequest","code","encodeURI","createRscViteServer","hotUpdateCallback","forEach","dummyServer","privateDir","conditions","externalConditions","noExternal","hmr","loadServerModuleRsc","loadEntriesDev","resolveClientEntry","initialModules","slice","length","moduleNode","rootDir","devServer","options","cmd","_ctx","next","__WAKU_SERVER_IMPORT__","__WAKU_CLIENT_IMPORT__","Set","Map","ctx","all","processedModules","processModule","modulePath","endsWith","resolved","pluginContainer","resolveId","module","moduleGraph","idToModuleMap","Array","from","importedModules","map","importedModule","mainJs","entriesFile","values","flatMap","m","unstable_devServer","req","res","body","status","viteUrl","toString","origin","viteReq","fromWeb","method","headers","readablePromise","viteRes","Object","defineProperty","set","setHeader","name","value","String","getHeader","writeHead","middlewares"],"mappings":"AAAA,SAASA,QAAQ,EAAEC,QAAQ,QAAQ,cAAc;AACjD,SAASC,MAAM,QAAQ,YAAY;AACnC,SAASC,iBAAiB,QAAQ,mBAAmB;AACrD,SAASC,gBAAgBC,gBAAgB,QAAQ,OAAO;AACxD,OAAOC,eAAe,uBAAuB;AAG7C,SAASC,gBAAgB,QAAQ,eAAe;AAChD,SAASC,QAAQ,EAAEC,WAAW,QAAQ,0BAA0B;AAChE,SACEC,0BAA0B,EAC1BC,QAAQ,EACRC,iBAAiB,EACjBC,iBAAiB,QACZ,mBAAmB;AAC1B,SAASC,gBAAgB,QAAQ,0BAA0B;AAC3D,SAASC,iBAAiB,QAAQ,oCAAoC;AACtE,SAASC,kBAAkB,QAAQ,0CAA0C;AAC7E,SAASC,iBAAiB,QAAQ,yCAAyC;AAC3E,SAASC,aAAa,QAAQ,qCAAqC;AACnE,SAASC,kBAAkB,QAAQ,0CAA0C;AAC7E,SAASC,cAAc,QAAQ,sCAAsC;AACrE,SAASC,YAAY,EAAEC,SAAS,QAAQ,oCAAoC;AAE5E,SAASC,YAAY,QAAQ,oCAAoC;AACjE,SAASC,gBAAgB,QAAQ,wCAAwC;AACzE,SAASC,gBAAgB,QAAQ,wCAAwC;AACzE,SAASC,iBAAiB,QAAQ,yCAAyC;AAE3E,SAASC,qBAAqB,QAAQ,8CAA8C;AACpF,SAASC,0BAA0B,QAAQ,6CAA6C;AAExF,uDAAuD;AAEvD,2CAA2C;AAC1CC,WAAmB1B,iBAAiB,GAAGA;AAExC,MAAM2B,mBAAmB;IACvB,IAAIC;IACJ,MAAMC,WAAW,IAAIC,eAAe;QAClCC,OAAMC,CAAC;YACLJ,aAAaI;QACf;QACAC;YACEL,aAAaM;QACf;IACF;IACA,IAAIC;IACJ,MAAMC,UAAU,IAAIC,QAA+B,CAACC,IAAOH,UAAUG;IACrE,IAAIC,UAAU;IACd,MAAMC,WAAW,IAAI1C,SAAS;QAC5B2C,OAAMC,KAAK,EAAEC,QAAQ,EAAEC,QAAQ;YAC7B,IAAID,aAAc,UAAkB;gBAClC,MAAM,IAAIE,MAAM;YAClB;YACA,IAAIjB,YAAY;gBACdA,WAAWkB,OAAO,CAACJ;gBACnB,IAAI,CAACH,SAAS;oBACZA,UAAU;oBACVJ,QAAQN;gBACV;YACF;YACAe;QACF;QACAG,OAAMH,QAAQ;YACZ,IAAIhB,YAAY;gBACdA,WAAWoB,KAAK;gBAChB,IAAI,CAACT,SAAS;oBACZJ,QAAQ;gBACV;YACF;YACAS;QACF;IACF;IACA,OAAO;QAACJ;QAAUJ;KAAQ;AAC5B;AAEA,MAAMa,uBAAuB,CAC3BC,KACAC,eACAC,sBACAC;IAEA,MAAMC,4BAA4B,CAACC,KACjCH,qBAAqBI,GAAG,CAACD;IAE3B,MAAME,cAAcN,cAAcO,IAAI,CAAC,OAAOC;QAC5C,MAAMC,OAAO,MAAM1D,iBACjBS,iBACE;YACE,8FAA8F;YAC9FkD,UAAU;YACVC,MAAMH,OAAOI,QAAQ;YACrBC,SAAS;gBACPpD,kBAAkBT;gBAClBU;gBACAC,kBAAkB;oBAChBmD,QAAQ,CAACC;wBACP,IACEA,GAAGC,QAAQ,CAAC,8CACZD,GAAGC,QAAQ,CAAC,+BACZD,GAAGC,QAAQ,CAAC,yBACZ;4BACA,OAAO;wBACT;oBACF;gBACF;gBACApD;gBACAK,aAAa;oBAAEgD,OAAO;oBAAMlB;oBAAKS;gBAAO;gBACxCtC,iBAAiBsC;gBACjBrC,iBAAiBqC;gBACjB1C,eAAe0C;gBACf3C,mBAAmB;oBAAEqD,UAAU;oBAAMC,SAAS;gBAAM;gBACpDpD;gBACAM,sBAAsBmC;gBACtBlC;aACD;YACD8C,cAAc;gBACZC,SAAS;oBAAC;oBAAmC;iBAAmB;gBAChEC,SAAS;oBAAC;oBAAQ;iBAAyB;gBAC3CC,SAAS;oBACP,GAAGf,OAAOgB,MAAM,CAAC,CAAC,EAAErE,YAAY,EAAE,CAAC;oBACnC,0BAA0B;oBAC1B,GAAGqD,OAAOgB,MAAM,CAAC,aAAa,CAAC;iBAChC;YACH;YACAC,KAAK;gBACHC,UAAU;oBAAC;iBAAO;gBAClBN,cAAc;oBACZC,SAAS;wBAAC;qBAAuC;gBACnD;YACF;YACAM,SAAS;YACTC,QAAQ;gBAAEC,gBAAgB;YAAK;QACjC,GACArB,QACA;QAGJL,0BAA0B,CAAC2B,UAAY9D,UAAUyC,MAAMqB;QACvD,OAAOrB;IACT;IAEA,MAAMsB,WAAW3E,2BACfC,SAASC,kBAAkB,YAAY0E,GAAG,GAAG;IAG/C,sCAAsC;IACtC,MAAMC,uBAAuB,OAAOC;QAClC,MAAMzB,OAAO,MAAMH;QACnB,IAAI,CAAC4B,YAAYC,UAAU,CAAC,YAAY;YACtC,IAAID,gBAAgB,UAAUA,YAAYC,UAAU,CAAC,UAAU;gBAC7D,gDAAgD;gBAChD,OAAO,MAAM,CAAC,gBAAgB,GAAGD;YACnC;YACA,OAAOzB,KAAK2B,aAAa,CAACF;QAC5B;QACA,MAAMG,WAAW/E,kBAAkB4E,YAAYI,KAAK,CAAC,IAAI,CAAC,EAAE;QAC5D,MAAMC,OAAOF,SAASF,UAAU,CAAC,OAC7BE,WACAhF,SAASoD,KAAKD,MAAM,CAACgC,IAAI,EAAEH;QAC/B,IAAIjF,2BAA2BmF,MAAMJ,UAAU,CAACJ,WAAW;YACzD,gDAAgD;YAChD,OAAO,MAAM,CAAC,gBAAgB,GAAGxE,kBAAkBgF;QACrD;QACA;YACE,IAAIxB,KAAKwB;YACT,MAAOrC,YAAYuC,GAAG,CAAC1B,IAAK;gBAC1BA,KAAKb,YAAYwC,GAAG,CAAC3B;YACvB;YACA,IAAI,CAACA,GAAGoB,UAAU,CAAC,MAAM;gBACvB,OAAO1B,KAAK2B,aAAa,CAACrB;YAC5B;QACF;QACA,IAAIwB,KAAKvB,QAAQ,CAAC,mBAAmB;YACnC,2CAA2C;YAC3C,OAAO,MAAM,CAAC,gBAAgB,GAAGzD,kBAAkBgF;QACrD;QACA,OAAO9B,KAAK2B,aAAa,CAAC9E,kBAAkB4E;IAC9C;IAEA,MAAMS,qBAAqB,OAAOC;QAChC,MAAMnC,OAAO,MAAMH;QACnB,MAAMuC,UAAU,IAAIC;QACpB,MAAMC,UAAU,IAAIC;QACpB,IAAIC,WAAW;QACf,OAAO,IAAIC,gBAAgB;YACzBC,WAAU5D,KAAK,EAAEd,UAAU;gBACzB,IAAI,CAAEc,CAAAA,iBAAiB6D,UAAS,GAAI;oBAClC,MAAM,IAAI1D,MAAM;gBAClB;gBACA,IAAI,CAACuD,UAAU;oBACbA,WAAW;oBACX,IAAII,OAAON,QAAQO,MAAM,CAAC/D;oBAC1B,kDAAkD;oBAClD,kDAAkD;oBAClD8D,OAAOA,KAAKE,OAAO,CAAC,gCAAgC;oBACpD,OAAO,IAAIrE,QAAc,CAACF,SAASwE;wBACjC/C,KACGkC,kBAAkB,CAACC,UAAUS,MAC7B9C,IAAI,CAAC,CAACkD;4BACLhF,WAAWkB,OAAO,CAACkD,QAAQa,MAAM,CAACD;4BAClCzE;wBACF,GACC2E,KAAK,CAACH;oBACX;gBACF;gBACA/E,WAAWkB,OAAO,CAACJ;YACrB;YACAqE;gBACE,IAAI,CAACX,UAAU;oBACb,MAAM,IAAIvD,MAAM;gBAClB;YACF;QACF;IACF;IAEA,wCAAwC;IACxC,MAAMmE,gBAAgB,OAAOjB;QAC3B,MAAMnC,OAAO,MAAMH;QACnB,IAAI;YACF,MAAMmD,SAAS,MAAMhD,KAAKqD,gBAAgB,CAAClB;YAC3C,IAAIa,QAAQM,SAAS,CAAC,oBAAoB,EAAEC,UAAUpB,UAAU,CAAC,CAAC,EAAE;gBAClE,OAAO;YACT;YACA,OAAO,CAAC,CAACa;QACX,EAAE,OAAM;YACN,OAAO;QACT;IACF;IAEA,OAAO;QACLnD;QACA2B;QACAU;QACAkB;IACF;AACF;AAEA,MAAMI,sBAAsB,CAC1BlE,KACAC,eACAC,sBACAC;IAEA,MAAMgE,oBAAoB,CAACpC,UACzB7B,qBAAqBkE,OAAO,CAAC,CAAC/D,KAAOA,GAAG0B;IAC1C,MAAMsC,cAAc,IAAIxH,UAAU,mCAAmC;IAErE,MAAM0D,cAAcN,cAAcO,IAAI,CAAC,OAAOC;QAC5C,MAAMC,OAAO,MAAM1D,iBACjBS,iBACE;YACE,8FAA8F;YAC9FkD,UAAU;YACVG,SAAS;gBACP7D;gBACAU;gBACAC,kBAAkB,CAAC;gBACnBC;gBACAK,aAAa;oBAAEgD,OAAO;oBAAMlB;gBAAI;gBAChC7B,iBAAiB;oBACfmG,YAAY7D,OAAO6D,UAAU;oBAC7BH;gBACF;gBACA/F,iBAAiBqC;gBACjB3C,mBAAmB;oBACjBqD,UAAU;oBACVC,SAAS;oBACTjB;gBACF;gBACA9B,kBAAkB8F;gBAClB5F;aACD;YACD8C,cAAc;gBACZC,SAAS;oBAAC;oBAAmC;iBAAmB;gBAChEC,SAAS;oBAAC;iBAAO;gBACjBC,SAAS;oBACP,GAAGf,OAAOgB,MAAM,CAAC,CAAC,EAAErE,YAAY,EAAE,CAAC;oBACnC,0BAA0B;oBAC1B,GAAGqD,OAAOgB,MAAM,CAAC,aAAa,CAAC;iBAChC;YACH;YACAC,KAAK;gBACHzC,SAAS;oBACPsF,YAAY;wBAAC;qBAAe;oBAC5BC,oBAAoB;wBAAC;qBAAe;gBACtC;gBACAC,YAAY;gBACZpD,cAAc;oBACZC,SAAS;wBACP;wBACA;wBACA;wBACA;wBACA;qBACD;oBACDC,SAAS;wBAAC;qBAAO;gBACnB;YACF;YACAK,SAAS;YACTC,QAAQ;gBAAEC,gBAAgB;gBAAM4C,KAAK;oBAAE7C,QAAQwC;gBAAY;YAAE;QAC/D,GACA5D,QACA;QAGJ,OAAOC;IACT;IAEA,MAAMiE,sBAAsB,OAAOxC;QACjC,MAAMzB,OAAO,MAAMH;QACnB,OAAOG,KAAK2B,aAAa,CACvBF,YAAYC,UAAU,CAAC,aACnB7E,kBAAkB4E,eAClBA;IAER;IAEA,MAAMyC,iBAAiB,OAAOnE;QAC5B,MAAMC,OAAO,MAAMH;QACnB,MAAM+B,WAAWhF,SAASoD,KAAKD,MAAM,CAACgC,IAAI,EAAEhC,OAAOgB,MAAM,EAAErE;QAC3D,OAAOsD,KAAK2B,aAAa,CAACC;IAC5B;IAEA,MAAMuC,qBAAqB,CACzB7D,IACAP,QACAqE;QAEA,IAAItC,OAAOxB;QACX,IAAIwB,KAAKJ,UAAU,CAAC,UAAU;YAC5BI,OAAOA,KAAKuC,KAAK,CAAC,OAAOC,MAAM,GAAG,4BAA4B;QAChE;QACA,KAAK,MAAMC,cAAcH,eAAgB;YACvC,IAAIG,WAAWzC,IAAI,KAAKA,MAAM;gBAC5B,OAAOyC,WAAWhD,GAAG;YACvB;QACF;QACA,IAAIO,KAAKJ,UAAU,CAAC3B,OAAOyE,OAAO,GAAG;YACnC1C,OAAOA,KAAKuC,KAAK,CAACtE,OAAOyE,OAAO,CAACF,MAAM,GAAG,IAAI,sBAAsB;QACtE,OAAO,IAAIxC,KAAKJ,UAAU,CAAC,MAAM;YAC/BI,OAAO,QAAQA;QACjB,OAAO;YACLA,OAAO,SAASA;QAClB;QACA,OAAO/B,OAAOI,QAAQ,GAAG2B;IAC3B;IAEA,OAAO;QACLmC;QACAC;QACAC;IACF;AACF;AAEA,OAAO,MAAMM,YAAwB,CAACC;IACpC,IAAIA,QAAQC,GAAG,KAAK,OAAO;QACzB,kCAAkC;QAClC,OAAO,CAACC,MAAMC,OAASA;IACzB;IAEA,MAAMvF,MAAMoF,QAAQpF,GAAG;IACvB,MAAMC,gBAAgB/C,iBAAiBkI,QAAQ3E,MAAM;IAEpDjC,WAAmBgH,sBAAsB,GAAG,CAACxE,KAC5C2D,oBAAoB3D;IAErBxC,WAAmBiH,sBAAsB,GAAG,CAACzE,KAC5CkB,qBAAqBlB;IAEvB,MAAMd,uBAAuB,IAAIwF;IACjC,MAAMvF,cAAc,IAAIwF;IAExB,MAAM,EACJpF,WAAW,EACX2B,oBAAoB,EACpBU,kBAAkB,EAClBkB,aAAa,EACd,GAAG/D,qBACFC,KACAC,eACAC,sBACAC;IAGF,MAAM,EAAEwE,mBAAmB,EAAEC,cAAc,EAAEC,kBAAkB,EAAE,GAC/DX,oBAAoBlE,KAAKC,eAAeC,sBAAsBC;IAEhE,IAAI2E;IAEJ,OAAO,OAAOc,KAAKL;QACjB,MAAM,CAAC9E,QAAQC,KAAK,GAAG,MAAMvB,QAAQ0G,GAAG,CAAC;YAAC5F;YAAeM;SAAY;QAErE,IAAI,CAACuE,gBAAgB;YACnB,MAAMgB,mBAAmB,IAAIJ;YAE7B,MAAMK,gBAAgB,OAAOC;gBAC3B,IAAIA,WAAWC,QAAQ,CAAC,SAAS;oBAC/B,mCAAmC;oBACnC;gBACF;gBACA,IAAIH,iBAAiBpD,GAAG,CAACsD,aAAa;oBACpC;gBACF;gBACAF,iBAAiBxF,GAAG,CAAC0F;gBAErB,MAAMtF,KAAKqD,gBAAgB,CAACiC;gBAC5B,MAAME,WAAW,MAAMxF,KAAKyF,eAAe,CAACC,SAAS,CAACJ;gBACtD,IAAI,CAACE,UAAU;oBACb;gBACF;gBAEA,MAAMG,SAAS3F,KAAK4F,WAAW,CAACC,aAAa,CAAC5D,GAAG,CAACuD,SAASlF,EAAE;gBAC7D,IAAI,CAACqF,QAAQ;oBACX;gBACF;gBAEA,MAAMlH,QAAQ0G,GAAG,CACfW,MAAMC,IAAI,CAACJ,OAAOK,eAAe,EAAEC,GAAG,CAAC,OAAOC;oBAC5C,IAAIA,eAAe5F,EAAE,EAAE;wBACrB,MAAM+E,cAAca,eAAe5F,EAAE;oBACvC;gBACF;YAEJ;YAEA,MAAM6F,SAAS,GAAGpG,OAAOI,QAAQ,GAAGJ,OAAOgB,MAAM,CAAC,CAAC,EAAEtE,UAAU;YAC/D,MAAM2J,cAAc,GAAGpG,KAAKD,MAAM,CAACgC,IAAI,GAAGhC,OAAOI,QAAQ,GAAGJ,OAAOgB,MAAM,CAAC,CAAC,EAAErE,aAAa;YAE1F,MAAM2I,cAAcc;YACpB,MAAMd,cAAce;YAEpBhC,iBAAiB0B,MAAMC,IAAI,CACzB/F,KAAK4F,WAAW,CAACC,aAAa,CAACQ,MAAM,IACrCC,OAAO,CAAC,CAACC,IAAOA,EAAEzE,IAAI,GAAG;oBAAC;wBAAEP,KAAKgF,EAAEhF,GAAG;wBAAEO,MAAMyE,EAAEzE,IAAI;oBAAC;iBAAE,GAAG,EAAE;QAChE;QAEAoD,IAAIsB,kBAAkB,GAAG;YACvBhC,SAASxE,KAAKD,MAAM,CAACgC,IAAI;YACzBoC,oBAAoB,CAAC7D,KACnB6D,mBACE7D,IACA;oBACEkE,SAASxE,KAAKD,MAAM,CAACgC,IAAI;oBACzB5B,UAAUJ,OAAOI,QAAQ;gBAC3B,GACAiE;YAEJH;YACAC;YACA1C;YACAU;QACF;QAEA,IAAI,CAAE,MAAMkB,cAAc8B,IAAIuB,GAAG,CAAClF,GAAG,CAACY,QAAQ,GAAI;YAChD,MAAM0C;YACN,IAAIK,IAAIwB,GAAG,CAACC,IAAI,IAAIzB,IAAIwB,GAAG,CAACE,MAAM,EAAE;gBAClC;YACF;QACF;QAEA,MAAMC,UAAU3B,IAAIuB,GAAG,CAAClF,GAAG,CAACuF,QAAQ,GAAGzC,KAAK,CAACa,IAAIuB,GAAG,CAAClF,GAAG,CAACwF,MAAM,CAACzC,MAAM;QACtE,MAAM0C,UAAe9B,IAAIuB,GAAG,CAACE,IAAI,GAC7B1K,SAASgL,OAAO,CAAC/B,IAAIuB,GAAG,CAACE,IAAI,IAC7B1K,SAAS8J,IAAI,CAAC,EAAE;QACpBiB,QAAQE,MAAM,GAAGhC,IAAIuB,GAAG,CAACS,MAAM;QAC/BF,QAAQzF,GAAG,GAAGsF;QACdG,QAAQG,OAAO,GAAGjC,IAAIuB,GAAG,CAACU,OAAO;QACjC,MAAM,CAACvI,UAAUwI,gBAAgB,GAAGrJ;QACpC,MAAMsJ,UAAezI;QACrB0I,OAAOC,cAAc,CAACF,SAAS,cAAc;YAC3CG,KAAIlE,IAAI;gBACN4B,IAAIwB,GAAG,CAACE,MAAM,GAAGtD;YACnB;QACF;QACA,MAAM6D,UAAU,IAAIlC;QACpBoC,QAAQI,SAAS,GAAG,CAACC,MAAcC;YACjCR,QAAQK,GAAG,CAACE,MAAMC;YAClBzC,IAAIwB,GAAG,CAACS,OAAO,GAAG;gBAChB,GAAGjC,IAAIwB,GAAG,CAACS,OAAO;gBAClB,CAACO,KAAK,EAAEE,OAAOD;YACjB;QACF;QACAN,QAAQQ,SAAS,GAAG,CAACH,OAAiBP,QAAQlF,GAAG,CAACyF;QAClDL,QAAQS,SAAS,GAAG,CAACxE,MAAc6D;YACjCjC,IAAIwB,GAAG,CAACE,MAAM,GAAGtD;YACjB,KAAK,MAAM,CAACoE,MAAMC,MAAM,IAAIL,OAAOxG,OAAO,CAACqG,WAAW,CAAC,GAAI;gBACzDE,QAAQI,SAAS,CAACC,MAAMC;YAC1B;QACF;QACA3H,KAAK+H,WAAW,CAACf,SAASK;QAC1B,MAAMV,OAAO,MAAMS;QACnB,IAAIT,MAAM;YACRzB,IAAIwB,GAAG,CAACC,IAAI,GAAGA;QACjB,OAAO,IAAIzB,IAAIwB,GAAG,CAACE,MAAM,KAAK,KAAK;YACjC,OAAO1B,IAAIwB,GAAG,CAACE,MAAM;QACvB;IACF;AACF,EAAE"}