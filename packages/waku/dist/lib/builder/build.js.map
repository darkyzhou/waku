{"version":3,"sources":["../../../src/lib/builder/build.ts"],"sourcesContent":["import { Readable } from 'node:stream';\nimport { pipeline } from 'node:stream/promises';\n\nimport { build as buildVite, resolveConfig as resolveViteConfig } from 'vite';\nimport viteReact from '@vitejs/plugin-react';\nimport type { LoggingFunction, RollupLog } from 'rollup';\nimport type { ReactNode } from 'react';\n\nimport type { Config } from '../../config.js';\nimport { INTERNAL_setAllEnv, unstable_getBuildOptions } from '../../server.js';\nimport type { EntriesPrd } from '../types.js';\nimport type { ConfigDev } from '../config.js';\nimport { resolveConfigDev } from '../config.js';\nimport type { PathSpec } from '../utils/path.js';\nimport {\n  decodeFilePathFromAbsolute,\n  extname,\n  filePathToFileURL,\n  fileURLToFilePath,\n  joinPath,\n} from '../utils/path.js';\nimport { extendViteConfig } from '../utils/vite-config.js';\nimport {\n  copyFile,\n  createWriteStream,\n  existsSync,\n  mkdir,\n  readdir,\n  readFile,\n  unlink,\n  writeFile,\n} from '../utils/node-fs.js';\nimport { encodeRscPath, generatePrefetchCode } from '../renderers/utils.js';\nimport { collectClientModules, renderRsc } from '../renderers/rsc.js';\nimport { renderHtml } from '../renderers/html.js';\nimport {\n  SERVER_MODULE_MAP,\n  CLIENT_MODULE_MAP,\n  CLIENT_PREFIX,\n} from '../middleware/handler.js';\nimport { rscRsdwPlugin } from '../plugins/vite-plugin-rsc-rsdw.js';\nimport { rscIndexPlugin } from '../plugins/vite-plugin-rsc-index.js';\nimport { rscAnalyzePlugin } from '../plugins/vite-plugin-rsc-analyze.js';\nimport { nonjsResolvePlugin } from '../plugins/vite-plugin-nonjs-resolve.js';\nimport { rscTransformPlugin } from '../plugins/vite-plugin-rsc-transform.js';\nimport { rscEntriesPlugin } from '../plugins/vite-plugin-rsc-entries.js';\nimport { rscEnvPlugin } from '../plugins/vite-plugin-rsc-env.js';\nimport { rscPrivatePlugin } from '../plugins/vite-plugin-rsc-private.js';\nimport { rscManagedPlugin } from '../plugins/vite-plugin-rsc-managed.js';\nimport {\n  EXTENSIONS,\n  DIST_ENTRIES_JS,\n  DIST_PUBLIC,\n  DIST_ASSETS,\n  DIST_SSR,\n} from './constants.js';\nimport { deployVercelPlugin } from '../plugins/vite-plugin-deploy-vercel.js';\nimport { deployNetlifyPlugin } from '../plugins/vite-plugin-deploy-netlify.js';\nimport { deployCloudflarePlugin } from '../plugins/vite-plugin-deploy-cloudflare.js';\nimport { deployDenoPlugin } from '../plugins/vite-plugin-deploy-deno.js';\nimport { deployPartykitPlugin } from '../plugins/vite-plugin-deploy-partykit.js';\nimport { deployAwsLambdaPlugin } from '../plugins/vite-plugin-deploy-aws-lambda.js';\nimport { deployTxikiPlugin } from '../plugins/vite-plugin-deploy-txiki.js';\nimport { emitPlatformData } from './platform-data.js';\n\n// TODO this file and functions in it are too long. will fix.\n\n// Upstream issue: https://github.com/rollup/rollup/issues/4699\nconst onwarn = (warning: RollupLog, defaultHandler: LoggingFunction) => {\n  if (\n    warning.code === 'MODULE_LEVEL_DIRECTIVE' &&\n    /\"use (client|server)\"/.test(warning.message)\n  ) {\n    return;\n  } else if (\n    warning.code === 'SOURCEMAP_ERROR' &&\n    warning.loc?.column === 0 &&\n    warning.loc?.line === 1\n  ) {\n    return;\n  }\n  defaultHandler(warning);\n};\n\nconst deployPlugins = (config: ConfigDev) => [\n  deployVercelPlugin(config),\n  deployNetlifyPlugin(config),\n  deployCloudflarePlugin(config),\n  deployDenoPlugin(config),\n  deployPartykitPlugin(config),\n  deployAwsLambdaPlugin(config),\n  deployTxikiPlugin(config),\n];\n\nconst analyzeEntries = async (rootDir: string, config: ConfigDev) => {\n  const wakuClientDist = decodeFilePathFromAbsolute(\n    joinPath(fileURLToFilePath(import.meta.url), '../../../client.js'),\n  );\n  const wakuMinimalClientDist = decodeFilePathFromAbsolute(\n    joinPath(fileURLToFilePath(import.meta.url), '../../../minimal/client.js'),\n  );\n  const clientFileMap = new Map<string, string>([\n    // FIXME 'lib' should be the real hash\n    [wakuClientDist, 'lib'],\n    [wakuMinimalClientDist, 'lib'],\n  ]);\n  const serverFileMap = new Map<string, string>();\n  const moduleFileMap = new Map<string, string>(); // module id -> full path\n  const pagesDirPath = joinPath(rootDir, config.srcDir, config.pagesDir);\n  if (existsSync(pagesDirPath)) {\n    const files = await readdir(pagesDirPath, {\n      encoding: 'utf8',\n      recursive: true,\n    });\n    for (const file of files) {\n      const ext = extname(file);\n      if (EXTENSIONS.includes(ext)) {\n        moduleFileMap.set(\n          joinPath(config.pagesDir, file.slice(0, -ext.length)),\n          joinPath(pagesDirPath, file),\n        );\n      }\n    }\n  }\n  await buildVite(\n    extendViteConfig(\n      {\n        mode: 'production',\n        plugins: [\n          rscAnalyzePlugin({\n            isClient: false,\n            clientFileMap,\n            serverFileMap,\n          }),\n          rscManagedPlugin({ ...config, addEntriesToInput: true }),\n          ...deployPlugins(config),\n        ],\n        ssr: {\n          target: 'webworker',\n          resolve: {\n            conditions: ['react-server'],\n            externalConditions: ['react-server'],\n          },\n          noExternal: /^(?!node:)/,\n        },\n        build: {\n          write: false,\n          ssr: true,\n          target: 'node18',\n          rollupOptions: {\n            onwarn,\n            input: Object.fromEntries(moduleFileMap),\n          },\n        },\n      },\n      config,\n      'build-analyze',\n    ),\n  );\n  let clientEntryFiles = Object.fromEntries(\n    Array.from(clientFileMap).map(([fname, hash], i) => [\n      `${DIST_ASSETS}/rsc${i}-${hash}`,\n      fname,\n    ]),\n  );\n  await buildVite(\n    extendViteConfig(\n      {\n        mode: 'production',\n        plugins: [\n          rscAnalyzePlugin({ isClient: true, clientFileMap, serverFileMap }),\n          rscManagedPlugin({ ...config, addMainToInput: true }),\n          ...deployPlugins(config),\n        ],\n        ssr: {\n          target: 'webworker',\n          noExternal: /^(?!node:)/,\n        },\n        build: {\n          write: false,\n          ssr: true,\n          target: 'node18',\n          rollupOptions: {\n            onwarn,\n            input: clientEntryFiles,\n          },\n        },\n      },\n      config,\n      'build-analyze',\n    ),\n  );\n  clientEntryFiles = Object.fromEntries(\n    Array.from(clientFileMap).map(([fname, hash], i) => [\n      `${DIST_ASSETS}/rsc${i}-${hash}`,\n      fname,\n    ]),\n  );\n  const serverEntryFiles = Object.fromEntries(\n    Array.from(serverFileMap).map(([fname, hash], i) => [\n      `${DIST_ASSETS}/rsf${i}-${hash}`,\n      fname,\n    ]),\n  );\n  const serverModuleFiles = Object.fromEntries(moduleFileMap);\n  return {\n    clientEntryFiles,\n    serverEntryFiles,\n    serverModuleFiles,\n  };\n};\n\n// For RSC\nconst buildServerBundle = async (\n  rootDir: string,\n  env: Record<string, string>,\n  config: ConfigDev,\n  clientEntryFiles: Record<string, string>,\n  serverEntryFiles: Record<string, string>,\n  serverModuleFiles: Record<string, string>,\n  partial: boolean,\n) => {\n  const serverBuildOutput = await buildVite(\n    extendViteConfig(\n      {\n        mode: 'production',\n        plugins: [\n          nonjsResolvePlugin(),\n          rscTransformPlugin({\n            isClient: false,\n            isBuild: true,\n            clientEntryFiles,\n            serverEntryFiles,\n          }),\n          rscRsdwPlugin(),\n          rscEnvPlugin({ isDev: false, env, config }),\n          rscPrivatePlugin(config),\n          rscManagedPlugin({\n            ...config,\n            addEntriesToInput: true,\n          }),\n          rscEntriesPlugin({\n            basePath: config.basePath,\n            rscBase: config.rscBase,\n            srcDir: config.srcDir,\n            ssrDir: DIST_SSR,\n            moduleMap: {\n              ...Object.fromEntries(\n                Object.keys(SERVER_MODULE_MAP).map((key) => [\n                  key,\n                  `./${key}.js`,\n                ]),\n              ),\n              ...Object.fromEntries(\n                Object.keys(CLIENT_MODULE_MAP).map((key) => [\n                  `${CLIENT_PREFIX}${key}`,\n                  `./${DIST_SSR}/${key}.js`,\n                ]),\n              ),\n              ...Object.fromEntries(\n                Object.keys(clientEntryFiles || {}).map((key) => [\n                  `${DIST_SSR}/${key}.js`,\n                  `./${DIST_SSR}/${key}.js`,\n                ]),\n              ),\n              ...Object.fromEntries(\n                Object.keys(serverEntryFiles || {}).map((key) => [\n                  `${key}.js`,\n                  `./${key}.js`,\n                ]),\n              ),\n            },\n          }),\n          ...deployPlugins(config),\n        ],\n        ssr: {\n          resolve: {\n            conditions: ['react-server'],\n            externalConditions: ['react-server'],\n          },\n          noExternal: /^(?!node:)/,\n        },\n        esbuild: {\n          jsx: 'automatic',\n        },\n        define: {\n          'process.env.NODE_ENV': JSON.stringify('production'),\n        },\n        publicDir: false,\n        build: {\n          emptyOutDir: !partial,\n          ssr: true,\n          ssrEmitAssets: true,\n          target: 'node18',\n          outDir: joinPath(rootDir, config.distDir),\n          rollupOptions: {\n            onwarn,\n            input: {\n              ...SERVER_MODULE_MAP,\n              ...serverModuleFiles,\n              ...clientEntryFiles,\n              ...serverEntryFiles,\n            },\n          },\n        },\n      },\n      config,\n      'build-server',\n    ),\n  );\n  if (!('output' in serverBuildOutput)) {\n    throw new Error('Unexpected vite server build output');\n  }\n  return serverBuildOutput;\n};\n\n// For SSR (render client components on server to generate HTML)\nconst buildSsrBundle = async (\n  rootDir: string,\n  env: Record<string, string>,\n  config: ConfigDev,\n  clientEntryFiles: Record<string, string>,\n  serverEntryFiles: Record<string, string>,\n  serverBuildOutput: Awaited<ReturnType<typeof buildServerBundle>>,\n  partial: boolean,\n) => {\n  const cssAssets = serverBuildOutput.output.flatMap(({ type, fileName }) =>\n    type === 'asset' && fileName.endsWith('.css') ? [fileName] : [],\n  );\n  await buildVite(\n    extendViteConfig(\n      {\n        mode: 'production',\n        base: config.basePath,\n        plugins: [\n          rscRsdwPlugin(),\n          rscIndexPlugin({ ...config, cssAssets }),\n          rscEnvPlugin({ isDev: false, env, config }),\n          rscPrivatePlugin(config),\n          rscManagedPlugin({ ...config, addMainToInput: true }),\n          rscTransformPlugin({\n            isClient: true,\n            isBuild: true,\n            serverEntryFiles,\n          }),\n          ...deployPlugins(config),\n        ],\n        ssr: {\n          noExternal: /^(?!node:)/,\n        },\n        esbuild: {\n          jsx: 'automatic',\n        },\n        define: {\n          'process.env.NODE_ENV': JSON.stringify('production'),\n        },\n        publicDir: false,\n        build: {\n          emptyOutDir: !partial,\n          ssr: true,\n          target: 'node18',\n          outDir: joinPath(rootDir, config.distDir, DIST_SSR),\n          rollupOptions: {\n            onwarn,\n            input: {\n              ...clientEntryFiles,\n              ...CLIENT_MODULE_MAP,\n            },\n            output: {\n              entryFileNames: (chunkInfo: { name: string }) => {\n                if (\n                  CLIENT_MODULE_MAP[\n                    chunkInfo.name as keyof typeof CLIENT_MODULE_MAP\n                  ] ||\n                  clientEntryFiles[chunkInfo.name]\n                ) {\n                  return '[name].js';\n                }\n                return DIST_ASSETS + '/[name]-[hash].js';\n              },\n            },\n          },\n        },\n      },\n      config,\n      'build-ssr',\n    ),\n  );\n};\n\n// For Browsers\nconst buildClientBundle = async (\n  rootDir: string,\n  env: Record<string, string>,\n  config: ConfigDev,\n  clientEntryFiles: Record<string, string>,\n  serverEntryFiles: Record<string, string>,\n  serverBuildOutput: Awaited<ReturnType<typeof buildServerBundle>>,\n  partial: boolean,\n) => {\n  const nonJsAssets = serverBuildOutput.output.flatMap(({ type, fileName }) =>\n    type === 'asset' && !fileName.endsWith('.js') ? [fileName] : [],\n  );\n  const cssAssets = nonJsAssets.filter((asset) => asset.endsWith('.css'));\n  const clientBuildOutput = await buildVite(\n    extendViteConfig(\n      {\n        mode: 'production',\n        base: config.basePath,\n        plugins: [\n          viteReact(),\n          rscRsdwPlugin(),\n          rscIndexPlugin({ ...config, cssAssets }),\n          rscEnvPlugin({ isDev: false, env, config }),\n          rscPrivatePlugin(config),\n          rscManagedPlugin({ ...config, addMainToInput: true }),\n          rscTransformPlugin({\n            isClient: true,\n            isBuild: true,\n            serverEntryFiles,\n          }),\n          ...deployPlugins(config),\n        ],\n        build: {\n          emptyOutDir: !partial,\n          outDir: joinPath(rootDir, config.distDir, DIST_PUBLIC),\n          rollupOptions: {\n            onwarn,\n            // rollup will ouput the style files related to clientEntryFiles, but since it does not find any link to them in the index.html file, it will not inject them. They are only mentioned by the standalone `clientEntryFiles`\n            input: clientEntryFiles,\n            preserveEntrySignatures: 'exports-only',\n            output: {\n              entryFileNames: (chunkInfo: { name: string }) => {\n                if (clientEntryFiles[chunkInfo.name]) {\n                  return '[name].js';\n                }\n                return DIST_ASSETS + '/[name]-[hash].js';\n              },\n            },\n          },\n        },\n      },\n      config,\n      'build-client',\n    ),\n  );\n  if (!('output' in clientBuildOutput)) {\n    throw new Error('Unexpected vite client build output');\n  }\n  for (const nonJsAsset of nonJsAssets) {\n    const from = joinPath(rootDir, config.distDir, nonJsAsset);\n    const to = joinPath(rootDir, config.distDir, DIST_PUBLIC, nonJsAsset);\n    await copyFile(from, to);\n  }\n  return clientBuildOutput;\n};\n\n// TODO: Add progress indication for static builds.\n\nconst createTaskRunner = (limit: number) => {\n  let running = 0;\n  const waiting: (() => void)[] = [];\n  const errors: unknown[] = [];\n  const scheduleTask = async (task: () => Promise<void>) => {\n    if (running >= limit) {\n      await new Promise<void>((resolve) => waiting.push(resolve));\n    }\n    running++;\n    try {\n      await task();\n    } catch (err) {\n      errors.push(err);\n    } finally {\n      running--;\n      waiting.shift()?.();\n    }\n  };\n  const runTask = (task: () => Promise<void>) => {\n    scheduleTask(task).catch(() => {});\n  };\n  const waitForTasks = async () => {\n    if (running > 0) {\n      await new Promise<void>((resolve) => waiting.push(resolve));\n      await waitForTasks();\n    }\n    if (errors.length > 0) {\n      console.error('Errors occurred during running tasks:', errors);\n      throw errors[0];\n    }\n  };\n  return { runTask, waitForTasks };\n};\nconst WRITE_FILE_BATCH_SIZE = 2500;\nconst { runTask, waitForTasks } = createTaskRunner(WRITE_FILE_BATCH_SIZE);\n\nconst emitStaticFile = (\n  rootDir: string,\n  config: ConfigDev,\n  pathname: string,\n  body: Promise<ReadableStream> | string,\n) => {\n  const destFile = joinPath(\n    rootDir,\n    config.distDir,\n    DIST_PUBLIC,\n    extname(pathname)\n      ? pathname\n      : pathname === '/404'\n        ? '404.html' // HACK special treatment for 404, better way?\n        : pathname + '/index.html',\n  );\n  // In partial mode, skip if the file already exists.\n  if (existsSync(destFile)) {\n    return;\n  }\n  runTask(async () => {\n    await mkdir(joinPath(destFile, '..'), { recursive: true });\n    if (typeof body === 'string') {\n      await writeFile(destFile, body);\n    } else {\n      await pipeline(\n        Readable.fromWeb((await body) as never),\n        createWriteStream(destFile),\n      );\n    }\n  });\n};\n\nconst emitStaticFiles = async (\n  rootDir: string,\n  config: ConfigDev,\n  distEntriesFile: string,\n  distEntries: EntriesPrd,\n  cssAssets: string[],\n) => {\n  const unstable_modules = {\n    rsdwServer: await distEntries.loadModule('rsdw-server'),\n    rdServer: await distEntries.loadModule(CLIENT_PREFIX + 'rd-server'),\n    rsdwClient: await distEntries.loadModule(CLIENT_PREFIX + 'rsdw-client'),\n    wakuMinimalClient: await distEntries.loadModule(\n      CLIENT_PREFIX + 'waku-minimal-client',\n    ),\n  };\n  const publicIndexHtmlFile = joinPath(\n    rootDir,\n    config.distDir,\n    DIST_PUBLIC,\n    'index.html',\n  );\n  const publicIndexHtml = await readFile(publicIndexHtmlFile, {\n    encoding: 'utf8',\n  });\n  const publicIndexHtmlHead = publicIndexHtml.replace(\n    /.*?<head>(.*?)<\\/head>.*/s,\n    '$1',\n  );\n  const cssStr = cssAssets\n    .map((asset) => `<link rel=\"stylesheet\" href=\"${config.basePath}${asset}\">`)\n    .join('\\n');\n  const defaultHtmlStr = publicIndexHtml\n    // HACK is this too naive to inject style code?\n    .replace(/<\\/head>/, cssStr + '</head>');\n  const defaultHtmlHead = publicIndexHtmlHead + cssStr;\n  const baseRscPrefix = config.basePath + config.rscBase + '/';\n  const utils = {\n    renderRsc: (\n      elements: Record<string, unknown>,\n      options?: {\n        moduleIdCallback?: (id: string) => void;\n      },\n    ) =>\n      renderRsc(\n        config,\n        { unstable_modules },\n        elements,\n        new Set(),\n        options?.moduleIdCallback,\n      ),\n    renderHtml: async (\n      elements: Record<string, unknown>,\n      html: ReactNode,\n      options: { rscPath: string; htmlHead?: string },\n    ) => {\n      const body = await renderHtml(\n        config,\n        { unstable_modules },\n        defaultHtmlHead + (options.htmlHead || ''),\n        elements,\n        new Set(),\n        html,\n        options.rscPath,\n      );\n      const headers = { 'content-type': 'text/html; charset=utf-8' };\n      return { body, headers };\n    },\n    rscPath2pathname: (rscPath: string) =>\n      joinPath(config.rscBase, encodeRscPath(rscPath)),\n    unstable_generatePrefetchCode: (\n      rscPaths: Iterable<string>,\n      moduleIds: Iterable<string>,\n    ) => generatePrefetchCode(baseRscPrefix, rscPaths, moduleIds),\n    unstable_collectClientModules: (elements: Record<string, unknown>) =>\n      collectClientModules(\n        config,\n        unstable_modules.rsdwServer as never,\n        elements,\n      ),\n  };\n  const dynamicHtmlPathMap = new Map<PathSpec, string>();\n  const buildConfigs = distEntries.default.handleBuild(utils);\n  if (buildConfigs) {\n    await unlink(publicIndexHtmlFile);\n  }\n  for await (const buildConfig of buildConfigs || []) {\n    switch (buildConfig.type) {\n      case 'file':\n        emitStaticFile(rootDir, config, buildConfig.pathname, buildConfig.body);\n        break;\n      case 'htmlHead':\n        dynamicHtmlPathMap.set(\n          buildConfig.pathSpec,\n          defaultHtmlHead + (buildConfig.head || ''),\n        );\n        break;\n      case 'defaultHtml':\n        emitStaticFile(\n          rootDir,\n          config,\n          buildConfig.pathname,\n          // HACK is this too naive to inject script code?\n          defaultHtmlStr.replace(\n            /<\\/head>/,\n            (buildConfig.head || '') + '</head>',\n          ),\n        );\n        break;\n    }\n  }\n  await waitForTasks();\n  const dynamicHtmlPaths = Array.from(dynamicHtmlPathMap);\n  let distEntriesFileContent = await readFile(distEntriesFile, {\n    encoding: 'utf8',\n  });\n  distEntriesFileContent = distEntriesFileContent.replace(\n    'globalThis.__WAKU_DYNAMIC_HTML_PATHS__',\n    JSON.stringify(dynamicHtmlPaths),\n  );\n  distEntriesFileContent = distEntriesFileContent.replace(\n    'globalThis.__WAKU_PUBLIC_INDEX_HTML__',\n    JSON.stringify(defaultHtmlStr),\n  );\n  await writeFile(distEntriesFile, distEntriesFileContent);\n};\n\n// For Deploy\n// FIXME Is this a good approach? I wonder if there's something missing.\nconst buildDeploy = async (rootDir: string, config: ConfigDev) => {\n  const DUMMY = 'dummy-entry';\n  await buildVite({\n    plugins: [\n      {\n        // FIXME This is too hacky. There must be a better way.\n        name: 'dummy-entry-plugin',\n        resolveId(source) {\n          if (source === DUMMY) {\n            return source;\n          }\n        },\n        load(id) {\n          if (id === DUMMY) {\n            return '';\n          }\n        },\n        generateBundle(_options, bundle) {\n          Object.entries(bundle).forEach(([key, value]) => {\n            if (value.name === DUMMY) {\n              delete bundle[key];\n            }\n          });\n        },\n      },\n      ...deployPlugins(config),\n    ],\n    publicDir: false,\n    build: {\n      emptyOutDir: false,\n      ssr: true,\n      rollupOptions: {\n        onwarn: (warning, warn) => {\n          if (!warning.message.startsWith('Generated an empty chunk:')) {\n            warn(warning);\n          }\n        },\n        input: { [DUMMY]: DUMMY },\n      },\n      outDir: joinPath(rootDir, config.distDir),\n    },\n  });\n};\n\nexport async function build(options: {\n  config: Config;\n  env?: Record<string, string>;\n  partial?: boolean;\n  deploy?:\n    | 'vercel-static'\n    | 'vercel-serverless'\n    | 'netlify-static'\n    | 'netlify-functions'\n    | 'cloudflare'\n    | 'partykit'\n    | 'deno'\n    | 'aws-lambda'\n    | 'txiki'\n    | undefined;\n}) {\n  const env = options.env || {};\n  const config = await resolveConfigDev(options.config);\n  const rootDir = (\n    await resolveViteConfig({}, 'build', 'production', 'production')\n  ).root;\n  const distEntriesFile = joinPath(rootDir, config.distDir, DIST_ENTRIES_JS);\n\n  const buildOptions = unstable_getBuildOptions();\n  buildOptions.deploy = options.deploy;\n\n  buildOptions.unstable_phase = 'analyzeEntries';\n  const { clientEntryFiles, serverEntryFiles, serverModuleFiles } =\n    await analyzeEntries(rootDir, config);\n  buildOptions.unstable_phase = 'buildServerBundle';\n  const serverBuildOutput = await buildServerBundle(\n    rootDir,\n    env,\n    config,\n    clientEntryFiles,\n    serverEntryFiles,\n    serverModuleFiles,\n    !!options.partial,\n  );\n  buildOptions.unstable_phase = 'buildSsrBundle';\n  await buildSsrBundle(\n    rootDir,\n    env,\n    config,\n    clientEntryFiles,\n    serverEntryFiles,\n    serverBuildOutput,\n    !!options.partial,\n  );\n  buildOptions.unstable_phase = 'buildClientBundle';\n  const clientBuildOutput = await buildClientBundle(\n    rootDir,\n    env,\n    config,\n    clientEntryFiles,\n    serverEntryFiles,\n    serverBuildOutput,\n    !!options.partial,\n  );\n  delete buildOptions.unstable_phase;\n\n  const distEntries: EntriesPrd = await import(\n    filePathToFileURL(distEntriesFile)\n  );\n\n  INTERNAL_setAllEnv(env);\n  const cssAssets = clientBuildOutput.output.flatMap(({ type, fileName }) =>\n    type === 'asset' && fileName.endsWith('.css') ? [fileName] : [],\n  );\n  buildOptions.unstable_phase = 'emitStaticFiles';\n  await emitStaticFiles(\n    rootDir,\n    config,\n    distEntriesFile,\n    distEntries,\n    cssAssets,\n  );\n\n  buildOptions.unstable_phase = 'buildDeploy';\n  await buildDeploy(rootDir, config);\n  delete buildOptions.unstable_phase;\n\n  if (existsSync(distEntriesFile)) {\n    await emitPlatformData(joinPath(rootDir, config.distDir));\n  }\n}\n"],"names":["Readable","pipeline","build","buildVite","resolveConfig","resolveViteConfig","viteReact","INTERNAL_setAllEnv","unstable_getBuildOptions","resolveConfigDev","decodeFilePathFromAbsolute","extname","filePathToFileURL","fileURLToFilePath","joinPath","extendViteConfig","copyFile","createWriteStream","existsSync","mkdir","readdir","readFile","unlink","writeFile","encodeRscPath","generatePrefetchCode","collectClientModules","renderRsc","renderHtml","SERVER_MODULE_MAP","CLIENT_MODULE_MAP","CLIENT_PREFIX","rscRsdwPlugin","rscIndexPlugin","rscAnalyzePlugin","nonjsResolvePlugin","rscTransformPlugin","rscEntriesPlugin","rscEnvPlugin","rscPrivatePlugin","rscManagedPlugin","EXTENSIONS","DIST_ENTRIES_JS","DIST_PUBLIC","DIST_ASSETS","DIST_SSR","deployVercelPlugin","deployNetlifyPlugin","deployCloudflarePlugin","deployDenoPlugin","deployPartykitPlugin","deployAwsLambdaPlugin","deployTxikiPlugin","emitPlatformData","onwarn","warning","defaultHandler","code","test","message","loc","column","line","deployPlugins","config","analyzeEntries","rootDir","wakuClientDist","url","wakuMinimalClientDist","clientFileMap","Map","serverFileMap","moduleFileMap","pagesDirPath","srcDir","pagesDir","files","encoding","recursive","file","ext","includes","set","slice","length","mode","plugins","isClient","addEntriesToInput","ssr","target","resolve","conditions","externalConditions","noExternal","write","rollupOptions","input","Object","fromEntries","clientEntryFiles","Array","from","map","fname","hash","i","addMainToInput","serverEntryFiles","serverModuleFiles","buildServerBundle","env","partial","serverBuildOutput","isBuild","isDev","basePath","rscBase","ssrDir","moduleMap","keys","key","esbuild","jsx","define","JSON","stringify","publicDir","emptyOutDir","ssrEmitAssets","outDir","distDir","Error","buildSsrBundle","cssAssets","output","flatMap","type","fileName","endsWith","base","entryFileNames","chunkInfo","name","buildClientBundle","nonJsAssets","filter","asset","clientBuildOutput","preserveEntrySignatures","nonJsAsset","to","createTaskRunner","limit","running","waiting","errors","scheduleTask","task","Promise","push","err","shift","runTask","catch","waitForTasks","console","error","WRITE_FILE_BATCH_SIZE","emitStaticFile","pathname","body","destFile","fromWeb","emitStaticFiles","distEntriesFile","distEntries","unstable_modules","rsdwServer","loadModule","rdServer","rsdwClient","wakuMinimalClient","publicIndexHtmlFile","publicIndexHtml","publicIndexHtmlHead","replace","cssStr","join","defaultHtmlStr","defaultHtmlHead","baseRscPrefix","utils","elements","options","Set","moduleIdCallback","html","htmlHead","rscPath","headers","rscPath2pathname","unstable_generatePrefetchCode","rscPaths","moduleIds","unstable_collectClientModules","dynamicHtmlPathMap","buildConfigs","default","handleBuild","buildConfig","pathSpec","head","dynamicHtmlPaths","distEntriesFileContent","buildDeploy","DUMMY","resolveId","source","load","id","generateBundle","_options","bundle","entries","forEach","value","warn","startsWith","root","buildOptions","deploy","unstable_phase"],"mappings":"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"}