{"version":3,"sources":["../../../src/lib/builder/build.ts"],"sourcesContent":["import { Readable } from 'node:stream';\nimport { pipeline } from 'node:stream/promises';\n\nimport { build as buildVite, resolveConfig as resolveViteConfig } from 'vite';\nimport viteReact from '@vitejs/plugin-react';\nimport type { LoggingFunction, RollupLog } from 'rollup';\nimport type { ReactNode } from 'react';\n\nimport type { Config } from '../../config.js';\nimport { INTERNAL_setAllEnv, unstable_getBuildOptions } from '../../server.js';\nimport type { EntriesPrd } from '../types.js';\nimport type { ConfigDev } from '../config.js';\nimport { resolveConfigDev } from '../config.js';\nimport type { PathSpec } from '../utils/path.js';\nimport { extname, filePathToFileURL, joinPath } from '../utils/path.js';\nimport { extendViteConfig } from '../utils/vite-config.js';\nimport {\n  copyFile,\n  createWriteStream,\n  existsSync,\n  mkdir,\n  readdir,\n  readFile,\n  unlink,\n  writeFile,\n} from '../utils/node-fs.js';\nimport { encodeRscPath, generatePrefetchCode } from '../renderers/utils.js';\nimport { collectClientModules, renderRsc } from '../renderers/rsc.js';\nimport { renderHtml } from '../renderers/html.js';\nimport {\n  SERVER_MODULE_MAP,\n  CLIENT_MODULE_MAP,\n  CLIENT_PREFIX,\n} from '../middleware/handler.js';\nimport { rscRsdwPlugin } from '../plugins/vite-plugin-rsc-rsdw.js';\nimport { rscIndexPlugin } from '../plugins/vite-plugin-rsc-index.js';\nimport { rscAnalyzePlugin } from '../plugins/vite-plugin-rsc-analyze.js';\nimport { nonjsResolvePlugin } from '../plugins/vite-plugin-nonjs-resolve.js';\nimport { rscTransformPlugin } from '../plugins/vite-plugin-rsc-transform.js';\nimport { rscEntriesPlugin } from '../plugins/vite-plugin-rsc-entries.js';\nimport { rscEnvPlugin } from '../plugins/vite-plugin-rsc-env.js';\nimport { rscPrivatePlugin } from '../plugins/vite-plugin-rsc-private.js';\nimport { rscManagedPlugin } from '../plugins/vite-plugin-rsc-managed.js';\nimport {\n  EXTENSIONS,\n  DIST_ENTRIES_JS,\n  DIST_PUBLIC,\n  DIST_ASSETS,\n  DIST_SSR,\n} from './constants.js';\nimport { deployVercelPlugin } from '../plugins/vite-plugin-deploy-vercel.js';\nimport { deployNetlifyPlugin } from '../plugins/vite-plugin-deploy-netlify.js';\nimport { deployCloudflarePlugin } from '../plugins/vite-plugin-deploy-cloudflare.js';\nimport { deployDenoPlugin } from '../plugins/vite-plugin-deploy-deno.js';\nimport { deployPartykitPlugin } from '../plugins/vite-plugin-deploy-partykit.js';\nimport { deployAwsLambdaPlugin } from '../plugins/vite-plugin-deploy-aws-lambda.js';\nimport { deployTxikiPlugin } from '../plugins/vite-plugin-deploy-txiki.js';\nimport { emitPlatformData } from './platform-data.js';\n\n// TODO this file and functions in it are too long. will fix.\n\n// Upstream issue: https://github.com/rollup/rollup/issues/4699\nconst onwarn = (warning: RollupLog, defaultHandler: LoggingFunction) => {\n  if (\n    warning.code === 'MODULE_LEVEL_DIRECTIVE' &&\n    /\"use (client|server)\"/.test(warning.message)\n  ) {\n    return;\n  } else if (\n    warning.code === 'SOURCEMAP_ERROR' &&\n    warning.loc?.column === 0 &&\n    warning.loc?.line === 1\n  ) {\n    return;\n  }\n  defaultHandler(warning);\n};\n\nconst deployPlugins = (config: ConfigDev) => [\n  deployVercelPlugin(config),\n  deployNetlifyPlugin(config),\n  deployCloudflarePlugin(config),\n  deployDenoPlugin(config),\n  deployPartykitPlugin(config),\n  deployAwsLambdaPlugin(config),\n  deployTxikiPlugin(config),\n];\n\nconst analyzeEntries = async (rootDir: string, config: ConfigDev) => {\n  const clientFileMap = new Map<string, string>();\n  const serverFileMap = new Map<string, string>();\n  const serverPageFiles: Record<string, string> = {}; // page id -> full path\n  const pagesDirPath = joinPath(rootDir, config.srcDir, config.pagesDir);\n  if (existsSync(pagesDirPath)) {\n    const files = await readdir(pagesDirPath, {\n      encoding: 'utf8',\n      recursive: true,\n    });\n    for (const file of files) {\n      const ext = extname(file);\n      if (EXTENSIONS.includes(ext)) {\n        serverPageFiles[joinPath(config.pagesDir, file.slice(0, -ext.length))] =\n          joinPath(pagesDirPath, file);\n      }\n    }\n  }\n  await buildVite(\n    extendViteConfig(\n      {\n        mode: 'production',\n        plugins: [\n          rscAnalyzePlugin({ isClient: false, clientFileMap, serverFileMap }),\n          rscManagedPlugin({ ...config, addEntriesToInput: true }),\n          ...deployPlugins(config),\n        ],\n        ssr: {\n          target: 'webworker',\n          resolve: {\n            conditions: ['react-server'],\n            externalConditions: ['react-server'],\n          },\n          noExternal: /^(?!node:)/,\n        },\n        build: {\n          write: false,\n          ssr: true,\n          target: 'node20',\n          rollupOptions: {\n            onwarn,\n            input: {\n              ...SERVER_MODULE_MAP,\n              ...serverPageFiles,\n            },\n            output: {\n              inlineDynamicImports: false,\n            },\n          },\n        },\n      },\n      config,\n      'build-analyze',\n    ),\n  );\n  const clientAnalyzeOutput = await buildVite(\n    extendViteConfig(\n      {\n        mode: 'production',\n        plugins: [\n          rscAnalyzePlugin({ isClient: true, clientFileMap, serverFileMap }),\n          rscManagedPlugin({ ...config, addMainToInput: true }),\n          ...deployPlugins(config),\n        ],\n        ssr: {\n          target: 'webworker',\n          noExternal: /^(?!node:)/,\n        },\n        build: {\n          write: false,\n          ssr: true,\n          target: 'node20',\n          rollupOptions: {\n            onwarn,\n            input: {\n              ...CLIENT_MODULE_MAP,\n              ...Object.fromEntries(\n                Array.from(clientFileMap).map(([fname, hash], i) => [\n                  `${DIST_ASSETS}/rsc${i}-${hash}`,\n                  fname,\n                ]),\n              ),\n            },\n            output: {\n              inlineDynamicImports: false,\n            },\n          },\n        },\n      },\n      config,\n      'build-analyze',\n    ),\n  );\n  if (!('output' in clientAnalyzeOutput)) {\n    throw new Error('Unexpected vite client analyze output');\n  }\n  const clientEntryFiles: Record<string, string> = {};\n  const clientEntryAliasMap = new Map<string, string>();\n  let index = 0;\n  for (const [fname, hash] of clientFileMap) {\n    const entry = `${DIST_ASSETS}/rsc${index++}-${hash}`;\n    clientEntryFiles[entry] = fname;\n    for (const key of Object.keys(CLIENT_MODULE_MAP)) {\n      if (\n        clientAnalyzeOutput.output.find(\n          (item) =>\n            item.type === 'chunk' &&\n            item.name === key &&\n            item.moduleIds.includes(fname),\n        )\n      ) {\n        clientEntryAliasMap.set(key, entry);\n      }\n    }\n  }\n  const serverEntryFiles: Record<string, string> = {};\n  index = 0;\n  for (const [fname, hash] of serverFileMap) {\n    const entry = `${DIST_ASSETS}/rsf${index++}-${hash}`;\n    serverEntryFiles[entry] = fname;\n  }\n  return {\n    clientEntryFiles,\n    serverEntryFiles,\n    serverPageFiles,\n    clientEntryAliasMap,\n  };\n};\n\n// For RSC\nconst buildServerBundle = async (\n  rootDir: string,\n  env: Record<string, string>,\n  config: ConfigDev,\n  clientEntryFiles: Record<string, string>,\n  serverEntryFiles: Record<string, string>,\n  serverPageFiles: Record<string, string>,\n  clientEntryAliasMap: Map<string, string>,\n  partial: boolean,\n) => {\n  const serverBuildOutput = await buildVite(\n    extendViteConfig(\n      {\n        mode: 'production',\n        plugins: [\n          nonjsResolvePlugin(),\n          rscTransformPlugin({\n            isClient: false,\n            isBuild: true,\n            clientEntryFiles,\n            serverEntryFiles,\n          }),\n          rscRsdwPlugin(),\n          rscEnvPlugin({ isDev: false, env, config }),\n          rscPrivatePlugin(config),\n          rscManagedPlugin({ ...config, addEntriesToInput: true }),\n          rscEntriesPlugin({\n            basePath: config.basePath,\n            rscBase: config.rscBase,\n            middleware: config.middleware,\n            rootDir,\n            srcDir: config.srcDir,\n            ssrDir: DIST_SSR,\n            moduleMap: {\n              ...SERVER_MODULE_MAP,\n              ...Object.fromEntries(\n                Object.entries(serverEntryFiles).map(([key, val]) => [\n                  `${key}.js`,\n                  val,\n                ]),\n              ),\n              ...Object.fromEntries(\n                Object.keys(CLIENT_MODULE_MAP).map((key) => [\n                  `${CLIENT_PREFIX}${key}`,\n                  `./${DIST_SSR}/${clientEntryAliasMap.get(key) || key}.js`,\n                ]),\n              ),\n              ...Object.fromEntries(\n                Object.keys(clientEntryFiles).map((key) => [\n                  `${DIST_SSR}/${key}.js`,\n                  `./${DIST_SSR}/${key}.js`,\n                ]),\n              ),\n            },\n          }),\n          ...deployPlugins(config),\n        ],\n        ssr: {\n          resolve: {\n            conditions: ['react-server'],\n            externalConditions: ['react-server'],\n          },\n          noExternal: /^(?!node:)/,\n        },\n        esbuild: {\n          jsx: 'automatic',\n        },\n        define: {\n          'process.env.NODE_ENV': JSON.stringify('production'),\n        },\n        publicDir: false,\n        build: {\n          emptyOutDir: !partial,\n          ssr: true,\n          ssrEmitAssets: true,\n          target: 'node20',\n          outDir: joinPath(rootDir, config.distDir),\n          rollupOptions: {\n            onwarn,\n            input: {\n              ...clientEntryFiles,\n              ...serverEntryFiles,\n              ...SERVER_MODULE_MAP,\n              ...serverPageFiles,\n            },\n          },\n        },\n      },\n      config,\n      'build-server',\n    ),\n  );\n  if (!('output' in serverBuildOutput)) {\n    throw new Error('Unexpected vite server build output');\n  }\n  const serverAssets = serverBuildOutput.output.flatMap(({ type, fileName }) =>\n    type === 'asset' ? [fileName] : [],\n  );\n  return { serverAssets };\n};\n\n// For SSR (render client components on server to generate HTML)\nconst buildSsrBundle = async (\n  rootDir: string,\n  env: Record<string, string>,\n  config: ConfigDev,\n  clientEntryFiles: Record<string, string>,\n  serverEntryFiles: Record<string, string>,\n  serverAssets: string[],\n  partial: boolean,\n) => {\n  const cssAssets = serverAssets.filter((fileName) =>\n    fileName.endsWith('.css'),\n  );\n  await buildVite(\n    extendViteConfig(\n      {\n        mode: 'production',\n        base: config.basePath,\n        plugins: [\n          rscRsdwPlugin(),\n          rscIndexPlugin({ ...config, cssAssets }),\n          rscEnvPlugin({ isDev: false, env, config }),\n          rscPrivatePlugin(config),\n          rscManagedPlugin({ ...config, addMainToInput: true }),\n          rscTransformPlugin({\n            isClient: true,\n            isBuild: true,\n            serverEntryFiles,\n          }),\n          ...deployPlugins(config),\n        ],\n        ssr: {\n          noExternal: /^(?!node:)/,\n        },\n        esbuild: {\n          jsx: 'automatic',\n        },\n        define: {\n          'process.env.NODE_ENV': JSON.stringify('production'),\n        },\n        publicDir: false,\n        build: {\n          emptyOutDir: !partial,\n          ssr: true,\n          target: 'node20',\n          outDir: joinPath(rootDir, config.distDir, DIST_SSR),\n          rollupOptions: {\n            onwarn,\n            input: {\n              ...clientEntryFiles,\n              ...CLIENT_MODULE_MAP,\n            },\n            output: {\n              entryFileNames: (chunkInfo: { name: string }) => {\n                if (\n                  CLIENT_MODULE_MAP[chunkInfo.name as never] ||\n                  clientEntryFiles[chunkInfo.name]\n                ) {\n                  return '[name].js';\n                }\n                return DIST_ASSETS + '/[name]-[hash].js';\n              },\n            },\n          },\n        },\n      },\n      config,\n      'build-ssr',\n    ),\n  );\n};\n\n// For Browsers\nconst buildClientBundle = async (\n  rootDir: string,\n  env: Record<string, string>,\n  config: ConfigDev,\n  clientEntryFiles: Record<string, string>,\n  serverEntryFiles: Record<string, string>,\n  serverAssets: string[],\n  partial: boolean,\n) => {\n  const nonJsAssets = serverAssets.filter(\n    (fileName) => !fileName.endsWith('.js'),\n  );\n  const cssAssets = nonJsAssets.filter((asset) => asset.endsWith('.css'));\n  const clientBuildOutput = await buildVite(\n    extendViteConfig(\n      {\n        mode: 'production',\n        base: config.basePath,\n        plugins: [\n          viteReact(),\n          rscRsdwPlugin(),\n          rscIndexPlugin({ ...config, cssAssets }),\n          rscEnvPlugin({ isDev: false, env, config }),\n          rscPrivatePlugin(config),\n          rscManagedPlugin({ ...config, addMainToInput: true }),\n          rscTransformPlugin({\n            isClient: true,\n            isBuild: true,\n            serverEntryFiles,\n          }),\n          ...deployPlugins(config),\n        ],\n        build: {\n          emptyOutDir: !partial,\n          outDir: joinPath(rootDir, config.distDir, DIST_PUBLIC),\n          rollupOptions: {\n            onwarn,\n            // rollup will ouput the style files related to clientEntryFiles, but since it does not find any link to them in the index.html file, it will not inject them. They are only mentioned by the standalone `clientEntryFiles`\n            input: clientEntryFiles,\n            preserveEntrySignatures: 'exports-only',\n            output: {\n              entryFileNames: (chunkInfo: { name: string }) => {\n                if (clientEntryFiles[chunkInfo.name]) {\n                  return '[name].js';\n                }\n                return DIST_ASSETS + '/[name]-[hash].js';\n              },\n            },\n          },\n        },\n      },\n      config,\n      'build-client',\n    ),\n  );\n  if (!('output' in clientBuildOutput)) {\n    throw new Error('Unexpected vite client build output');\n  }\n  const clientAssets = clientBuildOutput.output.flatMap(({ type, fileName }) =>\n    type === 'asset' ? [fileName] : [],\n  );\n  for (const nonJsAsset of nonJsAssets) {\n    const from = joinPath(rootDir, config.distDir, nonJsAsset);\n    const to = joinPath(rootDir, config.distDir, DIST_PUBLIC, nonJsAsset);\n    await copyFile(from, to);\n  }\n  return { clientAssets };\n};\n\n// TODO: Add progress indication for static builds.\n\nconst createTaskRunner = (limit: number) => {\n  let running = 0;\n  const waiting: (() => void)[] = [];\n  const errors: unknown[] = [];\n  const scheduleTask = async (task: () => Promise<void>) => {\n    if (running >= limit) {\n      await new Promise<void>((resolve) => waiting.push(resolve));\n    }\n    running++;\n    try {\n      await task();\n    } catch (err) {\n      errors.push(err);\n    } finally {\n      running--;\n      waiting.shift()?.();\n    }\n  };\n  const runTask = (task: () => Promise<void>) => {\n    scheduleTask(task).catch(() => {});\n  };\n  const waitForTasks = async () => {\n    if (running > 0) {\n      await new Promise<void>((resolve) => waiting.push(resolve));\n      await waitForTasks();\n    }\n    if (errors.length > 0) {\n      console.error('Errors occurred during running tasks:', errors);\n      throw errors[0];\n    }\n  };\n  return { runTask, waitForTasks };\n};\nconst WRITE_FILE_BATCH_SIZE = 2500;\nconst { runTask, waitForTasks } = createTaskRunner(WRITE_FILE_BATCH_SIZE);\n\nconst emitStaticFile = (\n  rootDir: string,\n  config: ConfigDev,\n  pathname: string,\n  body: Promise<ReadableStream> | string,\n) => {\n  const destFile = joinPath(\n    rootDir,\n    config.distDir,\n    DIST_PUBLIC,\n    extname(pathname)\n      ? pathname\n      : pathname === '/404'\n        ? '404.html' // HACK special treatment for 404, better way?\n        : pathname + '/index.html',\n  );\n  // In partial mode, skip if the file already exists.\n  if (existsSync(destFile)) {\n    return;\n  }\n  runTask(async () => {\n    await mkdir(joinPath(destFile, '..'), { recursive: true });\n    if (typeof body === 'string') {\n      await writeFile(destFile, body);\n    } else {\n      await pipeline(\n        Readable.fromWeb((await body) as never),\n        createWriteStream(destFile),\n      );\n    }\n  });\n};\n\nconst emitStaticFiles = async (\n  rootDir: string,\n  config: ConfigDev,\n  distEntriesFile: string,\n  distEntries: EntriesPrd,\n  cssAssets: string[],\n) => {\n  const unstable_modules = {\n    rsdwServer: await distEntries.loadModule('rsdw-server'),\n    rdServer: await distEntries.loadModule(CLIENT_PREFIX + 'rd-server'),\n    rsdwClient: await distEntries.loadModule(CLIENT_PREFIX + 'rsdw-client'),\n    wakuMinimalClient: await distEntries.loadModule(\n      CLIENT_PREFIX + 'waku-minimal-client',\n    ),\n  };\n  const publicIndexHtmlFile = joinPath(\n    rootDir,\n    config.distDir,\n    DIST_PUBLIC,\n    'index.html',\n  );\n  const publicIndexHtml = await readFile(publicIndexHtmlFile, {\n    encoding: 'utf8',\n  });\n  const publicIndexHtmlHead = publicIndexHtml.replace(\n    /.*?<head>(.*?)<\\/head>.*/s,\n    '$1',\n  );\n  const cssStr = cssAssets\n    .map((asset) => `<link rel=\"stylesheet\" href=\"${config.basePath}${asset}\">`)\n    .join('\\n');\n  const defaultHtmlStr = publicIndexHtml\n    // HACK is this too naive to inject style code?\n    .replace(/<\\/head>/, cssStr + '</head>');\n  const defaultHtmlHead = publicIndexHtmlHead + cssStr;\n  const baseRscPrefix = config.basePath + config.rscBase + '/';\n  const utils = {\n    renderRsc: (\n      elements: Record<string, unknown>,\n      options?: {\n        moduleIdCallback?: (id: string) => void;\n      },\n    ) =>\n      renderRsc(\n        config,\n        { unstable_modules },\n        elements,\n        new Set(),\n        options?.moduleIdCallback,\n      ),\n    renderHtml: async (\n      elements: Record<string, unknown>,\n      html: ReactNode,\n      options: { rscPath: string; htmlHead?: string },\n    ) => {\n      const body = await renderHtml(\n        config,\n        { unstable_modules },\n        defaultHtmlHead + (options.htmlHead || ''),\n        elements,\n        new Set(),\n        html,\n        options.rscPath,\n      );\n      const headers = { 'content-type': 'text/html; charset=utf-8' };\n      return { body, headers };\n    },\n    rscPath2pathname: (rscPath: string) =>\n      joinPath(config.rscBase, encodeRscPath(rscPath)),\n    unstable_generatePrefetchCode: (\n      rscPaths: Iterable<string>,\n      moduleIds: Iterable<string>,\n    ) => generatePrefetchCode(baseRscPrefix, rscPaths, moduleIds),\n    unstable_collectClientModules: (elements: Record<string, unknown>) =>\n      collectClientModules(\n        config,\n        unstable_modules.rsdwServer as never,\n        elements,\n      ),\n  };\n  const dynamicHtmlPathMap = new Map<PathSpec, string>();\n  const buildConfigs = distEntries.default.handleBuild(utils);\n  if (buildConfigs) {\n    await unlink(publicIndexHtmlFile);\n  }\n  for await (const buildConfig of buildConfigs || []) {\n    switch (buildConfig.type) {\n      case 'file':\n        emitStaticFile(rootDir, config, buildConfig.pathname, buildConfig.body);\n        break;\n      case 'htmlHead':\n        dynamicHtmlPathMap.set(\n          buildConfig.pathSpec,\n          defaultHtmlHead + (buildConfig.head || ''),\n        );\n        break;\n      case 'defaultHtml':\n        emitStaticFile(\n          rootDir,\n          config,\n          buildConfig.pathname,\n          // HACK is this too naive to inject script code?\n          defaultHtmlStr.replace(\n            /<\\/head>/,\n            (buildConfig.head || '') + '</head>',\n          ),\n        );\n        break;\n    }\n  }\n  await waitForTasks();\n  const dynamicHtmlPaths = Array.from(dynamicHtmlPathMap);\n  let distEntriesFileContent = await readFile(distEntriesFile, {\n    encoding: 'utf8',\n  });\n  distEntriesFileContent = distEntriesFileContent.replace(\n    'globalThis.__WAKU_DEFAULT_HTML_HEAD__',\n    JSON.stringify(defaultHtmlHead),\n  );\n  distEntriesFileContent = distEntriesFileContent.replace(\n    'globalThis.__WAKU_DYNAMIC_HTML_PATHS__',\n    JSON.stringify(dynamicHtmlPaths),\n  );\n  distEntriesFileContent = distEntriesFileContent.replace(\n    'globalThis.__WAKU_PUBLIC_INDEX_HTML__',\n    JSON.stringify(defaultHtmlStr),\n  );\n  await writeFile(distEntriesFile, distEntriesFileContent);\n};\n\n// For Deploy\n// FIXME Is this a good approach? I wonder if there's something missing.\nconst buildDeploy = async (rootDir: string, config: ConfigDev) => {\n  const DUMMY = 'dummy-entry';\n  await buildVite(\n    extendViteConfig(\n      {\n        plugins: [\n          {\n            // FIXME This is too hacky. There must be a better way.\n            name: 'dummy-entry-plugin',\n            resolveId(source) {\n              if (source === DUMMY) {\n                return source;\n              }\n            },\n            load(id) {\n              if (id === DUMMY) {\n                return '';\n              }\n            },\n            generateBundle(_options, bundle) {\n              Object.entries(bundle).forEach(([key, value]) => {\n                if (value.name === DUMMY) {\n                  delete bundle[key];\n                }\n              });\n            },\n          },\n          ...deployPlugins(config),\n        ],\n        publicDir: false,\n        build: {\n          emptyOutDir: false,\n          ssr: true,\n          rollupOptions: {\n            onwarn: (warning, warn) => {\n              if (!warning.message.startsWith('Generated an empty chunk:')) {\n                warn(warning);\n              }\n            },\n            input: { [DUMMY]: DUMMY },\n          },\n          outDir: joinPath(rootDir, config.distDir),\n        },\n      },\n      config,\n      'build-deploy',\n    ),\n  );\n};\n\nexport async function build(options: {\n  config: Config;\n  env?: Record<string, string>;\n  partial?: boolean;\n  deploy?:\n    | 'vercel-static'\n    | 'vercel-serverless'\n    | 'netlify-static'\n    | 'netlify-functions'\n    | 'cloudflare'\n    | 'partykit'\n    | 'deno'\n    | 'aws-lambda'\n    | 'txiki'\n    | undefined;\n}) {\n  const env = options.env || {};\n  const config = await resolveConfigDev(options.config);\n  const rootDir = (\n    await resolveViteConfig({}, 'build', 'production', 'production')\n  ).root;\n  const distEntriesFile = joinPath(rootDir, config.distDir, DIST_ENTRIES_JS);\n\n  const buildOptions = unstable_getBuildOptions();\n  buildOptions.deploy = options.deploy;\n\n  buildOptions.unstable_phase = 'analyzeEntries';\n  const {\n    clientEntryFiles,\n    serverEntryFiles,\n    serverPageFiles,\n    clientEntryAliasMap,\n  } = await analyzeEntries(rootDir, config);\n  buildOptions.unstable_phase = 'buildServerBundle';\n  const { serverAssets } = await buildServerBundle(\n    rootDir,\n    env,\n    config,\n    clientEntryFiles,\n    serverEntryFiles,\n    serverPageFiles,\n    clientEntryAliasMap,\n    !!options.partial,\n  );\n  buildOptions.unstable_phase = 'buildSsrBundle';\n  await buildSsrBundle(\n    rootDir,\n    env,\n    config,\n    clientEntryFiles,\n    serverEntryFiles,\n    serverAssets,\n    !!options.partial,\n  );\n  buildOptions.unstable_phase = 'buildClientBundle';\n  const { clientAssets } = await buildClientBundle(\n    rootDir,\n    env,\n    config,\n    clientEntryFiles,\n    serverEntryFiles,\n    serverAssets,\n    !!options.partial,\n  );\n  delete buildOptions.unstable_phase;\n\n  const distEntries: EntriesPrd = await import(\n    filePathToFileURL(distEntriesFile)\n  );\n\n  INTERNAL_setAllEnv(env);\n  const cssAssets = clientAssets.filter((fileName) =>\n    fileName.endsWith('.css'),\n  );\n  buildOptions.unstable_phase = 'emitStaticFiles';\n  await emitStaticFiles(\n    rootDir,\n    config,\n    distEntriesFile,\n    distEntries,\n    cssAssets,\n  );\n\n  buildOptions.unstable_phase = 'buildDeploy';\n  await buildDeploy(rootDir, config);\n  delete buildOptions.unstable_phase;\n\n  if (existsSync(distEntriesFile)) {\n    await emitPlatformData(joinPath(rootDir, config.distDir));\n  }\n}\n"],"names":["Readable","pipeline","build","buildVite","resolveConfig","resolveViteConfig","viteReact","INTERNAL_setAllEnv","unstable_getBuildOptions","resolveConfigDev","extname","filePathToFileURL","joinPath","extendViteConfig","copyFile","createWriteStream","existsSync","mkdir","readdir","readFile","unlink","writeFile","encodeRscPath","generatePrefetchCode","collectClientModules","renderRsc","renderHtml","SERVER_MODULE_MAP","CLIENT_MODULE_MAP","CLIENT_PREFIX","rscRsdwPlugin","rscIndexPlugin","rscAnalyzePlugin","nonjsResolvePlugin","rscTransformPlugin","rscEntriesPlugin","rscEnvPlugin","rscPrivatePlugin","rscManagedPlugin","EXTENSIONS","DIST_ENTRIES_JS","DIST_PUBLIC","DIST_ASSETS","DIST_SSR","deployVercelPlugin","deployNetlifyPlugin","deployCloudflarePlugin","deployDenoPlugin","deployPartykitPlugin","deployAwsLambdaPlugin","deployTxikiPlugin","emitPlatformData","onwarn","warning","defaultHandler","code","test","message","loc","column","line","deployPlugins","config","analyzeEntries","rootDir","clientFileMap","Map","serverFileMap","serverPageFiles","pagesDirPath","srcDir","pagesDir","files","encoding","recursive","file","ext","includes","slice","length","mode","plugins","isClient","addEntriesToInput","ssr","target","resolve","conditions","externalConditions","noExternal","write","rollupOptions","input","output","inlineDynamicImports","clientAnalyzeOutput","addMainToInput","Object","fromEntries","Array","from","map","fname","hash","i","Error","clientEntryFiles","clientEntryAliasMap","index","entry","key","keys","find","item","type","name","moduleIds","set","serverEntryFiles","buildServerBundle","env","partial","serverBuildOutput","isBuild","isDev","basePath","rscBase","middleware","ssrDir","moduleMap","entries","val","get","esbuild","jsx","define","JSON","stringify","publicDir","emptyOutDir","ssrEmitAssets","outDir","distDir","serverAssets","flatMap","fileName","buildSsrBundle","cssAssets","filter","endsWith","base","entryFileNames","chunkInfo","buildClientBundle","nonJsAssets","asset","clientBuildOutput","preserveEntrySignatures","clientAssets","nonJsAsset","to","createTaskRunner","limit","running","waiting","errors","scheduleTask","task","Promise","push","err","shift","runTask","catch","waitForTasks","console","error","WRITE_FILE_BATCH_SIZE","emitStaticFile","pathname","body","destFile","fromWeb","emitStaticFiles","distEntriesFile","distEntries","unstable_modules","rsdwServer","loadModule","rdServer","rsdwClient","wakuMinimalClient","publicIndexHtmlFile","publicIndexHtml","publicIndexHtmlHead","replace","cssStr","join","defaultHtmlStr","defaultHtmlHead","baseRscPrefix","utils","elements","options","Set","moduleIdCallback","html","htmlHead","rscPath","headers","rscPath2pathname","unstable_generatePrefetchCode","rscPaths","unstable_collectClientModules","dynamicHtmlPathMap","buildConfigs","default","handleBuild","buildConfig","pathSpec","head","dynamicHtmlPaths","distEntriesFileContent","buildDeploy","DUMMY","resolveId","source","load","id","generateBundle","_options","bundle","forEach","value","warn","startsWith","root","buildOptions","deploy","unstable_phase"],"mappings":"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"}