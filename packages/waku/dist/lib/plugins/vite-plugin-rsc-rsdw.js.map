{"version":3,"sources":["../../../src/lib/plugins/vite-plugin-rsc-rsdw.ts"],"sourcesContent":["import type { Plugin } from 'vite';\n\nconst patchRsdw = (code: string, type: 'SERVER' | 'CLIENT') => {\n  code = code.replace(\n    /__webpack_(\\w+)__/g,\n    (_, p1) => `__WAKU_${type}_${p1.toUpperCase()}__`,\n  );\n  const index = code.indexOf('function requireAsyncModule(id)');\n  if (index === -1) {\n    throw new Error('rscRsdwPlugin: Unexpected code structure');\n  }\n\n  return code.replaceAll(\n    'function requireAsyncModule(id)',\n    `\nglobalThis.__WAKU_${type}_MODULE_LOADING__ ||= new Map();\nglobalThis.__WAKU_${type}_MODULE_CACHE__ ||= new Map();\nglobalThis.__WAKU_${type}_CHUNK_LOAD__ ||= (id) => {\n  if (!globalThis.__WAKU_${type}_MODULE_LOADING__.has(id)) {\n    globalThis.__WAKU_${type}_MODULE_LOADING__.set(\n      id,\n      globalThis.__WAKU_${type}_IMPORT__(id).then((m) => {\n        globalThis.__WAKU_${type}_MODULE_CACHE__.set(id, m);\n      })\n    );\n  }\n  return globalThis.__WAKU_${type}_MODULE_LOADING__.get(id);\n};\nglobalThis.__WAKU_${type}_REQUIRE__ ||= (id) => globalThis.__WAKU_${type}_MODULE_CACHE__.get(id);\nfunction requireAsyncModule(id)\n`,\n  );\n};\n\nexport function rscRsdwPlugin(): Plugin {\n  let mode: string;\n  return {\n    name: 'rsc-rsdw-plugin',\n    enforce: 'pre',\n    config(_config, env) {\n      mode = env.mode;\n    },\n    async resolveId(id, importer, options) {\n      if (id === 'react-server-dom-webpack/client.edge') {\n        const resolved = await this.resolve(id, importer, options);\n        if (resolved) {\n          id = resolved.id;\n        }\n      }\n      if (id.endsWith('/react-server-dom-webpack/client.edge.js')) {\n        id =\n          id.slice(0, -'/client.edge.js'.length) +\n          `/cjs/react-server-dom-webpack-client.edge.${mode === 'production' ? 'production' : 'development'}.js`;\n        return this.resolve(id, importer, options);\n      }\n    },\n    transform(code, id) {\n      const [file, opt] = id.split('?');\n      if (\n        ['commonjs-exports', 'commonjs-proxy', 'commonjs-entry'].includes(opt!)\n      ) {\n        return;\n      }\n      if (\n        [\n          '/react-server-dom-webpack-server.edge.production.js',\n          '/react-server-dom-webpack-server.edge.development.js',\n          '/react-server-dom-webpack_server__edge.js',\n        ].some((suffix) => file!.endsWith(suffix))\n      ) {\n        return patchRsdw(code, 'SERVER');\n      }\n      if (\n        [\n          '/react-server-dom-webpack-client.edge.production.js',\n          '/react-server-dom-webpack-client.edge.development.js',\n          '/react-server-dom-webpack-client.browser.production.js',\n          '/react-server-dom-webpack-client.browser.development.js',\n          '/react-server-dom-webpack_client.js',\n          '/react-server-dom-webpack_client__edge.js',\n        ].some((suffix) => file!.endsWith(suffix))\n      ) {\n        return patchRsdw(code, 'CLIENT');\n      }\n      if (code.includes('function requireAsyncModule(id)')) {\n        throw new Error('rscRsdwPlugin: Untransformed file: ' + file);\n      }\n    },\n  };\n}\n"],"names":["patchRsdw","code","type","replace","_","p1","toUpperCase","index","indexOf","Error","replaceAll","rscRsdwPlugin","mode","name","enforce","config","_config","env","resolveId","id","importer","options","resolved","resolve","endsWith","slice","length","transform","file","opt","split","includes","some","suffix"],"mappings":"AAEA,MAAMA,YAAY,CAACC,MAAcC;IAC/BD,OAAOA,KAAKE,OAAO,CACjB,sBACA,CAACC,GAAGC,KAAO,CAAC,OAAO,EAAEH,KAAK,CAAC,EAAEG,GAAGC,WAAW,GAAG,EAAE,CAAC;IAEnD,MAAMC,QAAQN,KAAKO,OAAO,CAAC;IAC3B,IAAID,UAAU,CAAC,GAAG;QAChB,MAAM,IAAIE,MAAM;IAClB;IAEA,OAAOR,KAAKS,UAAU,CACpB,mCACA,CAAC;kBACa,EAAER,KAAK;kBACP,EAAEA,KAAK;kBACP,EAAEA,KAAK;yBACA,EAAEA,KAAK;sBACV,EAAEA,KAAK;;wBAEL,EAAEA,KAAK;0BACL,EAAEA,KAAK;;;;2BAIN,EAAEA,KAAK;;kBAEhB,EAAEA,KAAK,yCAAyC,EAAEA,KAAK;;AAEzE,CAAC;AAED;AAEA,OAAO,SAASS;IACd,IAAIC;IACJ,OAAO;QACLC,MAAM;QACNC,SAAS;QACTC,QAAOC,OAAO,EAAEC,GAAG;YACjBL,OAAOK,IAAIL,IAAI;QACjB;QACA,MAAMM,WAAUC,EAAE,EAAEC,QAAQ,EAAEC,OAAO;YACnC,IAAIF,OAAO,wCAAwC;gBACjD,MAAMG,WAAW,MAAM,IAAI,CAACC,OAAO,CAACJ,IAAIC,UAAUC;gBAClD,IAAIC,UAAU;oBACZH,KAAKG,SAASH,EAAE;gBAClB;YACF;YACA,IAAIA,GAAGK,QAAQ,CAAC,6CAA6C;gBAC3DL,KACEA,GAAGM,KAAK,CAAC,GAAG,CAAC,kBAAkBC,MAAM,IACrC,CAAC,0CAA0C,EAAEd,SAAS,eAAe,eAAe,cAAc,GAAG,CAAC;gBACxG,OAAO,IAAI,CAACW,OAAO,CAACJ,IAAIC,UAAUC;YACpC;QACF;QACAM,WAAU1B,IAAI,EAAEkB,EAAE;YAChB,MAAM,CAACS,MAAMC,IAAI,GAAGV,GAAGW,KAAK,CAAC;YAC7B,IACE;gBAAC;gBAAoB;gBAAkB;aAAiB,CAACC,QAAQ,CAACF,MAClE;gBACA;YACF;YACA,IACE;gBACE;gBACA;gBACA;aACD,CAACG,IAAI,CAAC,CAACC,SAAWL,KAAMJ,QAAQ,CAACS,UAClC;gBACA,OAAOjC,UAAUC,MAAM;YACzB;YACA,IACE;gBACE;gBACA;gBACA;gBACA;gBACA;gBACA;aACD,CAAC+B,IAAI,CAAC,CAACC,SAAWL,KAAMJ,QAAQ,CAACS,UAClC;gBACA,OAAOjC,UAAUC,MAAM;YACzB;YACA,IAAIA,KAAK8B,QAAQ,CAAC,oCAAoC;gBACpD,MAAM,IAAItB,MAAM,wCAAwCmB;YAC1D;QACF;IACF;AACF"}