{"version":3,"sources":["../../../src/lib/plugins/vite-plugin-deploy-deno.ts"],"sourcesContent":["import type { Plugin } from 'vite';\n\nimport {\n  unstable_getBuildOptions,\n  unstable_builderConstants,\n} from '../../server.js';\n\nconst { SRC_ENTRIES, DIST_PUBLIC } = unstable_builderConstants;\nconst SERVE_JS = 'serve-deno.js';\n\nconst getServeJsContent = (\n  distDir: string,\n  distPublic: string,\n  srcEntriesFile: string,\n) => `\nimport { Hono } from 'jsr:@hono/hono';\nimport { serveStatic } from 'jsr:@hono/hono/deno';\nimport { serverEngine } from 'waku/unstable_hono';\n\nconst distDir = '${distDir}';\nconst publicDir = '${distPublic}';\nconst loadEntries = () => import('${srcEntriesFile}');\nconst configPromise = loadEntries().then((entries) => entries.loadConfig());\nconst env = Deno.env.toObject();\n\nconst createApp = (app) => {\n  app.use(serveStatic({ root: distDir + '/' + publicDir }));\n  app.use(serverEngine({ cmd: 'start', loadEntries, env, unstable_onError: new Set() }));\n  app.notFound(async (c) => {\n    const file = distDir + '/' + publicDir + '/404.html';\n    try {\n      const info = await Deno.stat(file);\n      if (info.isFile) {\n        c.header('Content-Type', 'text/html; charset=utf-8');\n        return c.body(await Deno.readFile(file), 404);\n      }\n    } catch {}\n    return c.text('404 Not Found', 404);\n  });\n  return app;\n};\n\nconst honoEnhancer =\n  (await configPromise).unstable_honoEnhancer || ((createApp) => createApp);\nconst app = honoEnhancer(createApp)(new Hono());\n\nDeno.serve(app.fetch);\n`;\n\nexport function deployDenoPlugin(opts: {\n  srcDir: string;\n  distDir: string;\n}): Plugin {\n  const buildOptions = unstable_getBuildOptions();\n  let entriesFile: string;\n  return {\n    name: 'deploy-deno-plugin',\n    config(viteConfig) {\n      const { deploy, unstable_phase } = buildOptions;\n      if (unstable_phase !== 'buildServerBundle' || deploy !== 'deno') {\n        return;\n      }\n      const { input } = viteConfig.build?.rollupOptions ?? {};\n      if (input && !(typeof input === 'string') && !(input instanceof Array)) {\n        input[SERVE_JS.replace(/\\.js$/, '')] = `${opts.srcDir}/${SERVE_JS}`;\n      }\n    },\n    configResolved(config) {\n      entriesFile = `${config.root}/${opts.srcDir}/${SRC_ENTRIES}`;\n      const { deploy, unstable_phase } = buildOptions;\n      if (\n        (unstable_phase !== 'buildServerBundle' &&\n          unstable_phase !== 'buildSsrBundle') ||\n        deploy !== 'deno'\n      ) {\n        return;\n      }\n      config.ssr.target = 'webworker';\n      config.ssr.resolve ||= {};\n      config.ssr.resolve.conditions ||= [];\n      config.ssr.resolve.conditions.push('worker');\n      config.ssr.resolve.externalConditions ||= [];\n      config.ssr.resolve.externalConditions.push('worker');\n    },\n    resolveId(source) {\n      if (source === `${opts.srcDir}/${SERVE_JS}`) {\n        return source;\n      }\n      if (source.startsWith('jsr:@hono/hono')) {\n        return { id: source, external: true };\n      }\n    },\n    load(id) {\n      if (id === `${opts.srcDir}/${SERVE_JS}`) {\n        return getServeJsContent(opts.distDir, DIST_PUBLIC, entriesFile);\n      }\n    },\n  };\n}\n"],"names":["unstable_getBuildOptions","unstable_builderConstants","SRC_ENTRIES","DIST_PUBLIC","SERVE_JS","getServeJsContent","distDir","distPublic","srcEntriesFile","deployDenoPlugin","opts","buildOptions","entriesFile","name","config","viteConfig","deploy","unstable_phase","input","build","rollupOptions","Array","replace","srcDir","configResolved","root","ssr","target","resolve","conditions","push","externalConditions","resolveId","source","startsWith","id","external","load"],"mappings":"AAEA,SACEA,wBAAwB,EACxBC,yBAAyB,QACpB,kBAAkB;AAEzB,MAAM,EAAEC,WAAW,EAAEC,WAAW,EAAE,GAAGF;AACrC,MAAMG,WAAW;AAEjB,MAAMC,oBAAoB,CACxBC,SACAC,YACAC,iBACG,CAAC;;;;;iBAKW,EAAEF,QAAQ;mBACR,EAAEC,WAAW;kCACE,EAAEC,eAAe;;;;;;;;;;;;;;;;;;;;;;;;;;AA0BnD,CAAC;AAED,OAAO,SAASC,iBAAiBC,IAGhC;IACC,MAAMC,eAAeX;IACrB,IAAIY;IACJ,OAAO;QACLC,MAAM;QACNC,QAAOC,UAAU;YACf,MAAM,EAAEC,MAAM,EAAEC,cAAc,EAAE,GAAGN;YACnC,IAAIM,mBAAmB,uBAAuBD,WAAW,QAAQ;gBAC/D;YACF;YACA,MAAM,EAAEE,KAAK,EAAE,GAAGH,WAAWI,KAAK,EAAEC,iBAAiB,CAAC;YACtD,IAAIF,SAAS,CAAE,CAAA,OAAOA,UAAU,QAAO,KAAM,CAAEA,CAAAA,iBAAiBG,KAAI,GAAI;gBACtEH,KAAK,CAACd,SAASkB,OAAO,CAAC,SAAS,IAAI,GAAG,GAAGZ,KAAKa,MAAM,CAAC,CAAC,EAAEnB,UAAU;YACrE;QACF;QACAoB,gBAAeV,MAAM;YACnBF,cAAc,GAAGE,OAAOW,IAAI,CAAC,CAAC,EAAEf,KAAKa,MAAM,CAAC,CAAC,EAAErB,aAAa;YAC5D,MAAM,EAAEc,MAAM,EAAEC,cAAc,EAAE,GAAGN;YACnC,IACE,AAACM,mBAAmB,uBAClBA,mBAAmB,oBACrBD,WAAW,QACX;gBACA;YACF;YACAF,OAAOY,GAAG,CAACC,MAAM,GAAG;YACpBb,OAAOY,GAAG,CAACE,OAAO,KAAK,CAAC;YACxBd,OAAOY,GAAG,CAACE,OAAO,CAACC,UAAU,KAAK,EAAE;YACpCf,OAAOY,GAAG,CAACE,OAAO,CAACC,UAAU,CAACC,IAAI,CAAC;YACnChB,OAAOY,GAAG,CAACE,OAAO,CAACG,kBAAkB,KAAK,EAAE;YAC5CjB,OAAOY,GAAG,CAACE,OAAO,CAACG,kBAAkB,CAACD,IAAI,CAAC;QAC7C;QACAE,WAAUC,MAAM;YACd,IAAIA,WAAW,GAAGvB,KAAKa,MAAM,CAAC,CAAC,EAAEnB,UAAU,EAAE;gBAC3C,OAAO6B;YACT;YACA,IAAIA,OAAOC,UAAU,CAAC,mBAAmB;gBACvC,OAAO;oBAAEC,IAAIF;oBAAQG,UAAU;gBAAK;YACtC;QACF;QACAC,MAAKF,EAAE;YACL,IAAIA,OAAO,GAAGzB,KAAKa,MAAM,CAAC,CAAC,EAAEnB,UAAU,EAAE;gBACvC,OAAOC,kBAAkBK,KAAKJ,OAAO,EAAEH,aAAaS;YACtD;QACF;IACF;AACF"}