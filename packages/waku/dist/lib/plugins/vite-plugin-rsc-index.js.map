{"version":3,"sources":["../../../src/lib/plugins/vite-plugin-rsc-index.ts"],"sourcesContent":["import type { Plugin } from 'vite';\n\nimport { SRC_MAIN } from '../builder/constants.js';\n\nexport function rscIndexPlugin(opts: {\n  basePath: string;\n  srcDir: string;\n  cssAssets?: string[];\n}): Plugin {\n  const indexHtml = 'index.html';\n  const html = `\n<!doctype html>\n<html>\n  <head>\n  </head>\n  <body>\n    <script src=\"${opts.basePath}${opts.srcDir}/${SRC_MAIN}\" async type=\"module\"></script>\n  </body>\n</html>\n`;\n  return {\n    name: 'rsc-index-plugin',\n    config() {\n      return {\n        optimizeDeps: {\n          entries: [`${opts.srcDir}/${SRC_MAIN}.*`],\n        },\n      };\n    },\n    options(options) {\n      if (typeof options.input === 'string') {\n        throw new Error('string input is unsupported');\n      }\n      if (Array.isArray(options.input)) {\n        throw new Error('array input is unsupported');\n      }\n      return {\n        ...options,\n        input: {\n          indexHtml,\n          ...options.input,\n        },\n      };\n    },\n    configureServer(server) {\n      return () => {\n        server.middlewares.use((req, res, next) => {\n          if (req.url === opts.basePath) {\n            server\n              .transformIndexHtml(req.url, html)\n              .then((content) => {\n                res.statusCode = 200;\n                res.setHeader('content-type', 'text/html; charset=utf-8');\n                res.end(content);\n              })\n              .catch((err) => {\n                console.error('Error transforming index.html', err);\n                res.statusCode = 500;\n                res.end('Internal Server Error');\n              });\n          } else {\n            next();\n          }\n        });\n      };\n    },\n    resolveId(id) {\n      if (id === indexHtml) {\n        return { id: indexHtml, moduleSideEffects: true };\n      }\n    },\n    load(id) {\n      if (id === indexHtml) {\n        return html;\n      }\n    },\n    transformIndexHtml() {\n      return [\n        {\n          tag: 'script',\n          attrs: { type: 'module', async: true },\n          // HACK: vite won't inject __vite__injectQuery anymore\n          // Vite optimizes `import()` so it adds `?import` to imported urls. That'd cause double module hazard! This way, I hack it to use a global function so it does not get optimized.\n          children: `\nglobalThis.__WAKU_CLIENT_IMPORT__ = (id) => import(id);\n`,\n        },\n        ...(opts.cssAssets || []).map((href) => ({\n          tag: 'link',\n          attrs: { rel: 'stylesheet', href: `${opts.basePath}${href}` },\n          injectTo: 'head' as const,\n        })),\n      ];\n    },\n  };\n}\n"],"names":["SRC_MAIN","rscIndexPlugin","opts","indexHtml","html","basePath","srcDir","name","config","optimizeDeps","entries","options","input","Error","Array","isArray","configureServer","server","middlewares","use","req","res","next","url","transformIndexHtml","then","content","statusCode","setHeader","end","catch","err","console","error","resolveId","id","moduleSideEffects","load","tag","attrs","type","async","children","cssAssets","map","href","rel","injectTo"],"mappings":"AAEA,SAASA,QAAQ,QAAQ,0BAA0B;AAEnD,OAAO,SAASC,eAAeC,IAI9B;IACC,MAAMC,YAAY;IAClB,MAAMC,OAAO,CAAC;;;;;;iBAMC,EAAEF,KAAKG,QAAQ,GAAGH,KAAKI,MAAM,CAAC,CAAC,EAAEN,SAAS;;;AAG3D,CAAC;IACC,OAAO;QACLO,MAAM;QACNC;YACE,OAAO;gBACLC,cAAc;oBACZC,SAAS;wBAAC,GAAGR,KAAKI,MAAM,CAAC,CAAC,EAAEN,SAAS,EAAE,CAAC;qBAAC;gBAC3C;YACF;QACF;QACAW,SAAQA,OAAO;YACb,IAAI,OAAOA,QAAQC,KAAK,KAAK,UAAU;gBACrC,MAAM,IAAIC,MAAM;YAClB;YACA,IAAIC,MAAMC,OAAO,CAACJ,QAAQC,KAAK,GAAG;gBAChC,MAAM,IAAIC,MAAM;YAClB;YACA,OAAO;gBACL,GAAGF,OAAO;gBACVC,OAAO;oBACLT;oBACA,GAAGQ,QAAQC,KAAK;gBAClB;YACF;QACF;QACAI,iBAAgBC,MAAM;YACpB,OAAO;gBACLA,OAAOC,WAAW,CAACC,GAAG,CAAC,CAACC,KAAKC,KAAKC;oBAChC,IAAIF,IAAIG,GAAG,KAAKrB,KAAKG,QAAQ,EAAE;wBAC7BY,OACGO,kBAAkB,CAACJ,IAAIG,GAAG,EAAEnB,MAC5BqB,IAAI,CAAC,CAACC;4BACLL,IAAIM,UAAU,GAAG;4BACjBN,IAAIO,SAAS,CAAC,gBAAgB;4BAC9BP,IAAIQ,GAAG,CAACH;wBACV,GACCI,KAAK,CAAC,CAACC;4BACNC,QAAQC,KAAK,CAAC,iCAAiCF;4BAC/CV,IAAIM,UAAU,GAAG;4BACjBN,IAAIQ,GAAG,CAAC;wBACV;oBACJ,OAAO;wBACLP;oBACF;gBACF;YACF;QACF;QACAY,WAAUC,EAAE;YACV,IAAIA,OAAOhC,WAAW;gBACpB,OAAO;oBAAEgC,IAAIhC;oBAAWiC,mBAAmB;gBAAK;YAClD;QACF;QACAC,MAAKF,EAAE;YACL,IAAIA,OAAOhC,WAAW;gBACpB,OAAOC;YACT;QACF;QACAoB;YACE,OAAO;gBACL;oBACEc,KAAK;oBACLC,OAAO;wBAAEC,MAAM;wBAAUC,OAAO;oBAAK;oBACrC,sDAAsD;oBACtD,iLAAiL;oBACjLC,UAAU,CAAC;;AAErB,CAAC;gBACO;mBACG,AAACxC,CAAAA,KAAKyC,SAAS,IAAI,EAAE,AAAD,EAAGC,GAAG,CAAC,CAACC,OAAU,CAAA;wBACvCP,KAAK;wBACLC,OAAO;4BAAEO,KAAK;4BAAcD,MAAM,GAAG3C,KAAKG,QAAQ,GAAGwC,MAAM;wBAAC;wBAC5DE,UAAU;oBACZ,CAAA;aACD;QACH;IACF;AACF"}