{"version":3,"sources":["../../../src/lib/plugins/vite-plugin-rsc-hmr.ts"],"sourcesContent":["import type {\n  NormalizedHotChannel,\n  HtmlTagDescriptor,\n  Plugin,\n  TransformResult,\n  ViteDevServer,\n} from 'vite';\n\nimport {\n  joinPath,\n  fileURLToFilePath,\n  decodeFilePathFromAbsolute,\n  filePathToFileURL,\n} from '../utils/path.js';\n\ntype ModuleImportResult = TransformResult & {\n  id: string;\n  // non-transformed result of `TransformResult.code`\n  source: string;\n  css?: boolean;\n};\n\nconst injectingHmrCode = `\nimport { createHotContext as __vite__createHotContext } from \"/@vite/client\";\nimport.meta.hot = __vite__createHotContext(import.meta.url);\n\nif (import.meta.hot && !globalThis.__WAKU_HMR_CONFIGURED__) {\n  globalThis.__WAKU_HMR_CONFIGURED__ = true;\n  import.meta.hot.on('vite:afterUpdate', (data) => {\n    if (data.type === 'update') {\n      for (const update of data.updates) {\n        if (\n          update.type === 'js-update' &&\n          globalThis.__WAKU_CLIENT_MODULE_LOADING__.has(update.path)\n        ) {\n          globalThis.__WAKU_CLIENT_MODULE_LOADING__.set(update.path,\n            globalThis.__WAKU_CLIENT_IMPORT__(update.path + '?t=' + update.timestamp).then((m) => {\n              globalThis.__WAKU_CLIENT_MODULE_CACHE__.set(update.path, m);\n            })\n          );\n        }\n      }\n    }\n  });\n  import.meta.hot.on('rsc-reload', () => {\n    globalThis.__WAKU_RSC_RELOAD_LISTENERS__?.forEach((l) => l());\n  });\n  import.meta.hot.on('hot-import', (data) => import(/* @vite-ignore */ data));\n  import.meta.hot.on('module-import', (data) => {\n    // remove element with the same 'waku-module-id'\n    let script = document.querySelector('script[waku-module-id=\"' + data.id + '\"]');\n    let style = document.querySelector('style[waku-module-id=\"' + data.id + '\"]');\n    script?.remove();\n    const code = data.code;\n    script = document.createElement('script');\n    script.type = 'module';\n    script.text = code;\n    script.setAttribute('waku-module-id', data.id);\n    document.head.appendChild(script);\n    // avoid HMR flash by first applying the new and removing the old styles \n    if (style) {\n      queueMicrotask(() => style.parentElement?.removeChild(style));\n    }\n  });\n  import.meta.hot.on('vite:invalidate', () => {\n    // FIXME is there a better solution?\n    location.reload();\n  });\n}\n`;\n\nexport function rscHmrPlugin(): Plugin {\n  const wakuMinimalClientDist = decodeFilePathFromAbsolute(\n    joinPath(fileURLToFilePath(import.meta.url), '../../../minimal/client.js'),\n  );\n  const wakuRouterClientDist = decodeFilePathFromAbsolute(\n    joinPath(fileURLToFilePath(import.meta.url), '../../../router/client.js'),\n  );\n  let viteServer: ViteDevServer;\n  return {\n    name: 'rsc-hmr-plugin',\n    enforce: 'post',\n    configureServer(server) {\n      viteServer = server;\n    },\n    async transformIndexHtml() {\n      return [\n        ...(await generateInitialScripts(viteServer)),\n        {\n          tag: 'script',\n          attrs: { type: 'module', async: true },\n          children: injectingHmrCode,\n          injectTo: 'head',\n        },\n      ];\n    },\n    async transform(code, id) {\n      if (id.startsWith(wakuMinimalClientDist)) {\n        // FIXME this is fragile. Can we do it better?\n        return code.replace(\n          /\\nexport const fetchRsc = \\(.*?\\)=>\\{/,\n          (m) =>\n            m +\n            `\n{\n  const refetchRsc = () => {\n    delete fetchCache[ENTRY];\n    const data = fetchRsc(rscPath, rscParams, fetchCache);\n    fetchCache[SET_ELEMENTS](() => data);\n  };\n  globalThis.__WAKU_RSC_RELOAD_LISTENERS__ ||= [];\n  const index = globalThis.__WAKU_RSC_RELOAD_LISTENERS__.indexOf(globalThis.__WAKU_REFETCH_RSC__);\n  if (index !== -1) {\n    globalThis.__WAKU_RSC_RELOAD_LISTENERS__.splice(index, 1, refetchRsc);\n  } else {\n    globalThis.__WAKU_RSC_RELOAD_LISTENERS__.push(refetchRsc);\n  }\n  globalThis.__WAKU_REFETCH_RSC__ = refetchRsc;\n}\n`,\n        );\n      } else if (id.startsWith(wakuRouterClientDist)) {\n        // FIXME this is fragile. Can we do it better?\n        return code.replace(\n          /\\nconst InnerRouter = \\(.*?\\)=>\\{/,\n          (m) =>\n            m +\n            `\n{\n  const refetchRoute = () => {\n    staticPathSet.clear();\n    routerData[2].clear(); // cacheIdSet\n    const rscPath = encodeRoutePath(route.path);\n    const rscParams = createRscParams(route.query, []);\n    refetch(rscPath, rscParams);\n  };\n  globalThis.__WAKU_RSC_RELOAD_LISTENERS__ ||= [];\n  const index = globalThis.__WAKU_RSC_RELOAD_LISTENERS__.indexOf(globalThis.__WAKU_REFETCH_ROUTE__);\n  if (index !== -1) {\n    globalThis.__WAKU_RSC_RELOAD_LISTENERS__.splice(index, 1, refetchRoute);\n  } else {\n    globalThis.__WAKU_RSC_RELOAD_LISTENERS__.unshift(refetchRoute);\n  }\n  globalThis.__WAKU_REFETCH_ROUTE__ = refetchRoute;\n}\n`,\n        );\n      }\n    },\n    handleHotUpdate({ file, server }) {\n      if (file.endsWith('/pages.gen.ts')) {\n        // auto generated file by fsRouterTypegenPlugin\n        return [];\n      }\n\n      handleModuleUpdate(file, server);\n      const module = server.moduleGraph.getModuleById(file);\n      if (module?.file?.endsWith('.module.css')) {\n        module.importers.forEach((importer) => {\n          handleModuleUpdate(importer.file!, server);\n        });\n      }\n    },\n  };\n}\n\nconst pendingMap = new WeakMap<ReturnType<typeof viteHot>, Set<string>>();\n\nfunction viteHot(viteServer: ViteDevServer): NormalizedHotChannel {\n  return viteServer.hot ?? viteServer.ws;\n}\n\nfunction hotImport(viteServer: ViteDevServer, source: string) {\n  const hot = viteHot(viteServer);\n  let sourceSet = pendingMap.get(hot);\n  if (!sourceSet) {\n    sourceSet = new Set();\n    pendingMap.set(hot, sourceSet);\n    hot.on('connection', () => {\n      for (const source of sourceSet!) {\n        hot.send({\n          type: 'custom',\n          event: 'hot-import',\n          data: source,\n        });\n      }\n    });\n  }\n  sourceSet.add(source);\n  hot.send({ type: 'custom', event: 'hot-import', data: source });\n}\n\nconst modulePendingMap = new WeakMap<\n  ReturnType<typeof viteHot>,\n  Map<string, ModuleImportResult>\n>();\n\nfunction moduleImport(viteServer: ViteDevServer, result: ModuleImportResult) {\n  const hot = viteHot(viteServer);\n  let sources = modulePendingMap.get(hot);\n  if (!sources) {\n    sources = new Map();\n    modulePendingMap.set(hot, sources);\n  }\n  sources.set(result.id, result);\n  hot.send({ type: 'custom', event: 'module-import', data: result });\n}\n\nasync function generateInitialScripts(\n  viteServer: ViteDevServer,\n): Promise<HtmlTagDescriptor[]> {\n  const hot = viteHot(viteServer);\n  const sources = modulePendingMap.get(hot);\n\n  if (!sources) {\n    return [];\n  }\n\n  const scripts: HtmlTagDescriptor[] = [];\n\n  for (const result of sources.values()) {\n    scripts.push({\n      tag: 'script',\n      attrs: {\n        type: 'module',\n        async: true,\n        blocking: 'render',\n        'waku-module-id': result.id,\n      },\n      children: result.code,\n      injectTo: 'head',\n    });\n  }\n  return scripts;\n}\n\nexport type HotUpdatePayload =\n  | { type: 'full-reload' }\n  | { type: 'custom'; event: 'rsc-reload' }\n  | { type: 'custom'; event: 'hot-import'; data: string }\n  | { type: 'custom'; event: 'module-import'; data: ModuleImportResult };\n\nexport function hotUpdate(vite: ViteDevServer, payload: HotUpdatePayload) {\n  const hot = viteHot(vite);\n  if (payload.type === 'full-reload') {\n    hot.send(payload);\n  } else if (payload.event === 'rsc-reload') {\n    hot.send(payload);\n  } else if (payload.event === 'hot-import') {\n    hotImport(vite, payload.data);\n  } else if (payload.event === 'module-import') {\n    moduleImport(vite, payload.data);\n  }\n}\n\nfunction handleModuleUpdate(filePath: string, viteServer: ViteDevServer) {\n  const moduleLoading = (globalThis as any).__WAKU_CLIENT_MODULE_LOADING__;\n  const moduleCache = (globalThis as any).__WAKU_CLIENT_MODULE_CACHE__;\n  if (!moduleLoading || !moduleCache) {\n    return;\n  }\n\n  const normalizedPath = filePath.startsWith(viteServer.config.root + '/')\n    ? filePath.slice(viteServer.config.root.length + 1)\n    : filePath;\n  const id = filePathToFileURL(normalizedPath);\n  if (moduleLoading.has(id)) {\n    moduleLoading.set(\n      id,\n      viteServer.ssrLoadModule(normalizedPath).then((m) => {\n        // XXX There can be a race condition, but it should be very rare.\n        moduleCache.set(id, m);\n      }),\n    );\n  }\n}\n"],"names":["joinPath","fileURLToFilePath","decodeFilePathFromAbsolute","filePathToFileURL","injectingHmrCode","rscHmrPlugin","wakuMinimalClientDist","url","wakuRouterClientDist","viteServer","name","enforce","configureServer","server","transformIndexHtml","generateInitialScripts","tag","attrs","type","async","children","injectTo","transform","code","id","startsWith","replace","m","handleHotUpdate","file","endsWith","handleModuleUpdate","module","moduleGraph","getModuleById","importers","forEach","importer","pendingMap","WeakMap","viteHot","hot","ws","hotImport","source","sourceSet","get","Set","set","on","send","event","data","add","modulePendingMap","moduleImport","result","sources","Map","scripts","values","push","blocking","hotUpdate","vite","payload","filePath","moduleLoading","globalThis","__WAKU_CLIENT_MODULE_LOADING__","moduleCache","__WAKU_CLIENT_MODULE_CACHE__","normalizedPath","config","root","slice","length","has","ssrLoadModule","then"],"mappings":"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"}