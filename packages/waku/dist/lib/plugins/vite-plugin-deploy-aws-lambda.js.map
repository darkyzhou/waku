{"version":3,"sources":["../../../src/lib/plugins/vite-plugin-deploy-aws-lambda.ts"],"sourcesContent":["import path from 'node:path';\nimport { writeFileSync } from 'node:fs';\nimport type { Plugin } from 'vite';\n\nimport {\n  unstable_getBuildOptions,\n  unstable_builderConstants,\n} from '../../server.js';\n\nconst { SRC_ENTRIES, DIST_PUBLIC } = unstable_builderConstants;\nconst SERVE_JS = 'serve-aws-lambda.js';\n\nconst lambdaStreaming = process.env.DEPLOY_AWS_LAMBDA_STREAMING === 'true';\n\nconst getServeJsContent = (\n  distDir: string,\n  distPublic: string,\n  srcEntriesFile: string,\n) => `\nimport path from 'node:path';\nimport { existsSync, readFileSync } from 'node:fs';\nimport {\n  serverEngine,\n  importHono,\n  importHonoNodeServerServeStatic,\n  importHonoAwsLambda,\n} from 'waku/unstable_hono';\n\nconst { Hono } = await importHono();\nconst { serveStatic } = await importHonoNodeServerServeStatic();\nconst { ${lambdaStreaming ? 'streamHandle:' : ''}handle } = await importHonoAwsLambda();\n\nconst distDir = '${distDir}';\nconst publicDir = '${distPublic}';\nconst loadEntries = () => import('${srcEntriesFile}');\n\nconst configPromise = loadEntries().then((entries) => entries.loadConfig());\n\nconst createApp = (app) => {\n  app.use(serveStatic({ root: distDir + '/' + publicDir }));\n  app.use(serverEngine({ cmd: 'start', loadEntries, env: process.env, unstable_onError: new Set() }));\n  app.notFound(async (c) => {\n    const file = path.join(distDir, publicDir, '404.html');\n    if (existsSync(file)) {\n      return c.html(readFileSync(file, 'utf8'), 404);\n    }\n    return c.text('404 Not Found', 404);\n  });\n  return app;\n};\n\nconst honoEnhancer =\n  (await configPromise).unstable_honoEnhancer || ((createApp) => createApp);\n\nexport const handler = handle(honoEnhancer(createApp)(new Hono()));\n`;\n\nexport function deployAwsLambdaPlugin(opts: {\n  srcDir: string;\n  distDir: string;\n}): Plugin {\n  const buildOptions = unstable_getBuildOptions();\n  let entriesFile: string;\n  return {\n    name: 'deploy-aws-lambda-plugin',\n    config(viteConfig) {\n      const { deploy, unstable_phase } = buildOptions;\n      if (unstable_phase !== 'buildServerBundle' || deploy !== 'aws-lambda') {\n        return;\n      }\n      const { input } = viteConfig.build?.rollupOptions ?? {};\n      if (input && !(typeof input === 'string') && !(input instanceof Array)) {\n        input[SERVE_JS.replace(/\\.js$/, '')] = `${opts.srcDir}/${SERVE_JS}`;\n      }\n    },\n    configResolved(config) {\n      entriesFile = `${config.root}/${opts.srcDir}/${SRC_ENTRIES}`;\n    },\n    resolveId(source) {\n      if (source === `${opts.srcDir}/${SERVE_JS}`) {\n        return source;\n      }\n    },\n    load(id) {\n      if (id === `${opts.srcDir}/${SERVE_JS}`) {\n        return getServeJsContent(opts.distDir, DIST_PUBLIC, entriesFile);\n      }\n    },\n    closeBundle() {\n      const { deploy, unstable_phase } = buildOptions;\n      if (unstable_phase !== 'buildDeploy' || deploy !== 'aws-lambda') {\n        return;\n      }\n\n      writeFileSync(\n        path.join(opts.distDir, 'package.json'),\n        JSON.stringify({ type: 'module' }, null, 2),\n      );\n    },\n  };\n}\n"],"names":["path","writeFileSync","unstable_getBuildOptions","unstable_builderConstants","SRC_ENTRIES","DIST_PUBLIC","SERVE_JS","lambdaStreaming","process","env","DEPLOY_AWS_LAMBDA_STREAMING","getServeJsContent","distDir","distPublic","srcEntriesFile","deployAwsLambdaPlugin","opts","buildOptions","entriesFile","name","config","viteConfig","deploy","unstable_phase","input","build","rollupOptions","Array","replace","srcDir","configResolved","root","resolveId","source","load","id","closeBundle","join","JSON","stringify","type"],"mappings":"AAAA,OAAOA,UAAU,YAAY;AAC7B,SAASC,aAAa,QAAQ,UAAU;AAGxC,SACEC,wBAAwB,EACxBC,yBAAyB,QACpB,kBAAkB;AAEzB,MAAM,EAAEC,WAAW,EAAEC,WAAW,EAAE,GAAGF;AACrC,MAAMG,WAAW;AAEjB,MAAMC,kBAAkBC,QAAQC,GAAG,CAACC,2BAA2B,KAAK;AAEpE,MAAMC,oBAAoB,CACxBC,SACAC,YACAC,iBACG,CAAC;;;;;;;;;;;;QAYE,EAAEP,kBAAkB,kBAAkB,GAAG;;iBAEhC,EAAEK,QAAQ;mBACR,EAAEC,WAAW;kCACE,EAAEC,eAAe;;;;;;;;;;;;;;;;;;;;;AAqBnD,CAAC;AAED,OAAO,SAASC,sBAAsBC,IAGrC;IACC,MAAMC,eAAef;IACrB,IAAIgB;IACJ,OAAO;QACLC,MAAM;QACNC,QAAOC,UAAU;YACf,MAAM,EAAEC,MAAM,EAAEC,cAAc,EAAE,GAAGN;YACnC,IAAIM,mBAAmB,uBAAuBD,WAAW,cAAc;gBACrE;YACF;YACA,MAAM,EAAEE,KAAK,EAAE,GAAGH,WAAWI,KAAK,EAAEC,iBAAiB,CAAC;YACtD,IAAIF,SAAS,CAAE,CAAA,OAAOA,UAAU,QAAO,KAAM,CAAEA,CAAAA,iBAAiBG,KAAI,GAAI;gBACtEH,KAAK,CAAClB,SAASsB,OAAO,CAAC,SAAS,IAAI,GAAG,GAAGZ,KAAKa,MAAM,CAAC,CAAC,EAAEvB,UAAU;YACrE;QACF;QACAwB,gBAAeV,MAAM;YACnBF,cAAc,GAAGE,OAAOW,IAAI,CAAC,CAAC,EAAEf,KAAKa,MAAM,CAAC,CAAC,EAAEzB,aAAa;QAC9D;QACA4B,WAAUC,MAAM;YACd,IAAIA,WAAW,GAAGjB,KAAKa,MAAM,CAAC,CAAC,EAAEvB,UAAU,EAAE;gBAC3C,OAAO2B;YACT;QACF;QACAC,MAAKC,EAAE;YACL,IAAIA,OAAO,GAAGnB,KAAKa,MAAM,CAAC,CAAC,EAAEvB,UAAU,EAAE;gBACvC,OAAOK,kBAAkBK,KAAKJ,OAAO,EAAEP,aAAaa;YACtD;QACF;QACAkB;YACE,MAAM,EAAEd,MAAM,EAAEC,cAAc,EAAE,GAAGN;YACnC,IAAIM,mBAAmB,iBAAiBD,WAAW,cAAc;gBAC/D;YACF;YAEArB,cACED,KAAKqC,IAAI,CAACrB,KAAKJ,OAAO,EAAE,iBACxB0B,KAAKC,SAAS,CAAC;gBAAEC,MAAM;YAAS,GAAG,MAAM;QAE7C;IACF;AACF"}