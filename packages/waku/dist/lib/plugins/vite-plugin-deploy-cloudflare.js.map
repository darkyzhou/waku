{"version":3,"sources":["../../../src/lib/plugins/vite-plugin-deploy-cloudflare.ts"],"sourcesContent":["import { randomBytes } from 'node:crypto';\nimport {\n  copyFileSync,\n  existsSync,\n  mkdirSync,\n  readdirSync,\n  rmSync,\n  writeFileSync,\n} from 'node:fs';\nimport os from 'node:os';\nimport path from 'node:path';\n\nimport type { Plugin } from 'vite';\n\nimport { emitPlatformData } from '../builder/platform-data.js';\nimport {\n  unstable_getBuildOptions,\n  unstable_builderConstants,\n} from '../../server.js';\n\nconst { SRC_ENTRIES, DIST_PUBLIC } = unstable_builderConstants;\nconst SERVE_JS = 'serve-cloudflare.js';\n\nconst getServeJsContent = (\n  srcEntriesFile: string,\n  honoEnhancerFile: string | undefined,\n) => `\nimport { serverEngine, importHono } from 'waku/unstable_hono';\n\nconst { Hono } = await importHono();\n\nconst loadEntries = () => import('${srcEntriesFile}');\nconst loadHonoEnhancer = async () => {\n  ${\n    honoEnhancerFile\n      ? `return (await import('${honoEnhancerFile}')).default;`\n      : `return (fn) => fn;`\n  }\n};\nlet serve;\nlet app;\n\nconst createApp = (app) => {\n  app.use((c, next) => serve(c, next));\n  app.notFound(async (c) => {\n    const assetsFetcher = c.env.ASSETS;\n    const url = new URL(c.req.raw.url);\n    const errorHtmlUrl = url.origin + '/404.html';\n    const notFoundStaticAssetResponse = await assetsFetcher.fetch(\n      new URL(errorHtmlUrl),\n    );\n    if (\n      notFoundStaticAssetResponse &&\n      notFoundStaticAssetResponse.status < 400\n    ) {\n      return c.body(notFoundStaticAssetResponse.body, 404);\n    }\n    return c.text('404 Not Found', 404);\n  });\n  return app;\n};\n\nexport default {\n  async fetch(request, env, ctx) {\n    if (!serve) {\n      serve = serverEngine({ cmd: 'start', loadEntries, env, unstable_onError: new Set() });\n    }\n    if (!app) {\n      const honoEnhancer = await loadHonoEnhancer();\n      app = honoEnhancer(createApp)(new Hono());\n    }\n    return app.fetch(request, env, ctx);\n  },\n};\n`;\n\nfunction copyFiles(srcDir: string, destDir: string, extensions: string[]) {\n  const files = readdirSync(srcDir, { withFileTypes: true });\n  for (const file of files) {\n    const srcPath = path.join(srcDir, file.name);\n    const destPath = path.join(destDir, file.name);\n    if (file.isDirectory()) {\n      mkdirSync(destPath, { recursive: true });\n      copyFiles(srcPath, destPath, extensions);\n    } else if (extensions.some((ext) => file.name.endsWith(ext))) {\n      copyFileSync(srcPath, destPath);\n    }\n  }\n}\n\nfunction copyDirectory(srcDir: string, destDir: string) {\n  const files = readdirSync(srcDir, { withFileTypes: true });\n  for (const file of files) {\n    const srcPath = path.join(srcDir, file.name);\n    const destPath = path.join(destDir, file.name);\n    if (file.isDirectory()) {\n      mkdirSync(destPath, { recursive: true });\n      copyDirectory(srcPath, destPath);\n    } else {\n      copyFileSync(srcPath, destPath);\n    }\n  }\n}\n\nfunction separatePublicAssetsFromFunctions({\n  outDir,\n  functionDir,\n  assetsDir,\n}: {\n  outDir: string;\n  functionDir: string;\n  assetsDir: string;\n}) {\n  const tempDist = path.join(\n    os.tmpdir(),\n    `dist_${randomBytes(16).toString('hex')}`,\n  );\n  const tempPublicDir = path.join(tempDist, DIST_PUBLIC);\n  const workerPublicDir = path.join(functionDir, DIST_PUBLIC);\n\n  // Create a temp dir to prepare the separated files\n  rmSync(tempDist, { recursive: true, force: true });\n  mkdirSync(tempDist, { recursive: true });\n\n  // Move the current dist dir to the temp dir\n  // Folders are copied instead of moved to avoid issues on Windows\n  copyDirectory(outDir, tempDist);\n  rmSync(outDir, { recursive: true, force: true });\n\n  // Create empty directories at the desired deploy locations\n  // for the function and the assets\n  mkdirSync(functionDir, { recursive: true });\n  mkdirSync(assetsDir, { recursive: true });\n\n  // Move tempDist/public to assetsDir\n  copyDirectory(tempPublicDir, assetsDir);\n  rmSync(tempPublicDir, { recursive: true, force: true });\n\n  // Move tempDist to functionDir\n  copyDirectory(tempDist, functionDir);\n  rmSync(tempDist, { recursive: true, force: true });\n\n  // Traverse assetsDir and copy specific files to functionDir/public\n  mkdirSync(workerPublicDir, { recursive: true });\n  copyFiles(assetsDir, workerPublicDir, [\n    '.txt',\n    '.html',\n    '.json',\n    '.js',\n    '.css',\n  ]);\n}\n\nexport function deployCloudflarePlugin(opts: {\n  srcDir: string;\n  distDir: string;\n  privateDir: string;\n  unstable_honoEnhancer: string | undefined;\n}): Plugin {\n  const buildOptions = unstable_getBuildOptions();\n  let rootDir: string;\n  let entriesFile: string;\n  let honoEnhancerFile: string | undefined;\n  return {\n    name: 'deploy-cloudflare-plugin',\n    config(viteConfig) {\n      const { deploy, unstable_phase } = buildOptions;\n      if (unstable_phase !== 'buildServerBundle' || deploy !== 'cloudflare') {\n        return;\n      }\n      const { input } = viteConfig.build?.rollupOptions ?? {};\n      if (input && !(typeof input === 'string') && !(input instanceof Array)) {\n        input[SERVE_JS.replace(/\\.js$/, '')] = `${opts.srcDir}/${SERVE_JS}`;\n      }\n    },\n    configResolved(config) {\n      rootDir = config.root;\n      entriesFile = `${rootDir}/${opts.srcDir}/${SRC_ENTRIES}`;\n      if (opts.unstable_honoEnhancer) {\n        honoEnhancerFile = `${rootDir}/${opts.unstable_honoEnhancer}`;\n      }\n      const { deploy, unstable_phase } = buildOptions;\n      if (\n        (unstable_phase !== 'buildServerBundle' &&\n          unstable_phase !== 'buildSsrBundle') ||\n        deploy !== 'cloudflare'\n      ) {\n        return;\n      }\n      config.ssr.target = 'webworker';\n      config.ssr.resolve ||= {};\n      config.ssr.resolve.conditions ||= [];\n      config.ssr.resolve.conditions.push('worker');\n      config.ssr.resolve.externalConditions ||= [];\n      config.ssr.resolve.externalConditions.push('worker');\n    },\n    resolveId(source) {\n      if (source === `${opts.srcDir}/${SERVE_JS}`) {\n        return source;\n      }\n    },\n    load(id) {\n      if (id === `${opts.srcDir}/${SERVE_JS}`) {\n        return getServeJsContent(entriesFile, honoEnhancerFile);\n      }\n    },\n    async closeBundle() {\n      const { deploy, unstable_phase } = buildOptions;\n      if (unstable_phase !== 'buildDeploy' || deploy !== 'cloudflare') {\n        return;\n      }\n\n      const outDir = path.join(rootDir, opts.distDir);\n      const assetsDistDir = path.join(outDir, 'assets');\n      const workerDistDir = path.join(outDir, 'worker');\n\n      // Move the public static assets to a separate folder from the server files\n      separatePublicAssetsFromFunctions({\n        outDir,\n        assetsDir: assetsDistDir,\n        functionDir: workerDistDir,\n      });\n\n      await emitPlatformData(workerDistDir);\n\n      const wranglerTomlFile = path.join(rootDir, 'wrangler.toml');\n      const wranglerJsonFile = path.join(rootDir, 'wrangler.json');\n      const wranglerJsoncFile = path.join(rootDir, 'wrangler.jsonc');\n      if (\n        !existsSync(wranglerTomlFile) &&\n        !existsSync(wranglerJsonFile) &&\n        !existsSync(wranglerJsoncFile)\n      ) {\n        writeFileSync(\n          wranglerJsonFile,\n          `\n{\n  \"name\": \"waku-project\",\n  \"main\": \"./dist/worker/serve-cloudflare.js\",\n  // https://developers.cloudflare.com/workers/platform/compatibility-dates\n  \"compatibility_date\": \"2024-11-11\",\n  // nodejs_als is required for Waku server-side request context\n  // It can be removed if only building static pages\n  \"compatibility_flags\": [\"nodejs_als\"],\n  // https://developers.cloudflare.com/workers/static-assets/binding/\n  \"assets\": {\n    \"binding\": \"ASSETS\",\n    \"directory\": \"./dist/assets\",\n    \"html_handling\": \"drop-trailing-slash\",\n    \"not_found_handling\": \"404-page\",\n  }\n}\n`,\n        );\n      }\n    },\n  };\n}\n"],"names":["randomBytes","copyFileSync","existsSync","mkdirSync","readdirSync","rmSync","writeFileSync","os","path","emitPlatformData","unstable_getBuildOptions","unstable_builderConstants","SRC_ENTRIES","DIST_PUBLIC","SERVE_JS","getServeJsContent","srcEntriesFile","honoEnhancerFile","copyFiles","srcDir","destDir","extensions","files","withFileTypes","file","srcPath","join","name","destPath","isDirectory","recursive","some","ext","endsWith","copyDirectory","separatePublicAssetsFromFunctions","outDir","functionDir","assetsDir","tempDist","tmpdir","toString","tempPublicDir","workerPublicDir","force","deployCloudflarePlugin","opts","buildOptions","rootDir","entriesFile","config","viteConfig","deploy","unstable_phase","input","build","rollupOptions","Array","replace","configResolved","root","unstable_honoEnhancer","ssr","target","resolve","conditions","push","externalConditions","resolveId","source","load","id","closeBundle","distDir","assetsDistDir","workerDistDir","wranglerTomlFile","wranglerJsonFile","wranglerJsoncFile"],"mappings":"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"}