{"version":3,"sources":["../../../src/lib/plugins/vite-plugin-rsc-managed.ts"],"sourcesContent":["import type { Plugin } from 'vite';\n\nimport { EXTENSIONS, SRC_MAIN, SRC_ENTRIES } from '../builder/constants.js';\nimport { extname, joinPath, filePathToFileURL } from '../utils/path.js';\n\nconst stripExt = (fname: string) => {\n  const ext = extname(fname);\n  return ext ? fname.slice(0, -ext.length) : fname;\n};\n\nconst getManagedEntries = (\n  filePath: string,\n  srcDir: string,\n  options: { pagesDir: string; apiDir: string },\n) => `\nimport { unstable_fsRouter as fsRouter } from 'waku/router/server';\n\nexport default fsRouter(\n  '${filePathToFileURL(filePath)}',\n  (file) => import.meta.glob('/${srcDir}/pages/**/*.{${EXTENSIONS.map((ext) =>\n    ext.replace(/^\\./, ''),\n  ).join(',')}}')[\\`/${srcDir}/pages/\\${file}\\`]?.(),\n  { pagesDir: '${options.pagesDir}', apiDir: '${options.apiDir}' },\n);\n`;\n\nconst getManagedMain = () => `\nimport { StrictMode, createElement } from 'react';\nimport { createRoot, hydrateRoot } from 'react-dom/client';\nimport { Router } from 'waku/router/client';\n\nconst rootElement = createElement(StrictMode, null, createElement(Router));\n\nif (globalThis.__WAKU_HYDRATE__) {\n  hydrateRoot(document, rootElement);\n} else {\n  createRoot(document).render(rootElement);\n}\n`;\n\nexport function rscManagedPlugin(opts: {\n  basePath: string;\n  srcDir: string;\n  pagesDir: string;\n  apiDir: string;\n  addEntriesToInput?: boolean;\n  addMainToInput?: boolean;\n}): Plugin {\n  let entriesFile: string | undefined;\n  let mainFile: string | undefined;\n  const mainPath = `${opts.basePath}${opts.srcDir}/${SRC_MAIN}`;\n  return {\n    name: 'rsc-managed-plugin',\n    enforce: 'pre',\n    configResolved(config) {\n      entriesFile = joinPath(config.root, opts.srcDir, SRC_ENTRIES);\n      mainFile = joinPath(config.root, opts.srcDir, SRC_MAIN);\n    },\n    options(options) {\n      if (typeof options.input === 'string') {\n        throw new Error('string input is unsupported');\n      }\n      if (Array.isArray(options.input)) {\n        throw new Error('array input is unsupported');\n      }\n      return {\n        ...options,\n        input: {\n          ...(opts.addEntriesToInput && { entries: entriesFile! }),\n          ...(opts.addMainToInput && { main: mainFile! }),\n          ...options.input,\n        },\n      };\n    },\n    async resolveId(id, importer, options) {\n      const resolved = await this.resolve(id, importer, options);\n      if (!resolved || resolved.id === id) {\n        if (id === entriesFile) {\n          return '\\0' + entriesFile + '.js';\n        }\n        if (id === mainFile) {\n          return '\\0' + mainFile + '.js';\n        }\n        if (stripExt(id) === mainPath) {\n          return '\\0' + mainPath + '.js';\n        }\n      }\n    },\n    load(id) {\n      if (id === '\\0' + entriesFile + '.js') {\n        return getManagedEntries(entriesFile + '.js', opts.srcDir, {\n          apiDir: opts.apiDir,\n          pagesDir: opts.pagesDir,\n        });\n      }\n      if (id === '\\0' + mainFile + '.js' || id === '\\0' + mainPath + '.js') {\n        return getManagedMain();\n      }\n    },\n  };\n}\n"],"names":["EXTENSIONS","SRC_MAIN","SRC_ENTRIES","extname","joinPath","filePathToFileURL","stripExt","fname","ext","slice","length","getManagedEntries","filePath","srcDir","options","map","replace","join","pagesDir","apiDir","getManagedMain","rscManagedPlugin","opts","entriesFile","mainFile","mainPath","basePath","name","enforce","configResolved","config","root","input","Error","Array","isArray","addEntriesToInput","entries","addMainToInput","main","resolveId","id","importer","resolved","resolve","load"],"mappings":"AAEA,SAASA,UAAU,EAAEC,QAAQ,EAAEC,WAAW,QAAQ,0BAA0B;AAC5E,SAASC,OAAO,EAAEC,QAAQ,EAAEC,iBAAiB,QAAQ,mBAAmB;AAExE,MAAMC,WAAW,CAACC;IAChB,MAAMC,MAAML,QAAQI;IACpB,OAAOC,MAAMD,MAAME,KAAK,CAAC,GAAG,CAACD,IAAIE,MAAM,IAAIH;AAC7C;AAEA,MAAMI,oBAAoB,CACxBC,UACAC,QACAC,UACG,CAAC;;;;GAIH,EAAET,kBAAkBO,UAAU;+BACF,EAAEC,OAAO,aAAa,EAAEb,WAAWe,GAAG,CAAC,CAACP,MACnEA,IAAIQ,OAAO,CAAC,OAAO,KACnBC,IAAI,CAAC,KAAK,OAAO,EAAEJ,OAAO;eACf,EAAEC,QAAQI,QAAQ,CAAC,YAAY,EAAEJ,QAAQK,MAAM,CAAC;;AAE/D,CAAC;AAED,MAAMC,iBAAiB,IAAM,CAAC;;;;;;;;;;;;AAY9B,CAAC;AAED,OAAO,SAASC,iBAAiBC,IAOhC;IACC,IAAIC;IACJ,IAAIC;IACJ,MAAMC,WAAW,GAAGH,KAAKI,QAAQ,GAAGJ,KAAKT,MAAM,CAAC,CAAC,EAAEZ,UAAU;IAC7D,OAAO;QACL0B,MAAM;QACNC,SAAS;QACTC,gBAAeC,MAAM;YACnBP,cAAcnB,SAAS0B,OAAOC,IAAI,EAAET,KAAKT,MAAM,EAAEX;YACjDsB,WAAWpB,SAAS0B,OAAOC,IAAI,EAAET,KAAKT,MAAM,EAAEZ;QAChD;QACAa,SAAQA,OAAO;YACb,IAAI,OAAOA,QAAQkB,KAAK,KAAK,UAAU;gBACrC,MAAM,IAAIC,MAAM;YAClB;YACA,IAAIC,MAAMC,OAAO,CAACrB,QAAQkB,KAAK,GAAG;gBAChC,MAAM,IAAIC,MAAM;YAClB;YACA,OAAO;gBACL,GAAGnB,OAAO;gBACVkB,OAAO;oBACL,GAAIV,KAAKc,iBAAiB,IAAI;wBAAEC,SAASd;oBAAa,CAAC;oBACvD,GAAID,KAAKgB,cAAc,IAAI;wBAAEC,MAAMf;oBAAU,CAAC;oBAC9C,GAAGV,QAAQkB,KAAK;gBAClB;YACF;QACF;QACA,MAAMQ,WAAUC,EAAE,EAAEC,QAAQ,EAAE5B,OAAO;YACnC,MAAM6B,WAAW,MAAM,IAAI,CAACC,OAAO,CAACH,IAAIC,UAAU5B;YAClD,IAAI,CAAC6B,YAAYA,SAASF,EAAE,KAAKA,IAAI;gBACnC,IAAIA,OAAOlB,aAAa;oBACtB,OAAO,OAAOA,cAAc;gBAC9B;gBACA,IAAIkB,OAAOjB,UAAU;oBACnB,OAAO,OAAOA,WAAW;gBAC3B;gBACA,IAAIlB,SAASmC,QAAQhB,UAAU;oBAC7B,OAAO,OAAOA,WAAW;gBAC3B;YACF;QACF;QACAoB,MAAKJ,EAAE;YACL,IAAIA,OAAO,OAAOlB,cAAc,OAAO;gBACrC,OAAOZ,kBAAkBY,cAAc,OAAOD,KAAKT,MAAM,EAAE;oBACzDM,QAAQG,KAAKH,MAAM;oBACnBD,UAAUI,KAAKJ,QAAQ;gBACzB;YACF;YACA,IAAIuB,OAAO,OAAOjB,WAAW,SAASiB,OAAO,OAAOhB,WAAW,OAAO;gBACpE,OAAOL;YACT;QACF;IACF;AACF"}