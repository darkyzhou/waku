{"version":3,"sources":["../../../src/lib/plugins/vite-plugin-rsc-entries.ts"],"sourcesContent":["import { existsSync } from 'node:fs';\nimport path from 'node:path';\nimport { normalizePath } from 'vite';\nimport type { Plugin } from 'vite';\n\nimport { SRC_ENTRIES } from '../builder/constants.js';\nimport { extname, joinPath } from '../utils/path.js';\nimport { treeshake, removeObjectProperty } from '../utils/treeshake.js';\n\nconst stripExt = (fname: string) => {\n  const ext = extname(fname);\n  return ext ? fname.slice(0, -ext.length) : fname;\n};\n\nconst CONFIG_FILE = 'waku.config.ts'; // XXX only ts extension\n\nexport function rscEntriesPlugin(opts: {\n  basePath: string;\n  rscBase: string;\n  middleware: string[];\n  rootDir: string;\n  srcDir: string;\n  ssrDir: string;\n  moduleMap: Record<string, string>;\n}): Plugin {\n  const codeToPrepend = `\ntry {\n  globalThis.AsyncLocalStorage = require('node:async_hooks').AsyncLocalStorage;\n} catch {}\n`;\n  const codeToAppend = `\nexport const configPrd = {\n  basePath: '${opts.basePath}',\n  rscBase: '${opts.rscBase}',\n};\nexport function loadMiddleware() {\n  return Promise.all([\n    ${opts.middleware\n      .map(\n        (m) => `import('${m.startsWith('./') ? `${opts.rootDir}/${m}` : m}')`,\n      )\n      .join(',\\n')}\n  ]);\n};\nexport function loadModule(id) {\n  switch (id) {\n    ${Object.entries(opts.moduleMap)\n      .map(\n        ([k, v]) =>\n          `case '${k}': return import(${v.startsWith('./') ? \"'' + \" : ''}'${v}');`,\n      )\n      .join('\\n')}\n    default: throw new Error('Cannot find module: ' + id);\n  }\n}\nglobalThis.__WAKU_SERVER_IMPORT__ = loadModule;\nglobalThis.__WAKU_CLIENT_IMPORT__ = (id) => loadModule('${opts.ssrDir}/' + id);\nexport const defaultHtmlHead = globalThis.__WAKU_DEFAULT_HTML_HEAD__;\nexport const dynamicHtmlPaths = globalThis.__WAKU_DYNAMIC_HTML_PATHS__;\nexport const publicIndexHtml = globalThis.__WAKU_PUBLIC_INDEX_HTML__;\nexport const loadPlatformData = globalThis.__WAKU_LOAD_PLATFORM_DATA__;\n`;\n  let entriesFile = '';\n  let configFile = '';\n  return {\n    name: 'rsc-entries-plugin',\n    configResolved(config) {\n      entriesFile = joinPath(config.root, opts.srcDir, SRC_ENTRIES);\n      if (existsSync(CONFIG_FILE)) {\n        configFile = normalizePath(path.resolve(CONFIG_FILE));\n      }\n    },\n    transform(code, id) {\n      if (\n        // FIXME this is too hacky and not the right place to patch\n        id.endsWith('/react-server-dom-webpack-server.edge.production.js')\n      ) {\n        return codeToPrepend + code;\n      }\n      if (stripExt(id).endsWith(entriesFile)) {\n        return code + codeToAppend;\n      }\n      if (id === configFile) {\n        // FIXME this naively removes code with object key name\n        return treeshake(code, removeObjectProperty('unstable_viteConfigs'));\n      }\n    },\n  };\n}\n"],"names":["existsSync","path","normalizePath","SRC_ENTRIES","extname","joinPath","treeshake","removeObjectProperty","stripExt","fname","ext","slice","length","CONFIG_FILE","rscEntriesPlugin","opts","codeToPrepend","codeToAppend","basePath","rscBase","middleware","map","m","startsWith","rootDir","join","Object","entries","moduleMap","k","v","ssrDir","entriesFile","configFile","name","configResolved","config","root","srcDir","resolve","transform","code","id","endsWith"],"mappings":"AAAA,SAASA,UAAU,QAAQ,UAAU;AACrC,OAAOC,UAAU,YAAY;AAC7B,SAASC,aAAa,QAAQ,OAAO;AAGrC,SAASC,WAAW,QAAQ,0BAA0B;AACtD,SAASC,OAAO,EAAEC,QAAQ,QAAQ,mBAAmB;AACrD,SAASC,SAAS,EAAEC,oBAAoB,QAAQ,wBAAwB;AAExE,MAAMC,WAAW,CAACC;IAChB,MAAMC,MAAMN,QAAQK;IACpB,OAAOC,MAAMD,MAAME,KAAK,CAAC,GAAG,CAACD,IAAIE,MAAM,IAAIH;AAC7C;AAEA,MAAMI,cAAc,kBAAkB,wBAAwB;AAE9D,OAAO,SAASC,iBAAiBC,IAQhC;IACC,MAAMC,gBAAgB,CAAC;;;;AAIzB,CAAC;IACC,MAAMC,eAAe,CAAC;;aAEX,EAAEF,KAAKG,QAAQ,CAAC;YACjB,EAAEH,KAAKI,OAAO,CAAC;;;;IAIvB,EAAEJ,KAAKK,UAAU,CACdC,GAAG,CACF,CAACC,IAAM,CAAC,QAAQ,EAAEA,EAAEC,UAAU,CAAC,QAAQ,GAAGR,KAAKS,OAAO,CAAC,CAAC,EAAEF,GAAG,GAAGA,EAAE,EAAE,CAAC,EAEtEG,IAAI,CAAC,OAAO;;;;;IAKf,EAAEC,OAAOC,OAAO,CAACZ,KAAKa,SAAS,EAC5BP,GAAG,CACF,CAAC,CAACQ,GAAGC,EAAE,GACL,CAAC,MAAM,EAAED,EAAE,iBAAiB,EAAEC,EAAEP,UAAU,CAAC,QAAQ,UAAU,GAAG,CAAC,EAAEO,EAAE,GAAG,CAAC,EAE5EL,IAAI,CAAC,MAAM;;;;;wDAKsC,EAAEV,KAAKgB,MAAM,CAAC;;;;;AAKtE,CAAC;IACC,IAAIC,cAAc;IAClB,IAAIC,aAAa;IACjB,OAAO;QACLC,MAAM;QACNC,gBAAeC,MAAM;YACnBJ,cAAc3B,SAAS+B,OAAOC,IAAI,EAAEtB,KAAKuB,MAAM,EAAEnC;YACjD,IAAIH,WAAWa,cAAc;gBAC3BoB,aAAa/B,cAAcD,KAAKsC,OAAO,CAAC1B;YAC1C;QACF;QACA2B,WAAUC,IAAI,EAAEC,EAAE;YAChB,IACE,2DAA2D;YAC3DA,GAAGC,QAAQ,CAAC,wDACZ;gBACA,OAAO3B,gBAAgByB;YACzB;YACA,IAAIjC,SAASkC,IAAIC,QAAQ,CAACX,cAAc;gBACtC,OAAOS,OAAOxB;YAChB;YACA,IAAIyB,OAAOT,YAAY;gBACrB,uDAAuD;gBACvD,OAAO3B,UAAUmC,MAAMlC,qBAAqB;YAC9C;QACF;IACF;AACF"}