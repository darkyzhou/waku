{"version":3,"sources":["../../../src/lib/plugins/vite-plugin-dev-commonjs.ts"],"sourcesContent":["import { transformWithEsbuild } from 'vite';\nimport type { Plugin } from 'vite';\n\nimport { EXTENSIONS } from '../builder/constants.js';\nimport { extname } from '../utils/path.js';\n\n// https://github.com/vite-plugin/vite-plugin-commonjs/blob/5e3294e78fabb037e12aab75433908fbee17192a/src/utils.ts#L9-L15\nconst isCommonjs = (code: string) =>\n  /\\b(?:require|module|exports)\\b/.test(\n    code.replace(/\\/\\*(.|[\\r\\n])*?\\*\\//gm, '').replace(/\\/\\/.*/g, ''),\n  );\n\nexport function devCommonJsPlugin(opts: {\n  filter?: (id: string) => boolean | undefined;\n}): Plugin {\n  return {\n    name: 'dev-commonjs-plugin',\n    async transform(code, id) {\n      if (opts.filter) {\n        if (!opts.filter(id)) {\n          return;\n        }\n      } else {\n        const ext = extname(id.split('?')[0]!);\n        if (!EXTENSIONS.includes(ext)) {\n          return;\n        }\n        if (code.startsWith(\"import { createRequire } from 'module';\")) {\n          return;\n        }\n        if (!isCommonjs(code)) {\n          return;\n        }\n      }\n      const result = await transformWithEsbuild(code, id, {\n        format: 'esm',\n        banner: `\nimport { createRequire } from 'module';\nconst require = createRequire(import.meta.url);\n`,\n      });\n      return result;\n    },\n  };\n}\n"],"names":["transformWithEsbuild","EXTENSIONS","extname","isCommonjs","code","test","replace","devCommonJsPlugin","opts","name","transform","id","filter","ext","split","includes","startsWith","result","format","banner"],"mappings":"AAAA,SAASA,oBAAoB,QAAQ,OAAO;AAG5C,SAASC,UAAU,QAAQ,0BAA0B;AACrD,SAASC,OAAO,QAAQ,mBAAmB;AAE3C,wHAAwH;AACxH,MAAMC,aAAa,CAACC,OAClB,iCAAiCC,IAAI,CACnCD,KAAKE,OAAO,CAAC,0BAA0B,IAAIA,OAAO,CAAC,WAAW;AAGlE,OAAO,SAASC,kBAAkBC,IAEjC;IACC,OAAO;QACLC,MAAM;QACN,MAAMC,WAAUN,IAAI,EAAEO,EAAE;YACtB,IAAIH,KAAKI,MAAM,EAAE;gBACf,IAAI,CAACJ,KAAKI,MAAM,CAACD,KAAK;oBACpB;gBACF;YACF,OAAO;gBACL,MAAME,MAAMX,QAAQS,GAAGG,KAAK,CAAC,IAAI,CAAC,EAAE;gBACpC,IAAI,CAACb,WAAWc,QAAQ,CAACF,MAAM;oBAC7B;gBACF;gBACA,IAAIT,KAAKY,UAAU,CAAC,4CAA4C;oBAC9D;gBACF;gBACA,IAAI,CAACb,WAAWC,OAAO;oBACrB;gBACF;YACF;YACA,MAAMa,SAAS,MAAMjB,qBAAqBI,MAAMO,IAAI;gBAClDO,QAAQ;gBACRC,QAAQ,CAAC;;;AAGjB,CAAC;YACK;YACA,OAAOF;QACT;IACF;AACF"}