{"version":3,"sources":["../../../src/lib/plugins/vite-plugin-rsc-delegate.ts"],"sourcesContent":["import type { Plugin, ViteDevServer } from 'vite';\nimport * as swc from '@swc/core';\n\nimport { EXTENSIONS } from '../builder/constants.js';\nimport { extname } from '../utils/path.js';\nimport { parseOpts } from '../utils/swc.js';\nimport type { HotUpdatePayload } from './vite-plugin-rsc-hmr.js';\n\nconst isClientEntry = (id: string, code: string) => {\n  const ext = extname(id);\n  if (EXTENSIONS.includes(ext)) {\n    const mod = swc.parseSync(code, parseOpts(ext));\n    for (const item of mod.body) {\n      if (\n        item.type === 'ExpressionStatement' &&\n        item.expression.type === 'StringLiteral' &&\n        item.expression.value === 'use client'\n      ) {\n        return true;\n      }\n    }\n  }\n  return false;\n};\n\n// import { CSS_LANGS_RE } from \"vite/dist/node/constants.js\";\nconst CSS_LANGS_RE =\n  /\\.(css|less|sass|scss|styl|stylus|pcss|postcss|sss)(?:$|\\?)/;\n\nexport function rscDelegatePlugin(\n  callback: (payload: HotUpdatePayload) => void,\n): Plugin {\n  const moduleImports: Set<string> = new Set();\n  let mode = 'development';\n  let base = '/';\n  let server: ViteDevServer;\n  const updateStyle = async (id: string, importer: string) => {\n    const resolvedSource = await server.pluginContainer.resolveId(\n      id,\n      importer,\n      { ssr: true },\n    );\n    if (resolvedSource?.id) {\n      const { default: source } = await server.ssrLoadModule(resolvedSource.id);\n      const transformedResult = await server.transformRequest(\n        resolvedSource.id,\n      );\n      if (transformedResult) {\n        moduleImports.add(resolvedSource.id);\n        callback({\n          type: 'custom',\n          event: 'module-import',\n          data: {\n            ...transformedResult,\n            source,\n            id: resolvedSource.id,\n            css: true,\n          },\n        });\n      }\n    }\n  };\n  const styleFiles = new Map<string, string>(); // id -> importer\n  const updateAllStyles = async () => {\n    for (const [id, importer] of styleFiles) {\n      await updateStyle(id, importer);\n    }\n  };\n  return {\n    name: 'rsc-delegate-plugin',\n    configResolved(config) {\n      mode = config.mode;\n      base = config.base;\n    },\n    configureServer(serverInstance) {\n      server = serverInstance;\n    },\n    async handleHotUpdate(ctx) {\n      if (mode === 'development') {\n        if (ctx.file.endsWith('/pages.gen.ts')) {\n          // auto generated file by fsRouterTypegenPlugin\n          return [];\n        }\n        await updateAllStyles(); // FIXME is this too aggressive?\n        if (moduleImports.has(ctx.file)) {\n          // re-inject\n          const transformedResult = await server.transformRequest(ctx.file);\n          if (transformedResult) {\n            const { default: source } = await server.ssrLoadModule(ctx.file);\n            console.log('[rsc] module import', ctx.file);\n            callback({\n              type: 'custom',\n              event: 'module-import',\n              data: { ...transformedResult, source, id: ctx.file },\n            });\n          }\n        }\n        if (ctx.modules.length && !isClientEntry(ctx.file, await ctx.read())) {\n          console.log('[rsc] hot reload', ctx.file);\n          callback({ type: 'custom', event: 'rsc-reload' });\n        }\n      }\n      return [];\n    },\n    async transform(code, id) {\n      // id can contain query string with vite deps optimization\n      id = id.split('?')[0] as string;\n      const ext = extname(id);\n      if (mode === 'development' && EXTENSIONS.includes(ext)) {\n        const mod = swc.parseSync(code, parseOpts(ext));\n        for (const item of mod.body) {\n          if (item.type === 'ImportDeclaration') {\n            if (item.source.value.startsWith('virtual:')) {\n              // HACK this relies on Vite's internal implementation detail.\n              const source = base + '@id/__x00__' + item.source.value;\n              callback({ type: 'custom', event: 'hot-import', data: source });\n            } else if (CSS_LANGS_RE.test(item.source.value)) {\n              styleFiles.set(item.source.value, id);\n              await updateStyle(item.source.value, id);\n            }\n          }\n        }\n      }\n      return code;\n    },\n  };\n}\n"],"names":["swc","EXTENSIONS","extname","parseOpts","isClientEntry","id","code","ext","includes","mod","parseSync","item","body","type","expression","value","CSS_LANGS_RE","rscDelegatePlugin","callback","moduleImports","Set","mode","base","server","updateStyle","importer","resolvedSource","pluginContainer","resolveId","ssr","default","source","ssrLoadModule","transformedResult","transformRequest","add","event","data","css","styleFiles","Map","updateAllStyles","name","configResolved","config","configureServer","serverInstance","handleHotUpdate","ctx","file","endsWith","has","console","log","modules","length","read","transform","split","startsWith","test","set"],"mappings":"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"}