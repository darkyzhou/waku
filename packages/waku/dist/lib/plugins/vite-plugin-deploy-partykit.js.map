{"version":3,"sources":["../../../src/lib/plugins/vite-plugin-deploy-partykit.ts"],"sourcesContent":["import path from 'node:path';\nimport { existsSync, writeFileSync } from 'node:fs';\nimport type { Plugin } from 'vite';\n\nimport {\n  unstable_getBuildOptions,\n  unstable_builderConstants,\n} from '../../server.js';\n\nconst { SRC_ENTRIES, DIST_PUBLIC } = unstable_builderConstants;\nconst SERVE_JS = 'serve-partykit.js';\n\nconst getServeJsContent = (srcEntriesFile: string) => `\nimport { serverEngine, importHono } from 'waku/unstable_hono';\n\nconst { Hono } = await importHono();\n\nconst loadEntries = () => import('${srcEntriesFile}');\nlet serve;\nlet app;\n\nconst createApp = (app) => {\n  app.use((c, next) => serve(c, next));\n  app.notFound(async (c) => {\n    const assetsFetcher = c.env.ASSETS;\n    const url = new URL(c.req.raw.url);\n    const errorHtmlUrl = url.origin + '/404.html';\n    const notFoundStaticAssetResponse = await assetsFetcher.fetch(\n      new URL(errorHtmlUrl),\n    );\n    if (\n      notFoundStaticAssetResponse &&\n      notFoundStaticAssetResponse.status < 400\n    ) {\n      return c.body(notFoundStaticAssetResponse.body, 404);\n    }\n    return c.text('404 Not Found', 404);\n  });\n  return app;\n};\n\nexport default {\n  async onFetch(request, lobby, ctx) {\n    if (!serve) {\n      serve = serverEngine({ cmd: 'start', loadEntries, env: lobby, unstable_onError: new Set() });\n    }\n    if (!app) {\n      const entries = await loadEntries();\n      const config = await entries.loadConfig();\n      const honoEnhancer =\n        config.unstable_honoEnhancer || ((createApp) => createApp);\n      app = honoEnhancer(createApp)(new Hono());\n    }\n    return app.fetch(request, lobby, ctx);\n  },\n};\n`;\n\nexport function deployPartykitPlugin(opts: {\n  srcDir: string;\n  distDir: string;\n}): Plugin {\n  const buildOptions = unstable_getBuildOptions();\n  let rootDir: string;\n  let entriesFile: string;\n  return {\n    name: 'deploy-partykit-plugin',\n    config(viteConfig) {\n      const { deploy, unstable_phase } = buildOptions;\n      if (unstable_phase !== 'buildServerBundle' || deploy !== 'partykit') {\n        return;\n      }\n      const { input } = viteConfig.build?.rollupOptions ?? {};\n      if (input && !(typeof input === 'string') && !(input instanceof Array)) {\n        input[SERVE_JS.replace(/\\.js$/, '')] = `${opts.srcDir}/${SERVE_JS}`;\n      }\n    },\n    configResolved(config) {\n      rootDir = config.root;\n      entriesFile = `${rootDir}/${opts.srcDir}/${SRC_ENTRIES}`;\n      const { deploy, unstable_phase } = buildOptions;\n      if (\n        (unstable_phase !== 'buildServerBundle' &&\n          unstable_phase !== 'buildSsrBundle') ||\n        deploy !== 'partykit'\n      ) {\n        return;\n      }\n      config.ssr.target = 'webworker';\n      config.ssr.resolve ||= {};\n      config.ssr.resolve.conditions ||= [];\n      config.ssr.resolve.conditions.push('worker');\n      config.ssr.resolve.externalConditions ||= [];\n      config.ssr.resolve.externalConditions.push('worker');\n    },\n    resolveId(source) {\n      if (source === `${opts.srcDir}/${SERVE_JS}`) {\n        return source;\n      }\n    },\n    load(id) {\n      if (id === `${opts.srcDir}/${SERVE_JS}`) {\n        return getServeJsContent(entriesFile);\n      }\n    },\n    closeBundle() {\n      const { deploy, unstable_phase } = buildOptions;\n      if (unstable_phase !== 'buildDeploy' || deploy !== 'partykit') {\n        return;\n      }\n\n      const partykitJsonFile = path.join(rootDir, 'partykit.json');\n      if (!existsSync(partykitJsonFile)) {\n        writeFileSync(\n          partykitJsonFile,\n          JSON.stringify(\n            {\n              name: 'waku-project',\n              main: `${opts.distDir}/${SERVE_JS}`,\n              compatibilityDate: '2023-02-16',\n              serve: `./${opts.distDir}/${DIST_PUBLIC}`,\n            },\n            null,\n            2,\n          ) + '\\n',\n        );\n      }\n    },\n  };\n}\n"],"names":["path","existsSync","writeFileSync","unstable_getBuildOptions","unstable_builderConstants","SRC_ENTRIES","DIST_PUBLIC","SERVE_JS","getServeJsContent","srcEntriesFile","deployPartykitPlugin","opts","buildOptions","rootDir","entriesFile","name","config","viteConfig","deploy","unstable_phase","input","build","rollupOptions","Array","replace","srcDir","configResolved","root","ssr","target","resolve","conditions","push","externalConditions","resolveId","source","load","id","closeBundle","partykitJsonFile","join","JSON","stringify","main","distDir","compatibilityDate","serve"],"mappings":"AAAA,OAAOA,UAAU,YAAY;AAC7B,SAASC,UAAU,EAAEC,aAAa,QAAQ,UAAU;AAGpD,SACEC,wBAAwB,EACxBC,yBAAyB,QACpB,kBAAkB;AAEzB,MAAM,EAAEC,WAAW,EAAEC,WAAW,EAAE,GAAGF;AACrC,MAAMG,WAAW;AAEjB,MAAMC,oBAAoB,CAACC,iBAA2B,CAAC;;;;;kCAKrB,EAAEA,eAAe;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAuCnD,CAAC;AAED,OAAO,SAASC,qBAAqBC,IAGpC;IACC,MAAMC,eAAeT;IACrB,IAAIU;IACJ,IAAIC;IACJ,OAAO;QACLC,MAAM;QACNC,QAAOC,UAAU;YACf,MAAM,EAAEC,MAAM,EAAEC,cAAc,EAAE,GAAGP;YACnC,IAAIO,mBAAmB,uBAAuBD,WAAW,YAAY;gBACnE;YACF;YACA,MAAM,EAAEE,KAAK,EAAE,GAAGH,WAAWI,KAAK,EAAEC,iBAAiB,CAAC;YACtD,IAAIF,SAAS,CAAE,CAAA,OAAOA,UAAU,QAAO,KAAM,CAAEA,CAAAA,iBAAiBG,KAAI,GAAI;gBACtEH,KAAK,CAACb,SAASiB,OAAO,CAAC,SAAS,IAAI,GAAG,GAAGb,KAAKc,MAAM,CAAC,CAAC,EAAElB,UAAU;YACrE;QACF;QACAmB,gBAAeV,MAAM;YACnBH,UAAUG,OAAOW,IAAI;YACrBb,cAAc,GAAGD,QAAQ,CAAC,EAAEF,KAAKc,MAAM,CAAC,CAAC,EAAEpB,aAAa;YACxD,MAAM,EAAEa,MAAM,EAAEC,cAAc,EAAE,GAAGP;YACnC,IACE,AAACO,mBAAmB,uBAClBA,mBAAmB,oBACrBD,WAAW,YACX;gBACA;YACF;YACAF,OAAOY,GAAG,CAACC,MAAM,GAAG;YACpBb,OAAOY,GAAG,CAACE,OAAO,KAAK,CAAC;YACxBd,OAAOY,GAAG,CAACE,OAAO,CAACC,UAAU,KAAK,EAAE;YACpCf,OAAOY,GAAG,CAACE,OAAO,CAACC,UAAU,CAACC,IAAI,CAAC;YACnChB,OAAOY,GAAG,CAACE,OAAO,CAACG,kBAAkB,KAAK,EAAE;YAC5CjB,OAAOY,GAAG,CAACE,OAAO,CAACG,kBAAkB,CAACD,IAAI,CAAC;QAC7C;QACAE,WAAUC,MAAM;YACd,IAAIA,WAAW,GAAGxB,KAAKc,MAAM,CAAC,CAAC,EAAElB,UAAU,EAAE;gBAC3C,OAAO4B;YACT;QACF;QACAC,MAAKC,EAAE;YACL,IAAIA,OAAO,GAAG1B,KAAKc,MAAM,CAAC,CAAC,EAAElB,UAAU,EAAE;gBACvC,OAAOC,kBAAkBM;YAC3B;QACF;QACAwB;YACE,MAAM,EAAEpB,MAAM,EAAEC,cAAc,EAAE,GAAGP;YACnC,IAAIO,mBAAmB,iBAAiBD,WAAW,YAAY;gBAC7D;YACF;YAEA,MAAMqB,mBAAmBvC,KAAKwC,IAAI,CAAC3B,SAAS;YAC5C,IAAI,CAACZ,WAAWsC,mBAAmB;gBACjCrC,cACEqC,kBACAE,KAAKC,SAAS,CACZ;oBACE3B,MAAM;oBACN4B,MAAM,GAAGhC,KAAKiC,OAAO,CAAC,CAAC,EAAErC,UAAU;oBACnCsC,mBAAmB;oBACnBC,OAAO,CAAC,EAAE,EAAEnC,KAAKiC,OAAO,CAAC,CAAC,EAAEtC,aAAa;gBAC3C,GACA,MACA,KACE;YAER;QACF;IACF;AACF"}