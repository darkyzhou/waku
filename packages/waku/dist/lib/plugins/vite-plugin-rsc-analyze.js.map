{"version":3,"sources":["../../../src/lib/plugins/vite-plugin-rsc-analyze.ts"],"sourcesContent":["import type { Plugin } from 'vite';\nimport * as swc from '@swc/core';\n\nimport { EXTENSIONS } from '../builder/constants.js';\nimport { extname } from '../utils/path.js';\nimport { parseOpts } from '../utils/swc.js';\n// HACK: Is it common to depend on another plugin like this?\nimport { rscTransformPlugin } from './vite-plugin-rsc-transform.js';\n\nconst hash = async (code: string): Promise<string> => {\n  const encoder = new TextEncoder();\n  const data = encoder.encode(code);\n  const hashBuffer = await crypto.subtle.digest('SHA-256', data);\n  const hashArray = Array.from(new Uint8Array(hashBuffer));\n  return hashArray\n    .map((b) => b.toString(16).padStart(2, '0'))\n    .join('')\n    .slice(0, 9);\n};\n\nconst isServerFunction = (\n  node:\n    | swc.FunctionDeclaration\n    | swc.FunctionExpression\n    | swc.ArrowFunctionExpression,\n): boolean =>\n  node.body?.type === 'BlockStatement' &&\n  node.body.stmts.some(\n    (s) =>\n      s.type === 'ExpressionStatement' &&\n      s.expression.type === 'StringLiteral' &&\n      s.expression.value === 'use server',\n  );\n\nconst containsServerFunction = (mod: swc.Module): boolean => {\n  const walk = (node: swc.Node): boolean => {\n    if (\n      node.type === 'FunctionDeclaration' ||\n      node.type === 'FunctionExpression' ||\n      node.type === 'ArrowFunctionExpression'\n    ) {\n      if (\n        isServerFunction(\n          node as\n            | swc.FunctionDeclaration\n            | swc.FunctionExpression\n            | swc.ArrowFunctionExpression,\n        )\n      ) {\n        return true;\n      }\n    }\n    // FIXME do we need to walk the entire tree? feels inefficient\n    return Object.values(node).some((value) =>\n      (Array.isArray(value) ? value : [value]).some((v) => {\n        if (typeof v?.type === 'string') {\n          return walk(v);\n        }\n        if (typeof v?.expression?.type === 'string') {\n          return walk(v.expression);\n        }\n        return false;\n      }),\n    );\n  };\n  return walk(mod);\n};\n\nexport function rscAnalyzePlugin(\n  opts:\n    | {\n        isClient: true;\n        clientFileMap: Map<string, string>;\n        serverFileMap: Map<string, string>;\n      }\n    | {\n        isClient: false;\n        clientFileMap: Map<string, string>;\n        serverFileMap: Map<string, string>;\n      },\n): Plugin {\n  const rscTransform = rscTransformPlugin({\n    isClient: false,\n    isBuild: false,\n    resolvedMap: new Map(),\n  }).transform;\n  return {\n    name: 'rsc-analyze-plugin',\n    async transform(code, id, options) {\n      const ext = extname(id);\n      if (EXTENSIONS.includes(ext)) {\n        const mod = swc.parseSync(code, parseOpts(ext));\n        for (const item of mod.body) {\n          if (\n            item.type === 'ExpressionStatement' &&\n            item.expression.type === 'StringLiteral'\n          ) {\n            if (\n              !opts.clientFileMap.has(id) &&\n              item.expression.value === 'use client'\n            ) {\n              opts.clientFileMap.set(id, await hash(code));\n            }\n            if (\n              !opts.serverFileMap.has(id) &&\n              item.expression.value === 'use server'\n            ) {\n              opts.serverFileMap.set(id, await hash(code));\n            }\n          }\n        }\n        if (\n          !opts.isClient &&\n          !opts.clientFileMap.has(id) &&\n          !opts.serverFileMap.has(id) &&\n          code.includes('use server') &&\n          containsServerFunction(mod)\n        ) {\n          opts.serverFileMap.set(id, await hash(code));\n        }\n      }\n      // Avoid walking after the client boundary\n      if (!opts.isClient && opts.clientFileMap.has(id)) {\n        // TODO this isn't efficient. let's refactor it in the future.\n        return (\n          rscTransform as typeof rscTransform & { handler: undefined }\n        ).call(this, code, id, options);\n      }\n    },\n  };\n}\n"],"names":["swc","EXTENSIONS","extname","parseOpts","rscTransformPlugin","hash","code","encoder","TextEncoder","data","encode","hashBuffer","crypto","subtle","digest","hashArray","Array","from","Uint8Array","map","b","toString","padStart","join","slice","isServerFunction","node","body","type","stmts","some","s","expression","value","containsServerFunction","mod","walk","Object","values","isArray","v","rscAnalyzePlugin","opts","rscTransform","isClient","isBuild","resolvedMap","Map","transform","name","id","options","ext","includes","parseSync","item","clientFileMap","has","set","serverFileMap","call"],"mappings":"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"}