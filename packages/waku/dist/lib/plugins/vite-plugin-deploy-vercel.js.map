{"version":3,"sources":["../../../src/lib/plugins/vite-plugin-deploy-vercel.ts"],"sourcesContent":["import path from 'node:path';\nimport { cpSync, existsSync, mkdirSync, writeFileSync } from 'node:fs';\nimport type { Plugin } from 'vite';\n\nimport { emitPlatformData } from '../builder/platform-data.js';\nimport {\n  unstable_getBuildOptions,\n  unstable_builderConstants,\n} from '../../server.js';\n\nconst { SRC_ENTRIES, DIST_PUBLIC } = unstable_builderConstants;\nconst SERVE_JS = 'serve-vercel.js';\n\nconst getServeJsContent = (\n  distDir: string,\n  distPublic: string,\n  srcEntriesFile: string,\n  honoEnhancerFile: string | undefined,\n) => `\nimport path from 'node:path';\nimport { existsSync, readFileSync } from 'node:fs';\nimport { serverEngine, importHono, importHonoNodeServer } from 'waku/unstable_hono';\n\nconst { Hono } = await importHono();\nconst { getRequestListener } = await importHonoNodeServer();\n\nconst distDir = '${distDir}';\nconst publicDir = '${distPublic}';\nconst loadEntries = () => import('${srcEntriesFile}');\nconst loadHonoEnhancer = async () => {\n  ${\n    honoEnhancerFile\n      ? `return (await import('${honoEnhancerFile}')).default;`\n      : `return (fn) => fn;`\n  }\n};\n\nconst createApp = (app) => {\n  app.use(serverEngine({ cmd: 'start', loadEntries, env: process.env, unstable_onError: new Set() }));\n  app.notFound((c) => {\n    // FIXME better implementation using node stream?\n    const file = path.join(distDir, publicDir, '404.html');\n    if (existsSync(file)) {\n      return c.html(readFileSync(file, 'utf8'), 404);\n    }\n    return c.text('404 Not Found', 404);\n  });\n  return app;\n}\n\nconst honoEnhancer = await loadHonoEnhancer();\nconst app = honoEnhancer(createApp)(new Hono());\n\nexport default getRequestListener(app.fetch);\n`;\n\nexport function deployVercelPlugin(opts: {\n  srcDir: string;\n  distDir: string;\n  basePath: string;\n  rscBase: string;\n  privateDir: string;\n  unstable_honoEnhancer: string | undefined;\n}): Plugin {\n  const buildOptions = unstable_getBuildOptions();\n  let rootDir: string;\n  let entriesFile: string;\n  let honoEnhancerFile: string | undefined;\n  return {\n    name: 'deploy-vercel-plugin',\n    config(viteConfig) {\n      const { deploy, unstable_phase } = buildOptions;\n      if (\n        unstable_phase !== 'buildServerBundle' ||\n        (deploy !== 'vercel-serverless' && deploy !== 'vercel-static')\n      ) {\n        return;\n      }\n      const { input } = viteConfig.build?.rollupOptions ?? {};\n      if (input && !(typeof input === 'string') && !(input instanceof Array)) {\n        input[SERVE_JS.replace(/\\.js$/, '')] = `${opts.srcDir}/${SERVE_JS}`;\n      }\n    },\n    configResolved(config) {\n      rootDir = config.root;\n      entriesFile = `${rootDir}/${opts.srcDir}/${SRC_ENTRIES}`;\n      if (opts.unstable_honoEnhancer) {\n        honoEnhancerFile = `${rootDir}/${opts.unstable_honoEnhancer}`;\n      }\n    },\n    resolveId(source) {\n      if (source === `${opts.srcDir}/${SERVE_JS}`) {\n        return source;\n      }\n    },\n    load(id) {\n      if (id === `${opts.srcDir}/${SERVE_JS}`) {\n        return getServeJsContent(\n          opts.distDir,\n          DIST_PUBLIC,\n          entriesFile,\n          honoEnhancerFile,\n        );\n      }\n    },\n    async closeBundle() {\n      const { deploy, unstable_phase } = buildOptions;\n      if (\n        unstable_phase !== 'buildDeploy' ||\n        (deploy !== 'vercel-serverless' && deploy !== 'vercel-static')\n      ) {\n        return;\n      }\n\n      const publicDir = path.join(rootDir, opts.distDir, DIST_PUBLIC);\n      const outputDir = path.resolve('.vercel', 'output');\n      cpSync(publicDir, path.join(outputDir, 'static'), { recursive: true });\n\n      if (deploy === 'vercel-serverless') {\n        // for serverless function\n        const serverlessDir = path.join(\n          outputDir,\n          'functions',\n          opts.rscBase + '.func',\n        );\n        mkdirSync(path.join(serverlessDir, opts.distDir), {\n          recursive: true,\n        });\n        cpSync(\n          path.join(rootDir, opts.distDir),\n          path.join(serverlessDir, opts.distDir),\n          { recursive: true },\n        );\n        await emitPlatformData(path.join(serverlessDir, opts.distDir));\n        if (existsSync(path.join(rootDir, opts.privateDir))) {\n          cpSync(\n            path.join(rootDir, opts.privateDir),\n            path.join(serverlessDir, opts.privateDir),\n            { recursive: true, dereference: true },\n          );\n        }\n        const vcConfigJson = {\n          runtime: 'nodejs22.x',\n          handler: `${opts.distDir}/${SERVE_JS}`,\n          launcherType: 'Nodejs',\n        };\n        writeFileSync(\n          path.join(serverlessDir, '.vc-config.json'),\n          JSON.stringify(vcConfigJson, null, 2),\n        );\n        writeFileSync(\n          path.join(serverlessDir, 'package.json'),\n          JSON.stringify({ type: 'module' }, null, 2),\n        );\n      }\n\n      const routes =\n        deploy === 'vercel-serverless'\n          ? [\n              { handle: 'filesystem' },\n              {\n                src: opts.basePath + '(.*)',\n                dest: opts.basePath + opts.rscBase + '/',\n              },\n            ]\n          : undefined;\n      const configJson = { version: 3, routes };\n      mkdirSync(outputDir, { recursive: true });\n      writeFileSync(\n        path.join(outputDir, 'config.json'),\n        JSON.stringify(configJson, null, 2),\n      );\n    },\n  };\n}\n"],"names":["path","cpSync","existsSync","mkdirSync","writeFileSync","emitPlatformData","unstable_getBuildOptions","unstable_builderConstants","SRC_ENTRIES","DIST_PUBLIC","SERVE_JS","getServeJsContent","distDir","distPublic","srcEntriesFile","honoEnhancerFile","deployVercelPlugin","opts","buildOptions","rootDir","entriesFile","name","config","viteConfig","deploy","unstable_phase","input","build","rollupOptions","Array","replace","srcDir","configResolved","root","unstable_honoEnhancer","resolveId","source","load","id","closeBundle","publicDir","join","outputDir","resolve","recursive","serverlessDir","rscBase","privateDir","dereference","vcConfigJson","runtime","handler","launcherType","JSON","stringify","type","routes","handle","src","basePath","dest","undefined","configJson","version"],"mappings":"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"}