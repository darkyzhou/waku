{"version":3,"sources":["../../../src/lib/plugins/vite-plugin-deploy-vercel.ts"],"sourcesContent":["import path from 'node:path';\nimport { cpSync, existsSync, mkdirSync, writeFileSync } from 'node:fs';\nimport type { Plugin } from 'vite';\n\nimport { emitPlatformData } from '../builder/platform-data.js';\nimport {\n  unstable_getBuildOptions,\n  unstable_builderConstants,\n} from '../../server.js';\n\nconst { SRC_ENTRIES, DIST_PUBLIC } = unstable_builderConstants;\nconst SERVE_JS = 'serve-vercel.js';\n\nconst getServeJsContent = (\n  distDir: string,\n  distPublic: string,\n  srcEntriesFile: string,\n) => `\nimport path from 'node:path';\nimport { existsSync, readFileSync } from 'node:fs';\nimport { serverEngine, importHono, importHonoNodeServer } from 'waku/unstable_hono';\n\nconst { Hono } = await importHono();\nconst { getRequestListener } = await importHonoNodeServer();\n\nconst distDir = '${distDir}';\nconst publicDir = '${distPublic}';\nconst loadEntries = () => import('${srcEntriesFile}');\nconst configPromise = loadEntries().then((entries) => entries.loadConfig());\n\nconst createApp = (app) => {\n  app.use(serverEngine({ cmd: 'start', loadEntries, env: process.env, unstable_onError: new Set() }));\n  app.notFound((c) => {\n    // FIXME better implementation using node stream?\n    const file = path.join(distDir, publicDir, '404.html');\n    if (existsSync(file)) {\n      return c.html(readFileSync(file, 'utf8'), 404);\n    }\n    return c.text('404 Not Found', 404);\n  });\n  return app;\n}\n\nconst honoEnhancer =\n  (await configPromise).unstable_honoEnhancer || ((createApp) => createApp);\nconst app = honoEnhancer(createApp)(new Hono());\n\nexport default getRequestListener(app.fetch);\n`;\n\nexport function deployVercelPlugin(opts: {\n  srcDir: string;\n  distDir: string;\n  basePath: string;\n  rscBase: string;\n  privateDir: string;\n}): Plugin {\n  const buildOptions = unstable_getBuildOptions();\n  let rootDir: string;\n  let entriesFile: string;\n  return {\n    name: 'deploy-vercel-plugin',\n    config(viteConfig) {\n      const { deploy, unstable_phase } = buildOptions;\n      if (\n        unstable_phase !== 'buildServerBundle' ||\n        (deploy !== 'vercel-serverless' && deploy !== 'vercel-static')\n      ) {\n        return;\n      }\n      const { input } = viteConfig.build?.rollupOptions ?? {};\n      if (input && !(typeof input === 'string') && !(input instanceof Array)) {\n        input[SERVE_JS.replace(/\\.js$/, '')] = `${opts.srcDir}/${SERVE_JS}`;\n      }\n    },\n    configResolved(config) {\n      rootDir = config.root;\n      entriesFile = `${rootDir}/${opts.srcDir}/${SRC_ENTRIES}`;\n    },\n    resolveId(source) {\n      if (source === `${opts.srcDir}/${SERVE_JS}`) {\n        return source;\n      }\n    },\n    load(id) {\n      if (id === `${opts.srcDir}/${SERVE_JS}`) {\n        return getServeJsContent(opts.distDir, DIST_PUBLIC, entriesFile);\n      }\n    },\n    async closeBundle() {\n      const { deploy, unstable_phase } = buildOptions;\n      if (\n        unstable_phase !== 'buildDeploy' ||\n        (deploy !== 'vercel-serverless' && deploy !== 'vercel-static')\n      ) {\n        return;\n      }\n\n      const publicDir = path.join(rootDir, opts.distDir, DIST_PUBLIC);\n      const outputDir = path.resolve('.vercel', 'output');\n      cpSync(publicDir, path.join(outputDir, 'static'), { recursive: true });\n\n      if (deploy === 'vercel-serverless') {\n        // for serverless function\n        const serverlessDir = path.join(\n          outputDir,\n          'functions',\n          opts.rscBase + '.func',\n        );\n        mkdirSync(path.join(serverlessDir, opts.distDir), {\n          recursive: true,\n        });\n        cpSync(\n          path.join(rootDir, opts.distDir),\n          path.join(serverlessDir, opts.distDir),\n          { recursive: true },\n        );\n        await emitPlatformData(path.join(serverlessDir, opts.distDir));\n        if (existsSync(path.join(rootDir, opts.privateDir))) {\n          cpSync(\n            path.join(rootDir, opts.privateDir),\n            path.join(serverlessDir, opts.privateDir),\n            { recursive: true, dereference: true },\n          );\n        }\n        const vcConfigJson = {\n          runtime: 'nodejs20.x',\n          handler: `${opts.distDir}/${SERVE_JS}`,\n          launcherType: 'Nodejs',\n        };\n        writeFileSync(\n          path.join(serverlessDir, '.vc-config.json'),\n          JSON.stringify(vcConfigJson, null, 2),\n        );\n        writeFileSync(\n          path.join(serverlessDir, 'package.json'),\n          JSON.stringify({ type: 'module' }, null, 2),\n        );\n      }\n\n      const routes =\n        deploy === 'vercel-serverless'\n          ? [\n              { handle: 'filesystem' },\n              {\n                src: opts.basePath + '(.*)',\n                dest: opts.basePath + opts.rscBase + '/',\n              },\n            ]\n          : undefined;\n      const configJson = { version: 3, routes };\n      mkdirSync(outputDir, { recursive: true });\n      writeFileSync(\n        path.join(outputDir, 'config.json'),\n        JSON.stringify(configJson, null, 2),\n      );\n    },\n  };\n}\n"],"names":["path","cpSync","existsSync","mkdirSync","writeFileSync","emitPlatformData","unstable_getBuildOptions","unstable_builderConstants","SRC_ENTRIES","DIST_PUBLIC","SERVE_JS","getServeJsContent","distDir","distPublic","srcEntriesFile","deployVercelPlugin","opts","buildOptions","rootDir","entriesFile","name","config","viteConfig","deploy","unstable_phase","input","build","rollupOptions","Array","replace","srcDir","configResolved","root","resolveId","source","load","id","closeBundle","publicDir","join","outputDir","resolve","recursive","serverlessDir","rscBase","privateDir","dereference","vcConfigJson","runtime","handler","launcherType","JSON","stringify","type","routes","handle","src","basePath","dest","undefined","configJson","version"],"mappings":"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"}