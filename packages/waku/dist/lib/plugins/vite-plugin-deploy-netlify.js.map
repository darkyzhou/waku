{"version":3,"sources":["../../../src/lib/plugins/vite-plugin-deploy-netlify.ts"],"sourcesContent":["import path from 'node:path';\nimport { existsSync, mkdirSync, readFileSync, writeFileSync } from 'node:fs';\nimport type { Plugin } from 'vite';\n\nimport {\n  unstable_getBuildOptions,\n  unstable_builderConstants,\n} from '../../server.js';\n\nconst { SRC_ENTRIES, DIST_PUBLIC } = unstable_builderConstants;\nconst SERVE_JS = 'serve-netlify.js';\n\nconst getServeJsContent = (srcEntriesFile: string) => `\nimport { serverEngine, importHono } from 'waku/unstable_hono';\n\nconst { Hono } = await importHono();\n\nconst loadEntries = () => import('${srcEntriesFile}');\nconst configPromise = loadEntries().then((entries) => entries.loadConfig());\n\nconst createApp = (app) => {\n  app.use(serverEngine({ cmd: 'start', loadEntries, env: process.env, unstable_onError: new Set() }));\n  app.notFound((c) => {\n    const notFoundHtml = globalThis.__WAKU_NOT_FOUND_HTML__;\n    if (typeof notFoundHtml === 'string') {\n      return c.html(notFoundHtml, 404);\n    }\n    return c.text('404 Not Found', 404);\n  });\n  return app;\n}\n\nconst honoEnhancer =\n  (await configPromise).unstable_honoEnhancer || ((createApp) => createApp);\nconst app = honoEnhancer(createApp)(new Hono());\n\nexport default async (req, context) => app.fetch(req, { context });\n`;\n\nexport function deployNetlifyPlugin(opts: {\n  srcDir: string;\n  distDir: string;\n  privateDir: string;\n}): Plugin {\n  const buildOptions = unstable_getBuildOptions();\n  let rootDir: string;\n  let entriesFile: string;\n  return {\n    name: 'deploy-netlify-plugin',\n    config(viteConfig) {\n      const { deploy, unstable_phase } = buildOptions;\n      if (\n        unstable_phase !== 'buildServerBundle' ||\n        (deploy !== 'netlify-functions' && deploy !== 'netlify-static')\n      ) {\n        return;\n      }\n      const { input } = viteConfig.build?.rollupOptions ?? {};\n      if (input && !(typeof input === 'string') && !(input instanceof Array)) {\n        input[SERVE_JS.replace(/\\.js$/, '')] = `${opts.srcDir}/${SERVE_JS}`;\n      }\n    },\n    configResolved(config) {\n      rootDir = config.root;\n      entriesFile = `${rootDir}/${opts.srcDir}/${SRC_ENTRIES}`;\n    },\n    resolveId(source) {\n      if (source === `${opts.srcDir}/${SERVE_JS}`) {\n        return source;\n      }\n    },\n    load(id) {\n      if (id === `${opts.srcDir}/${SERVE_JS}`) {\n        return getServeJsContent(entriesFile);\n      }\n    },\n    closeBundle() {\n      const { deploy, unstable_phase } = buildOptions;\n      if (\n        unstable_phase !== 'buildDeploy' ||\n        (deploy !== 'netlify-functions' && deploy !== 'netlify-static')\n      ) {\n        return;\n      }\n\n      if (deploy === 'netlify-functions') {\n        const functionsDir = path.join(rootDir, 'netlify-functions');\n        mkdirSync(functionsDir, {\n          recursive: true,\n        });\n        const notFoundFile = path.join(\n          rootDir,\n          opts.distDir,\n          DIST_PUBLIC,\n          '404.html',\n        );\n        const notFoundHtml = existsSync(notFoundFile)\n          ? readFileSync(notFoundFile, 'utf8')\n          : null;\n        writeFileSync(\n          path.join(functionsDir, 'serve.js'),\n          `\nglobalThis.__WAKU_NOT_FOUND_HTML__ = ${JSON.stringify(notFoundHtml)};\nexport { default } from '../${opts.distDir}/${SERVE_JS}';\nexport const config = {\n  preferStatic: true,\n  path: ['/', '/*'],\n};\n`,\n        );\n      }\n      const netlifyTomlFile = path.join(rootDir, 'netlify.toml');\n      if (!existsSync(netlifyTomlFile)) {\n        writeFileSync(\n          netlifyTomlFile,\n          `\n[build]\n  command = \"npm run build -- --with-netlify\"\n  publish = \"${opts.distDir}/${DIST_PUBLIC}\"\n[functions]\n  included_files = [\"${opts.privateDir}/**\"]\n  directory = \"netlify-functions\"\n`,\n        );\n      }\n    },\n  };\n}\n"],"names":["path","existsSync","mkdirSync","readFileSync","writeFileSync","unstable_getBuildOptions","unstable_builderConstants","SRC_ENTRIES","DIST_PUBLIC","SERVE_JS","getServeJsContent","srcEntriesFile","deployNetlifyPlugin","opts","buildOptions","rootDir","entriesFile","name","config","viteConfig","deploy","unstable_phase","input","build","rollupOptions","Array","replace","srcDir","configResolved","root","resolveId","source","load","id","closeBundle","functionsDir","join","recursive","notFoundFile","distDir","notFoundHtml","JSON","stringify","netlifyTomlFile","privateDir"],"mappings":"AAAA,OAAOA,UAAU,YAAY;AAC7B,SAASC,UAAU,EAAEC,SAAS,EAAEC,YAAY,EAAEC,aAAa,QAAQ,UAAU;AAG7E,SACEC,wBAAwB,EACxBC,yBAAyB,QACpB,kBAAkB;AAEzB,MAAM,EAAEC,WAAW,EAAEC,WAAW,EAAE,GAAGF;AACrC,MAAMG,WAAW;AAEjB,MAAMC,oBAAoB,CAACC,iBAA2B,CAAC;;;;;kCAKrB,EAAEA,eAAe;;;;;;;;;;;;;;;;;;;;AAoBnD,CAAC;AAED,OAAO,SAASC,oBAAoBC,IAInC;IACC,MAAMC,eAAeT;IACrB,IAAIU;IACJ,IAAIC;IACJ,OAAO;QACLC,MAAM;QACNC,QAAOC,UAAU;YACf,MAAM,EAAEC,MAAM,EAAEC,cAAc,EAAE,GAAGP;YACnC,IACEO,mBAAmB,uBAClBD,WAAW,uBAAuBA,WAAW,kBAC9C;gBACA;YACF;YACA,MAAM,EAAEE,KAAK,EAAE,GAAGH,WAAWI,KAAK,EAAEC,iBAAiB,CAAC;YACtD,IAAIF,SAAS,CAAE,CAAA,OAAOA,UAAU,QAAO,KAAM,CAAEA,CAAAA,iBAAiBG,KAAI,GAAI;gBACtEH,KAAK,CAACb,SAASiB,OAAO,CAAC,SAAS,IAAI,GAAG,GAAGb,KAAKc,MAAM,CAAC,CAAC,EAAElB,UAAU;YACrE;QACF;QACAmB,gBAAeV,MAAM;YACnBH,UAAUG,OAAOW,IAAI;YACrBb,cAAc,GAAGD,QAAQ,CAAC,EAAEF,KAAKc,MAAM,CAAC,CAAC,EAAEpB,aAAa;QAC1D;QACAuB,WAAUC,MAAM;YACd,IAAIA,WAAW,GAAGlB,KAAKc,MAAM,CAAC,CAAC,EAAElB,UAAU,EAAE;gBAC3C,OAAOsB;YACT;QACF;QACAC,MAAKC,EAAE;YACL,IAAIA,OAAO,GAAGpB,KAAKc,MAAM,CAAC,CAAC,EAAElB,UAAU,EAAE;gBACvC,OAAOC,kBAAkBM;YAC3B;QACF;QACAkB;YACE,MAAM,EAAEd,MAAM,EAAEC,cAAc,EAAE,GAAGP;YACnC,IACEO,mBAAmB,iBAClBD,WAAW,uBAAuBA,WAAW,kBAC9C;gBACA;YACF;YAEA,IAAIA,WAAW,qBAAqB;gBAClC,MAAMe,eAAenC,KAAKoC,IAAI,CAACrB,SAAS;gBACxCb,UAAUiC,cAAc;oBACtBE,WAAW;gBACb;gBACA,MAAMC,eAAetC,KAAKoC,IAAI,CAC5BrB,SACAF,KAAK0B,OAAO,EACZ/B,aACA;gBAEF,MAAMgC,eAAevC,WAAWqC,gBAC5BnC,aAAamC,cAAc,UAC3B;gBACJlC,cACEJ,KAAKoC,IAAI,CAACD,cAAc,aACxB,CAAC;qCAC0B,EAAEM,KAAKC,SAAS,CAACF,cAAc;4BACxC,EAAE3B,KAAK0B,OAAO,CAAC,CAAC,EAAE9B,SAAS;;;;;AAKvD,CAAC;YAEK;YACA,MAAMkC,kBAAkB3C,KAAKoC,IAAI,CAACrB,SAAS;YAC3C,IAAI,CAACd,WAAW0C,kBAAkB;gBAChCvC,cACEuC,iBACA,CAAC;;;aAGE,EAAE9B,KAAK0B,OAAO,CAAC,CAAC,EAAE/B,YAAY;;qBAEtB,EAAEK,KAAK+B,UAAU,CAAC;;AAEvC,CAAC;YAEK;QACF;IACF;AACF"}