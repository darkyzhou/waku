{"version":3,"sources":["../../../src/lib/renderers/rsc.ts"],"sourcesContent":["import type { ReactNode } from 'react';\nimport type { default as RSDWServerType } from 'react-server-dom-webpack/server.edge';\n\nimport type { ConfigPrd } from '../config.js';\n// TODO move types somewhere\nimport type { HandlerContext, ErrorCallback } from '../middleware/types.js';\nimport { filePathToFileURL } from '../utils/path.js';\nimport { streamToArrayBuffer } from '../utils/stream.js';\nimport { bufferToString, parseFormData } from '../utils/buffer.js';\n\nconst resolveClientEntryForPrd = (id: string, config: { basePath: string }) => {\n  return config.basePath + id + '.js';\n};\n\nexport async function renderRsc(\n  config: ConfigPrd,\n  ctx: Pick<HandlerContext, 'unstable_modules' | 'unstable_devServer'>,\n  elements: Record<string, unknown>,\n  onError: Set<ErrorCallback>,\n  moduleIdCallback?: (id: string) => void,\n): Promise<ReadableStream> {\n  const modules = ctx.unstable_modules;\n  if (!modules) {\n    throw new Error('handler middleware required (missing modules)');\n  }\n  const {\n    default: { renderToReadableStream },\n  } = modules.rsdwServer as { default: typeof RSDWServerType };\n  const resolveClientEntry = ctx.unstable_devServer\n    ? ctx.unstable_devServer.resolveClientEntry\n    : resolveClientEntryForPrd;\n  const clientBundlerConfig = new Proxy(\n    {},\n    {\n      get(_target, encodedId: string) {\n        const [file, name] = encodedId.split('#') as [string, string];\n        const id = resolveClientEntry(file, config);\n        moduleIdCallback?.(id);\n        return { id, chunks: [id], name, async: true };\n      },\n    },\n  );\n  return renderToReadableStream(elements, clientBundlerConfig, {\n    onError: (err: unknown) => {\n      onError.forEach((fn) => fn(err, ctx as HandlerContext, 'rsc'));\n      if (typeof (err as any)?.digest === 'string') {\n        // This is not correct according to the type though.\n        return (err as { digest: string }).digest;\n      }\n    },\n  });\n}\n\nexport function renderRscElement(\n  config: ConfigPrd,\n  ctx: Pick<HandlerContext, 'unstable_modules' | 'unstable_devServer'>,\n  element: ReactNode,\n  onError: Set<ErrorCallback>,\n): ReadableStream {\n  const modules = ctx.unstable_modules;\n  if (!modules) {\n    throw new Error('handler middleware required (missing modules)');\n  }\n  const {\n    default: { renderToReadableStream },\n  } = modules.rsdwServer as { default: typeof RSDWServerType };\n  const resolveClientEntry = ctx.unstable_devServer\n    ? ctx.unstable_devServer.resolveClientEntry\n    : resolveClientEntryForPrd;\n  const clientBundlerConfig = new Proxy(\n    {},\n    {\n      get(_target, encodedId: string) {\n        const [file, name] = encodedId.split('#') as [string, string];\n        const id = resolveClientEntry(file, config);\n        return { id, chunks: [id], name, async: true };\n      },\n    },\n  );\n  return renderToReadableStream(element, clientBundlerConfig, {\n    onError: (err: unknown) => {\n      onError.forEach((fn) => fn(err, ctx as HandlerContext, 'rsc'));\n      if (typeof (err as any)?.digest === 'string') {\n        // This is not correct according to the type though.\n        return (err as { digest: string }).digest;\n      }\n    },\n  });\n}\n\nexport async function collectClientModules(\n  config: ConfigPrd,\n  rsdwServer: { default: typeof RSDWServerType },\n  elements: Record<string, unknown>,\n): Promise<string[]> {\n  const {\n    default: { renderToReadableStream },\n  } = rsdwServer;\n  const idSet = new Set<string>();\n  const clientBundlerConfig = new Proxy(\n    {},\n    {\n      get(_target, encodedId: string) {\n        const [file, name] = encodedId.split('#') as [string, string];\n        const id = resolveClientEntryForPrd(file, config);\n        idSet.add(id);\n        return { id, chunks: [id], name, async: true };\n      },\n    },\n  );\n  const readable = renderToReadableStream(elements, clientBundlerConfig);\n  await new Promise<void>((resolve, reject) => {\n    const writable = new WritableStream({\n      close() {\n        resolve();\n      },\n      abort(reason) {\n        reject(reason);\n      },\n    });\n    readable.pipeTo(writable).catch(reject);\n  });\n  return Array.from(idSet);\n}\n\nexport async function decodeBody(\n  ctx: Pick<HandlerContext, 'unstable_modules' | 'unstable_devServer' | 'req'>,\n): Promise<unknown> {\n  const isDev = !!ctx.unstable_devServer;\n  const modules = ctx.unstable_modules;\n  if (!modules) {\n    throw new Error('handler middleware required (missing modules)');\n  }\n  const {\n    default: { decodeReply },\n  } = modules.rsdwServer as { default: typeof RSDWServerType };\n  const serverBundlerConfig = new Proxy(\n    {},\n    {\n      get(_target, encodedId: string) {\n        const [fileId, name] = encodedId.split('#') as [string, string];\n        const id = isDev ? filePathToFileURL(fileId) : fileId + '.js';\n        return { id, chunks: [id], name, async: true };\n      },\n    },\n  );\n  let decodedBody: unknown = ctx.req.url.searchParams;\n  if (ctx.req.body) {\n    const bodyBuf = await streamToArrayBuffer(ctx.req.body);\n    const contentType = ctx.req.headers['content-type'];\n    if (\n      typeof contentType === 'string' &&\n      contentType.startsWith('multipart/form-data')\n    ) {\n      // XXX This doesn't support streaming unlike busboy\n      const formData = await parseFormData(bodyBuf, contentType);\n      decodedBody = await decodeReply(formData, serverBundlerConfig);\n    } else if (bodyBuf.byteLength > 0) {\n      const bodyStr = bufferToString(bodyBuf);\n      decodedBody = await decodeReply(bodyStr, serverBundlerConfig);\n    }\n  }\n  return decodedBody;\n}\n\nconst EXTRACT_FORM_STATE_SYMBOL = Symbol('EXTRACT_FORM_STATE');\ntype ExtractFormState = (\n  actionResult: unknown,\n) => ReturnType<(typeof RSDWServerType)['decodeFormState']>;\n\nconst setExtractFormState = (\n  ctx: object,\n  extractFormState: ExtractFormState,\n) => {\n  (\n    ctx as unknown as Record<typeof EXTRACT_FORM_STATE_SYMBOL, ExtractFormState>\n  )[EXTRACT_FORM_STATE_SYMBOL] = extractFormState;\n};\n\nexport const getExtractFormState = (ctx: object): ExtractFormState => {\n  const extractFormState = (\n    ctx as unknown as Record<\n      typeof EXTRACT_FORM_STATE_SYMBOL,\n      ExtractFormState | undefined\n    >\n  )[EXTRACT_FORM_STATE_SYMBOL];\n  if (!extractFormState) {\n    throw new Error('extractFormState not set');\n  }\n  return extractFormState;\n};\n\nexport async function decodePostAction(\n  ctx: Pick<HandlerContext, 'unstable_modules' | 'unstable_devServer' | 'req'>,\n): Promise<(() => Promise<unknown>) | null> {\n  const isDev = !!ctx.unstable_devServer;\n  const modules = ctx.unstable_modules;\n  if (!modules) {\n    throw new Error('handler middleware required (missing modules)');\n  }\n  const {\n    default: { decodeAction, decodeFormState },\n  } = modules.rsdwServer as { default: typeof RSDWServerType };\n  if (ctx.req.body) {\n    const contentType = ctx.req.headers['content-type'];\n    if (\n      typeof contentType === 'string' &&\n      contentType.startsWith('multipart/form-data')\n    ) {\n      const [stream1, stream2] = ctx.req.body.tee();\n      ctx.req.body = stream1;\n      const bodyBuf = await streamToArrayBuffer(stream2);\n      // XXX This doesn't support streaming unlike busboy\n      const formData = await parseFormData(bodyBuf, contentType);\n      if (\n        Array.from(formData.keys()).every((key) => !key.startsWith('$ACTION_'))\n      ) {\n        // Assuming this is probably for api\n        return null;\n      }\n      const serverBundlerConfig = new Proxy(\n        {},\n        {\n          get(_target, encodedId: string) {\n            const [fileId, name] = encodedId.split('#') as [string, string];\n            const id = isDev ? filePathToFileURL(fileId) : fileId + '.js';\n            return { id, chunks: [id], name, async: true };\n          },\n        },\n      );\n      setExtractFormState(ctx, (actionResult) =>\n        decodeFormState(actionResult, formData, serverBundlerConfig),\n      );\n      return decodeAction(formData, serverBundlerConfig);\n    }\n  }\n  return null;\n}\n"],"names":["filePathToFileURL","streamToArrayBuffer","bufferToString","parseFormData","resolveClientEntryForPrd","id","config","basePath","renderRsc","ctx","elements","onError","moduleIdCallback","modules","unstable_modules","Error","default","renderToReadableStream","rsdwServer","resolveClientEntry","unstable_devServer","clientBundlerConfig","Proxy","get","_target","encodedId","file","name","split","chunks","async","err","forEach","fn","digest","renderRscElement","element","collectClientModules","idSet","Set","add","readable","Promise","resolve","reject","writable","WritableStream","close","abort","reason","pipeTo","catch","Array","from","decodeBody","isDev","decodeReply","serverBundlerConfig","fileId","decodedBody","req","url","searchParams","body","bodyBuf","contentType","headers","startsWith","formData","byteLength","bodyStr","EXTRACT_FORM_STATE_SYMBOL","Symbol","setExtractFormState","extractFormState","getExtractFormState","decodePostAction","decodeAction","decodeFormState","stream1","stream2","tee","keys","every","key","actionResult"],"mappings":"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"}