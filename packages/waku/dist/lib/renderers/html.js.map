{"version":3,"sources":["../../../src/lib/renderers/html.ts"],"sourcesContent":["import { createElement } from 'react';\nimport type { ReactNode, FunctionComponent, ComponentProps } from 'react';\nimport type * as RDServerType from 'react-dom/server.edge';\nimport type { default as RSDWClientType } from 'react-server-dom-webpack/client.edge';\nimport { injectRSCPayload } from 'rsc-html-stream/server';\n\nimport type * as WakuMinimalClientType from '../../minimal/client.js';\nimport type { ConfigDev, ConfigPrd } from '../config.js';\nimport { SRC_MAIN } from '../builder/constants.js';\nimport { concatUint8Arrays } from '../utils/stream.js';\nimport { filePathToFileURL } from '../utils/path.js';\nimport { encodeRscPath } from './utils.js';\nimport { renderRsc, renderRscElement, getExtractFormState } from './rsc.js';\nimport type { HandlerContext, ErrorCallback } from '../middleware/types.js';\n\ntype Elements = Record<string, unknown>;\n\nconst fakeFetchCode = `\nPromise.resolve(new Response(new ReadableStream({\n  start(c) {\n    const d = (self.__FLIGHT_DATA ||= []);\n    const t = new TextEncoder();\n    const f = (s) => c.enqueue(typeof s === 'string' ? t.encode(s) : s);\n    d.forEach(f);\n    d.push = f;\n    if (document.readyState === 'loading') {\n      document.addEventListener('DOMContentLoaded', () => c.close());\n    } else {\n      c.close();\n    }\n  }\n})))\n`\n  .split('\\n')\n  .map((line) => line.trim())\n  .join('');\n\nconst CLOSING_HEAD = '</head>';\nconst CLOSING_BODY = '</body>';\n\nconst injectHtmlHead = (\n  urlForFakeFetch: string,\n  htmlHead: string,\n  mainJsPath: string, // for DEV only, pass `''` for PRD\n) => {\n  const modifyHeadAndBody = (data: string) => {\n    const closingHeadIndex = data.indexOf(CLOSING_HEAD);\n    let [head, body] =\n      closingHeadIndex === -1\n        ? ['<head>' + CLOSING_HEAD, data]\n        : [\n            data.slice(0, closingHeadIndex + CLOSING_HEAD.length),\n            data.slice(closingHeadIndex + CLOSING_HEAD.length),\n          ];\n    head = head.slice(0, -CLOSING_HEAD.length) + htmlHead + CLOSING_HEAD;\n    const matchPrefetched = head.match(\n      // HACK This is very brittle\n      /(.*<script[^>]*>\\nglobalThis\\.__WAKU_PREFETCHED__ = {\\n)(.*?)(\\n};.*)/s,\n    );\n    if (matchPrefetched) {\n      // HACK This is very brittle\n      // TODO(daishi) find a better way\n      const removed = matchPrefetched[2]!.replace(\n        new RegExp(`  '${urlForFakeFetch}': .*?,`),\n        '',\n      );\n      head =\n        matchPrefetched[1] +\n        `  '${urlForFakeFetch}': ${fakeFetchCode},` +\n        removed +\n        matchPrefetched[3];\n    }\n    let code = `\nglobalThis.__WAKU_HYDRATE__ = true;\n`;\n    if (!matchPrefetched) {\n      code += `\nglobalThis.__WAKU_PREFETCHED__ = {\n  '${urlForFakeFetch}': ${fakeFetchCode},\n};\n`;\n    }\n    if (code) {\n      head =\n        head.slice(0, -CLOSING_HEAD.length) +\n        `<script type=\"module\" async>${code}</script>` +\n        CLOSING_HEAD;\n    }\n    if (mainJsPath) {\n      const closingBodyIndex = body.indexOf(CLOSING_BODY);\n      const [firstPart, secondPart] =\n        closingBodyIndex === -1\n          ? [body, '']\n          : [body.slice(0, closingBodyIndex), body.slice(closingBodyIndex)];\n      body =\n        firstPart +\n        `<script src=\"${mainJsPath}\" async type=\"module\"></script>` +\n        secondPart;\n    }\n    return head + body;\n  };\n  const encoder = new TextEncoder();\n  const decoder = new TextDecoder();\n  let headSent = false;\n  let data = '';\n  return new TransformStream({\n    transform(chunk, controller) {\n      if (!(chunk instanceof Uint8Array)) {\n        throw new Error('Unknown chunk type');\n      }\n      data += decoder.decode(chunk);\n      if (!headSent) {\n        if (!/<body[^>]*>/.test(data)) {\n          return;\n        }\n        headSent = true;\n        data = modifyHeadAndBody(data);\n      }\n      controller.enqueue(encoder.encode(data));\n      data = '';\n    },\n    flush(controller) {\n      if (!headSent) {\n        headSent = true;\n        data = modifyHeadAndBody(data);\n        controller.enqueue(encoder.encode(data));\n        data = '';\n      }\n    },\n  });\n};\n\n// HACK for now, do we want to use HTML parser?\nconst rectifyHtml = () => {\n  const pending: Uint8Array[] = [];\n  const decoder = new TextDecoder();\n  let timer: ReturnType<typeof setTimeout> | undefined;\n  return new TransformStream({\n    transform(chunk, controller) {\n      if (!(chunk instanceof Uint8Array)) {\n        throw new Error('Unknown chunk type');\n      }\n      pending.push(chunk);\n      if (/<\\/\\w+>$/.test(decoder.decode(chunk))) {\n        clearTimeout(timer);\n        timer = setTimeout(() => {\n          controller.enqueue(concatUint8Arrays(pending.splice(0)));\n        });\n      }\n    },\n    flush(controller) {\n      clearTimeout(timer);\n      if (pending.length) {\n        controller.enqueue(concatUint8Arrays(pending.splice(0)));\n      }\n    },\n  });\n};\n\n// FIXME Why does it error on the first time?\nlet hackToIgnoreTheVeryFirstError = true;\n\nexport async function renderHtml(\n  config: ConfigDev | ConfigPrd,\n  ctx: Pick<HandlerContext, 'unstable_modules' | 'unstable_devServer'>,\n  htmlHead: string,\n  elements: Elements,\n  onError: Set<ErrorCallback>,\n  html: ReactNode,\n  rscPath: string,\n  actionResult?: unknown,\n): Promise<ReadableStream & { allReady: Promise<void> }> {\n  const modules = ctx.unstable_modules;\n  if (!modules) {\n    throw new Error('handler middleware required (missing modules)');\n  }\n  const {\n    default: { renderToReadableStream },\n  } = modules.rdServer as { default: typeof RDServerType };\n  const {\n    default: { createFromReadableStream },\n  } = modules.rsdwClient as { default: typeof RSDWClientType };\n  const { INTERNAL_ServerRoot } =\n    modules.wakuMinimalClient as typeof WakuMinimalClientType;\n\n  const stream = await renderRsc(config, ctx, elements, onError);\n  const htmlStream = renderRscElement(config, ctx, html, onError);\n  const isDev = !!ctx.unstable_devServer;\n  const moduleMap = new Proxy(\n    {} as Record<string, Record<string, ImportManifestEntry>>,\n    {\n      get(_target, filePath: string) {\n        return new Proxy(\n          {},\n          {\n            get(_target, name: string) {\n              if (isDev) {\n                let id = filePath.slice(config.basePath.length);\n                if (id.startsWith('@id/')) {\n                  id = id.slice('@id/'.length);\n                } else if (id.startsWith('@fs/')) {\n                  id = filePathToFileURL(id.slice('@fs'.length));\n                } else {\n                  id = filePathToFileURL(id);\n                }\n                (globalThis as any).__WAKU_CLIENT_CHUNK_LOAD__(id);\n                return { id, chunks: [id], name };\n              }\n              // !isDev\n              const id = filePath.slice(config.basePath.length);\n              (globalThis as any).__WAKU_CLIENT_CHUNK_LOAD__(id);\n              return { id, chunks: [id], name };\n            },\n          },\n        );\n      },\n    },\n  );\n  const [stream1, stream2] = stream.tee();\n  const elementsPromise: Promise<Elements> = createFromReadableStream(stream1, {\n    serverConsumerManifest: { moduleMap, moduleLoading: null },\n  });\n  const htmlNode: Promise<ReactNode> = createFromReadableStream(htmlStream, {\n    serverConsumerManifest: { moduleMap, moduleLoading: null },\n  });\n  try {\n    const readable = await renderToReadableStream(\n      createElement(\n        INTERNAL_ServerRoot as FunctionComponent<\n          Omit<ComponentProps<typeof INTERNAL_ServerRoot>, 'children'>\n        >,\n        { elementsPromise },\n        htmlNode as any,\n      ),\n      {\n        formState:\n          actionResult === undefined\n            ? null\n            : await getExtractFormState(ctx)(actionResult),\n        onError(err) {\n          if (hackToIgnoreTheVeryFirstError) {\n            return;\n          }\n          console.error(err);\n          onError.forEach((fn) => fn(err, ctx as HandlerContext, 'html'));\n          if (typeof (err as any)?.digest === 'string') {\n            return (err as { digest: string }).digest;\n          }\n        },\n      },\n    );\n    const injected: ReadableStream & { allReady?: Promise<void> } = readable\n      .pipeThrough(rectifyHtml())\n      .pipeThrough(\n        injectHtmlHead(\n          config.basePath + config.rscBase + '/' + encodeRscPath(rscPath),\n          htmlHead,\n          isDev\n            ? `${config.basePath}${(config as ConfigDev).srcDir}/${SRC_MAIN}`\n            : '',\n        ),\n      )\n      .pipeThrough(injectRSCPayload(stream2));\n    injected.allReady = readable.allReady;\n    return injected as never;\n  } catch (e) {\n    if (hackToIgnoreTheVeryFirstError) {\n      hackToIgnoreTheVeryFirstError = false;\n      return renderHtml(\n        config,\n        ctx,\n        htmlHead,\n        elements,\n        onError,\n        html,\n        rscPath,\n        actionResult,\n      );\n    }\n    throw e;\n  }\n}\n"],"names":["createElement","injectRSCPayload","SRC_MAIN","concatUint8Arrays","filePathToFileURL","encodeRscPath","renderRsc","renderRscElement","getExtractFormState","fakeFetchCode","split","map","line","trim","join","CLOSING_HEAD","CLOSING_BODY","injectHtmlHead","urlForFakeFetch","htmlHead","mainJsPath","modifyHeadAndBody","data","closingHeadIndex","indexOf","head","body","slice","length","matchPrefetched","match","removed","replace","RegExp","code","closingBodyIndex","firstPart","secondPart","encoder","TextEncoder","decoder","TextDecoder","headSent","TransformStream","transform","chunk","controller","Uint8Array","Error","decode","test","enqueue","encode","flush","rectifyHtml","pending","timer","push","clearTimeout","setTimeout","splice","hackToIgnoreTheVeryFirstError","renderHtml","config","ctx","elements","onError","html","rscPath","actionResult","modules","unstable_modules","default","renderToReadableStream","rdServer","createFromReadableStream","rsdwClient","INTERNAL_ServerRoot","wakuMinimalClient","stream","htmlStream","isDev","unstable_devServer","moduleMap","Proxy","get","_target","filePath","name","id","basePath","startsWith","globalThis","__WAKU_CLIENT_CHUNK_LOAD__","chunks","stream1","stream2","tee","elementsPromise","serverConsumerManifest","moduleLoading","htmlNode","readable","formState","undefined","err","console","error","forEach","fn","digest","injected","pipeThrough","rscBase","srcDir","allReady","e"],"mappings":"AAAA,SAASA,aAAa,QAAQ,QAAQ;AAItC,SAASC,gBAAgB,QAAQ,yBAAyB;AAI1D,SAASC,QAAQ,QAAQ,0BAA0B;AACnD,SAASC,iBAAiB,QAAQ,qBAAqB;AACvD,SAASC,iBAAiB,QAAQ,mBAAmB;AACrD,SAASC,aAAa,QAAQ,aAAa;AAC3C,SAASC,SAAS,EAAEC,gBAAgB,EAAEC,mBAAmB,QAAQ,WAAW;AAK5E,MAAMC,gBAAgB,CAAC;;;;;;;;;;;;;;;AAevB,CAAC,CACEC,KAAK,CAAC,MACNC,GAAG,CAAC,CAACC,OAASA,KAAKC,IAAI,IACvBC,IAAI,CAAC;AAER,MAAMC,eAAe;AACrB,MAAMC,eAAe;AAErB,MAAMC,iBAAiB,CACrBC,iBACAC,UACAC;IAEA,MAAMC,oBAAoB,CAACC;QACzB,MAAMC,mBAAmBD,KAAKE,OAAO,CAACT;QACtC,IAAI,CAACU,MAAMC,KAAK,GACdH,qBAAqB,CAAC,IAClB;YAAC,WAAWR;YAAcO;SAAK,GAC/B;YACEA,KAAKK,KAAK,CAAC,GAAGJ,mBAAmBR,aAAaa,MAAM;YACpDN,KAAKK,KAAK,CAACJ,mBAAmBR,aAAaa,MAAM;SAClD;QACPH,OAAOA,KAAKE,KAAK,CAAC,GAAG,CAACZ,aAAaa,MAAM,IAAIT,WAAWJ;QACxD,MAAMc,kBAAkBJ,KAAKK,KAAK,CAChC,4BAA4B;QAC5B;QAEF,IAAID,iBAAiB;YACnB,4BAA4B;YAC5B,iCAAiC;YACjC,MAAME,UAAUF,eAAe,CAAC,EAAE,CAAEG,OAAO,CACzC,IAAIC,OAAO,CAAC,GAAG,EAAEf,gBAAgB,OAAO,CAAC,GACzC;YAEFO,OACEI,eAAe,CAAC,EAAE,GAClB,CAAC,GAAG,EAAEX,gBAAgB,GAAG,EAAET,cAAc,CAAC,CAAC,GAC3CsB,UACAF,eAAe,CAAC,EAAE;QACtB;QACA,IAAIK,OAAO,CAAC;;AAEhB,CAAC;QACG,IAAI,CAACL,iBAAiB;YACpBK,QAAQ,CAAC;;GAEZ,EAAEhB,gBAAgB,GAAG,EAAET,cAAc;;AAExC,CAAC;QACG;QACA,IAAIyB,MAAM;YACRT,OACEA,KAAKE,KAAK,CAAC,GAAG,CAACZ,aAAaa,MAAM,IAClC,CAAC,4BAA4B,EAAEM,KAAK,SAAS,CAAC,GAC9CnB;QACJ;QACA,IAAIK,YAAY;YACd,MAAMe,mBAAmBT,KAAKF,OAAO,CAACR;YACtC,MAAM,CAACoB,WAAWC,WAAW,GAC3BF,qBAAqB,CAAC,IAClB;gBAACT;gBAAM;aAAG,GACV;gBAACA,KAAKC,KAAK,CAAC,GAAGQ;gBAAmBT,KAAKC,KAAK,CAACQ;aAAkB;YACrET,OACEU,YACA,CAAC,aAAa,EAAEhB,WAAW,+BAA+B,CAAC,GAC3DiB;QACJ;QACA,OAAOZ,OAAOC;IAChB;IACA,MAAMY,UAAU,IAAIC;IACpB,MAAMC,UAAU,IAAIC;IACpB,IAAIC,WAAW;IACf,IAAIpB,OAAO;IACX,OAAO,IAAIqB,gBAAgB;QACzBC,WAAUC,KAAK,EAAEC,UAAU;YACzB,IAAI,CAAED,CAAAA,iBAAiBE,UAAS,GAAI;gBAClC,MAAM,IAAIC,MAAM;YAClB;YACA1B,QAAQkB,QAAQS,MAAM,CAACJ;YACvB,IAAI,CAACH,UAAU;gBACb,IAAI,CAAC,cAAcQ,IAAI,CAAC5B,OAAO;oBAC7B;gBACF;gBACAoB,WAAW;gBACXpB,OAAOD,kBAAkBC;YAC3B;YACAwB,WAAWK,OAAO,CAACb,QAAQc,MAAM,CAAC9B;YAClCA,OAAO;QACT;QACA+B,OAAMP,UAAU;YACd,IAAI,CAACJ,UAAU;gBACbA,WAAW;gBACXpB,OAAOD,kBAAkBC;gBACzBwB,WAAWK,OAAO,CAACb,QAAQc,MAAM,CAAC9B;gBAClCA,OAAO;YACT;QACF;IACF;AACF;AAEA,+CAA+C;AAC/C,MAAMgC,cAAc;IAClB,MAAMC,UAAwB,EAAE;IAChC,MAAMf,UAAU,IAAIC;IACpB,IAAIe;IACJ,OAAO,IAAIb,gBAAgB;QACzBC,WAAUC,KAAK,EAAEC,UAAU;YACzB,IAAI,CAAED,CAAAA,iBAAiBE,UAAS,GAAI;gBAClC,MAAM,IAAIC,MAAM;YAClB;YACAO,QAAQE,IAAI,CAACZ;YACb,IAAI,WAAWK,IAAI,CAACV,QAAQS,MAAM,CAACJ,SAAS;gBAC1Ca,aAAaF;gBACbA,QAAQG,WAAW;oBACjBb,WAAWK,OAAO,CAAChD,kBAAkBoD,QAAQK,MAAM,CAAC;gBACtD;YACF;QACF;QACAP,OAAMP,UAAU;YACdY,aAAaF;YACb,IAAID,QAAQ3B,MAAM,EAAE;gBAClBkB,WAAWK,OAAO,CAAChD,kBAAkBoD,QAAQK,MAAM,CAAC;YACtD;QACF;IACF;AACF;AAEA,6CAA6C;AAC7C,IAAIC,gCAAgC;AAEpC,OAAO,eAAeC,WACpBC,MAA6B,EAC7BC,GAAoE,EACpE7C,QAAgB,EAChB8C,QAAkB,EAClBC,OAA2B,EAC3BC,IAAe,EACfC,OAAe,EACfC,YAAsB;IAEtB,MAAMC,UAAUN,IAAIO,gBAAgB;IACpC,IAAI,CAACD,SAAS;QACZ,MAAM,IAAItB,MAAM;IAClB;IACA,MAAM,EACJwB,SAAS,EAAEC,sBAAsB,EAAE,EACpC,GAAGH,QAAQI,QAAQ;IACpB,MAAM,EACJF,SAAS,EAAEG,wBAAwB,EAAE,EACtC,GAAGL,QAAQM,UAAU;IACtB,MAAM,EAAEC,mBAAmB,EAAE,GAC3BP,QAAQQ,iBAAiB;IAE3B,MAAMC,SAAS,MAAMzE,UAAUyD,QAAQC,KAAKC,UAAUC;IACtD,MAAMc,aAAazE,iBAAiBwD,QAAQC,KAAKG,MAAMD;IACvD,MAAMe,QAAQ,CAAC,CAACjB,IAAIkB,kBAAkB;IACtC,MAAMC,YAAY,IAAIC,MACpB,CAAC,GACD;QACEC,KAAIC,OAAO,EAAEC,QAAgB;YAC3B,OAAO,IAAIH,MACT,CAAC,GACD;gBACEC,KAAIC,OAAO,EAAEE,IAAY;oBACvB,IAAIP,OAAO;wBACT,IAAIQ,KAAKF,SAAS5D,KAAK,CAACoC,OAAO2B,QAAQ,CAAC9D,MAAM;wBAC9C,IAAI6D,GAAGE,UAAU,CAAC,SAAS;4BACzBF,KAAKA,GAAG9D,KAAK,CAAC,OAAOC,MAAM;wBAC7B,OAAO,IAAI6D,GAAGE,UAAU,CAAC,SAAS;4BAChCF,KAAKrF,kBAAkBqF,GAAG9D,KAAK,CAAC,MAAMC,MAAM;wBAC9C,OAAO;4BACL6D,KAAKrF,kBAAkBqF;wBACzB;wBACCG,WAAmBC,0BAA0B,CAACJ;wBAC/C,OAAO;4BAAEA;4BAAIK,QAAQ;gCAACL;6BAAG;4BAAED;wBAAK;oBAClC;oBACA,SAAS;oBACT,MAAMC,KAAKF,SAAS5D,KAAK,CAACoC,OAAO2B,QAAQ,CAAC9D,MAAM;oBAC/CgE,WAAmBC,0BAA0B,CAACJ;oBAC/C,OAAO;wBAAEA;wBAAIK,QAAQ;4BAACL;yBAAG;wBAAED;oBAAK;gBAClC;YACF;QAEJ;IACF;IAEF,MAAM,CAACO,SAASC,QAAQ,GAAGjB,OAAOkB,GAAG;IACrC,MAAMC,kBAAqCvB,yBAAyBoB,SAAS;QAC3EI,wBAAwB;YAAEhB;YAAWiB,eAAe;QAAK;IAC3D;IACA,MAAMC,WAA+B1B,yBAAyBK,YAAY;QACxEmB,wBAAwB;YAAEhB;YAAWiB,eAAe;QAAK;IAC3D;IACA,IAAI;QACF,MAAME,WAAW,MAAM7B,uBACrBzE,cACE6E,qBAGA;YAAEqB;QAAgB,GAClBG,WAEF;YACEE,WACElC,iBAAiBmC,YACb,OACA,MAAMhG,oBAAoBwD,KAAKK;YACrCH,SAAQuC,GAAG;gBACT,IAAI5C,+BAA+B;oBACjC;gBACF;gBACA6C,QAAQC,KAAK,CAACF;gBACdvC,QAAQ0C,OAAO,CAAC,CAACC,KAAOA,GAAGJ,KAAKzC,KAAuB;gBACvD,IAAI,OAAQyC,KAAaK,WAAW,UAAU;oBAC5C,OAAO,AAACL,IAA2BK,MAAM;gBAC3C;YACF;QACF;QAEF,MAAMC,WAA0DT,SAC7DU,WAAW,CAAC1D,eACZ0D,WAAW,CACV/F,eACE8C,OAAO2B,QAAQ,GAAG3B,OAAOkD,OAAO,GAAG,MAAM5G,cAAc+D,UACvDjD,UACA8D,QACI,GAAGlB,OAAO2B,QAAQ,GAAG,AAAC3B,OAAqBmD,MAAM,CAAC,CAAC,EAAEhH,UAAU,GAC/D,KAGP8G,WAAW,CAAC/G,iBAAiB+F;QAChCe,SAASI,QAAQ,GAAGb,SAASa,QAAQ;QACrC,OAAOJ;IACT,EAAE,OAAOK,GAAG;QACV,IAAIvD,+BAA+B;YACjCA,gCAAgC;YAChC,OAAOC,WACLC,QACAC,KACA7C,UACA8C,UACAC,SACAC,MACAC,SACAC;QAEJ;QACA,MAAM+C;IACR;AACF"}